<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üêæ NeonPet Deluxe üêæ</title>
<style>
:root {
    --primary-gradient: linear-gradient(45deg, #ff00ff, #00ffff);
    --secondary-gradient: linear-gradient(45deg, #ff8a00, #e52e71);
    --neon-blue: #00ffff;
    --neon-pink: #ff00ff;
    --neon-yellow: #ffff00;
    --neon-green: #39ff14;
    --background-color: #1a0b2e;
}
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}
body {
    font-family: 'Arial', sans-serif;
    background-color: var(--background-color);
    color: white;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}
.game-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 10px;
    position: relative;
    overflow: hidden;
}
.frame {
    border: 2px solid var(--neon-blue);
    border-radius: 20px;
    padding: 10px;
    margin-bottom: 10px;
    box-shadow: 0 0 10px var(--neon-blue);
}
.info-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    flex-wrap: wrap;
}
.currency, .xp, .weather {
    font-size: 1.2em;
    font-weight: bold;
    color: var(--neon-yellow);
    text-shadow: 0 0 5px var(--neon-yellow);
    margin: 5px 0;
}
.status-bars {
    display: flex;
    justify-content: space-around;
    margin-bottom: 10px;
    flex-wrap: wrap;
}
.status-bar {
    width: 30%;
    min-width: 80px;
    height: 20px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    overflow: hidden;
    position: relative;
    margin-bottom: 5px;
}
.status-fill {
    height: 100%;
    transition: width 0.3s ease;
}
#hunger-fill { background: var(--primary-gradient); }
#fun-fill { background: var(--secondary-gradient); }
#hygiene-fill { background: linear-gradient(45deg, #4facfe, #00f2fe); }

/* Ajustes en el registro de eventos */
.event-bar {
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: flex-start;
    overflow-y: hidden;
    height: 70px;
    padding: 5px;
    margin-bottom: 10px;
    border: 2px solid var(--neon-blue);
    border-radius: 10px;
    box-shadow: 0 0 5px var(--neon-blue);
    background-color: rgba(0, 0, 0, 0.5);
    flex-shrink: 0;
}
.event-icon {
    font-size: 0.9em;
    margin-bottom: 5px;
    color: var(--neon-yellow);
    text-shadow: 0 0 5px var(--neon-yellow);
    opacity: 1;
    transition: opacity 0.5s ease;
}

/* Ajustes en el √°rea de juego */
.pet-frame {
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
    overflow: hidden;
    flex-shrink: 0;
    height: 35vh;
    margin-bottom: 10px;
}
.pet-container {
    position: relative;
    width: 30vh;
    height: 30vh;
    transition: transform 0.5s ease;
}
.pet {
    font-size: 15vh;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    filter: drop-shadow(0 0 5px var(--neon-yellow));
    user-select: none;
    transition: all 0.5s ease;
}
.pet-accessory {
    position: absolute;
    font-size: 10vh;
    z-index: 1;
    user-select: none;
    cursor: move;
    transition: all 0.5s ease;
}
.accessory-crown { top: -5vh; left: 50%; transform: translateX(-50%); }
.accessory-glasses { top: 4vh; left: 50%; transform: translateX(-50%); font-size: 11vh; }
.accessory-hat { top: -5.5vh; left: 50%; transform: translateX(-50%); }

/* Ajustes en los botones de acci√≥n */
.action-buttons {
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: 10px;
    margin-bottom: 10px;
    flex-wrap: wrap;
}
.action-btn {
    font-size: 2em;
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid var(--neon-blue);
    border-radius: 10px;
    padding: 10px;
    color: white;
    text-shadow: 0 0 5px var(--neon-blue);
    transition: transform 0.2s ease;
    margin: 5px;
    flex: 1 1 80px;
    max-width: 100px;
    text-align: center;
}
.action-btn:active {
    transform: scale(0.9);
}

/* Estilos para los modales */
.modal {
    display: none;
    position: fixed;
    z-index: 2;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow-y: auto;
    background-color: rgba(0,0,0,0.8);
}
.modal-content {
    background: var(--background-color);
    margin: 10% auto;
    padding: 20px;
    border: 2px solid var(--neon-blue);
    width: 90%;
    max-height: 80%;
    overflow-y: auto;
    border-radius: 20px;
    box-shadow: 0 0 15px var(--neon-blue);
    position: relative; /* Para posicionar correctamente el bot√≥n de cerrar */
}
.close, .close-chest {
    color: var(--neon-pink);
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 1.5em;
    font-weight: bold;
    cursor: pointer;
}
.close:hover, .close-chest:hover,
.close:focus, .close-chest:focus {
    color: var(--neon-yellow);
    text-decoration: none;
}

/* Estilos espec√≠ficos para el modal del cofre */
.chest-modal {
    display: none; /* Asegura que el modal est√© oculto por defecto */
    position: fixed;
    z-index: 2; /* Asegura que est√© por encima de otros elementos */
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow-y: auto;
    background-color: rgba(0,0,0,0.7);
}
.chest-content {
    background-color: var(--background-color);
    margin: 15% auto;
    padding: 20px;
    border: 2px solid var(--neon-blue);
    width: 80%;
    max-width: 300px;
    border-radius: 10px;
    position: relative; /* Para que el bot√≥n de cerrar est√© dentro del modal */
}
.chest-item {
    display: inline-block;
    font-size: 1.5em;
    margin: 5px;
    cursor: pointer;
}

/* Estilos para los elementos dentro de los modales */
.shop-items, .food-items {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 10px;
    margin-top: 20px;
}
.shop-item, .food-item {
    font-size: 1.2em;
    text-align: center;
    padding: 10px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    cursor: pointer;
    transition: transform 0.2s ease;
}
.shop-item:active, .food-item:active {
    transform: scale(0.95);
}
.mini-game-board {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 10px;
    margin-top: 20px;
}
.mini-game-card {
    aspect-ratio: 1 / 1;
    background-color: var(--neon-blue);
    border-radius: 10px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 1.5em;
    cursor: pointer;
    transition: transform 0.3s ease;
}
.mini-game-card:active {
    transform: scale(0.95);
}
.mini-game-card.matched {
    background-color: var(--neon-green);
}

.chest {
    position: absolute;
    right: 10px;
    bottom: 10px;
    font-size: 2em;
    cursor: pointer;
    z-index: 10;
}
.light-switch {
    position: absolute;
    top: 10px;
    right: 50px; /* Ajustado para evitar superposici√≥n con otros elementos */
    font-size: 1.5em;
    cursor: pointer;
    z-index: 10;
}
.poop {
    position: absolute;
    font-size: 1.5em;
    cursor: pointer;
    z-index: 5;
}
.background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-size: cover;
    background-position: center;
    transition: opacity 1s ease;
}

/* Media Queries para pantallas peque√±as */
@media (max-width: 600px) {
    .currency, .xp, .weather {
        font-size: 1em;
    }
    .action-btn {
        font-size: 1.5em;
        padding: 8px;
        max-width: 80px;
    }
    .pet {
        font-size: 12vh;
    }
    .pet-container {
        width: 25vh;
        height: 25vh;
    }
    .event-icon {
        font-size: 0.8em;
    }
    .action-buttons {
        justify-content: center;
    }
    .action-btn {
        flex: 1 1 70px;
        margin: 5px;
    }
    .close, .close-chest {
        font-size: 1.2em;
    }
}
</style>
        <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
        <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
        <!-- Add Firebase products that you want to use -->
        <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
        </head>
        <body>
        <div class="game-container">
        <div class="frame info-bar">
        <div class="currency" id="currency">üí∞ 2000</div>
        <div class="xp" id="xp">‚≠ê 0</div>
        <div class="weather" id="weather">‚òÄÔ∏è</div>
        </div>
        <div class="frame status-bars">
        <div class="status-bar"><div id="hunger-fill" class="status-fill"></div></div>
        <div class="status-bar"><div id="fun-fill" class="status-fill"></div></div>
        <div class="status-bar"><div id="hygiene-fill" class="status-fill"></div></div>
        </div>
        <div class="event-bar" id="eventBar"></div>
        <div class="frame pet-frame">
        <div class="background" id="background"></div>
        <div class="pet-container">
        <div class="pet" id="pet">üòä</div>
        <div id="crown" class="pet-accessory accessory-crown" draggable="true"></div>
        <div id="glasses" class="pet-accessory accessory-glasses" draggable="true"></div>
        <div id="hat" class="pet-accessory accessory-hat" draggable="true"></div>
        </div>
        <div class="chest" id="chest">üß≥</div>
        <div class="light-switch" id="lightSwitch">üí°</div>
        </div>
        <div class="action-buttons">
        <button class="action-btn" id="feed-btn">üçΩÔ∏è</button>
        <button class="action-btn" id="play-btn">üéÆ</button>
        <button class="action-btn" id="clean-btn">üßº</button>
        <button class="action-btn" id="shop-btn">üõçÔ∏è</button>
        </div>
        </div>
        <div id="shopModal" class="modal">
        <div class="modal-content">
        <span class="close">‚ùå</span>
        <h2>üõçÔ∏è Tienda</h2>
        <div class="shop-items" id="shop-items"></div>
        </div>
        </div>
        
        <div id="foodModal" class="modal">
        <div class="modal-content">
        <span class="close">‚ùå</span>
        <h2>üçΩÔ∏è Comida</h2>
        <div class="food-items" id="food-items"></div>
        </div>
        </div>
        
        <div id="miniGameModal" class="modal">
        <div class="modal-content">
        <span class="close">‚ùå</span>
        <h2>üéÆ Minijuego</h2>
        <div id="mini-game-board" class="mini-game-board"></div>
        </div>
        </div>
        
        <button class="debug-button" id="resetButton"></button>
        
        <div id="chestModal" class="chest-modal">
        <div class="chest-content">
        <span class="close-chest" id="closeChest">‚ùå</span>
        <h2>üß≥ Cofre</h2>
        <div id="chestItems"></div>
        </div>
        </div>
        
        <script>
        // Configuraci√≥n de Firebase
        const firebaseConfig = {
        apiKey: "TU_API_KEY",
        authDomain: "TU_AUTH_DOMAIN",
        projectId: "TU_PROJECT_ID",
        storageBucket: "TU_STORAGE_BUCKET",
        messagingSenderId: "TU_MESSAGING_SENDER_ID",
        appId: "TU_APP_ID",
        measurementId: "TU_MEASUREMENT_ID"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Referencia del documento
        const petDocRef = db.collection('Pet').doc('Mascota');
        
        // Variables globales
        let hunger = 100;
        let fun = 100;
        let hygiene = 100;
        let currency = 2000;
        let xp = 0;
        let level = 1;
        let isSick = false;
        let tapCount = 0;
        let chestItems = [];
        let shampooCount = 0;
        let isLightOn = true;
        let currentBackground = 0;
        let poopInterval;
        let isUpdatingFromFirebase = false;
        let isGameActive = true;
        
        const pet = document.getElementById('pet');
        const petContainer = document.querySelector('.pet-container');
        const crown = document.getElementById('crown');
        const glasses = document.getElementById('glasses');
        const hat = document.getElementById('hat');
        const hungerFill = document.getElementById('hunger-fill');
        const funFill = document.getElementById('fun-fill');
        const hygieneFill = document.getElementById('hygiene-fill');
        const currencyElement = document.getElementById('currency');
        const xpElement = document.getElementById('xp');
        const weatherElement = document.getElementById('weather');
        const eventBar = document.getElementById('eventBar');
        const chest = document.getElementById('chest');
        const lightSwitch = document.getElementById('lightSwitch');
        const background = document.getElementById('background');
        
        const feedBtn = document.getElementById('feed-btn');
        const playBtn = document.getElementById('play-btn');
        const cleanBtn = document.getElementById('clean-btn');
        const shopBtn = document.getElementById('shop-btn');
        
        const shopModal = document.getElementById('shopModal');
        const foodModal = document.getElementById('foodModal');
        const miniGameModal = document.getElementById('miniGameModal');
        const chestModal = document.getElementById('chestModal');
        const chestItemsContainer = document.getElementById('chestItems');
        const closeChest = document.getElementById('closeChest');
        
        const petEmojis = ['üòä', 'üòÑ', 'üòç', 'ü§î', 'üò¥', 'üòã', 'üòé', 'ü§ì', 'ü•≥', 'üòù', 'ü§™', 'üòá', 'ü•∞', 'üòå', 'üòè', 'üò≥', 'üôÑ', 'üò¨', 'üòÖ', 'üòÇ', 'ü§£', 'üò≠', 'üò±', 'ü§Ø', 'ü•µ', 'ü•∂', 'üò®', 'üò∞', 'üò•', 'üòì', 'ü§ó', 'ü§≠', 'ü§´', 'ü§•', 'üò∂', 'üòê', 'üòë', 'üò¨', 'üôÑ', 'üòØ', 'üò¶', 'üòß', 'üòÆ', 'üò≤', 'ü•±', 'üò¥', 'ü§§', 'üò™', 'üòµ'];
        const weatherEmojis = ['‚òÄÔ∏è', 'üåßÔ∏è', '‚ùÑÔ∏è', 'üå§Ô∏è', 'üåà'];
        let currentPetEmojiIndex = 0;
        let currentWeatherIndex = 0;
        
        const shopItems = [
        { emoji: 'üëë', price: 500, type: 'crown', requiredLevel: 5 },
        { emoji: 'üëì', price: 300, type: 'glasses', requiredLevel: 3 },
        { emoji: 'üß¢', price: 200, type: 'hat', requiredLevel: 2 },
        { emoji: 'üé©', price: 1000, type: 'topHat', requiredLevel: 10 },
        { emoji: 'üß¥', price: 50, type: 'shampoo', requiredLevel: 1 },
        { emoji: 'üíä', price: 100, type: 'medicine', requiredLevel: 1 }
        ];
        
        const foodItems = [
        { emoji: 'üçé', hunger: 10, fun: 2, price: 50, requiredLevel: 1 },
        { emoji: 'üçî', hunger: 25, fun: 10, price: 100, requiredLevel: 2 },
        { emoji: 'üçï', hunger: 20, fun: 15, price: 150, requiredLevel: 3 },
        { emoji: 'üç¶', hunger: 5, fun: 20, price: 80, requiredLevel: 1 },
        { emoji: 'ü•ó', hunger: 15, fun: 5, price: 120, requiredLevel: 2 },
        { emoji: 'üç±', hunger: 30, fun: 25, price: 200, requiredLevel: 4 }
        ];
        
        const backgrounds = [
        'linear-gradient(to bottom, #87CEEB, #E0F6FF)', // D√≠a
        'linear-gradient(to bottom, #FF7F50, #FFB6C1)', // Amanecer/Atardecer
        'linear-gradient(to bottom, #191970, #000000)'  // Noche
        ];
        // Funci√≥n para actualizar Firestore
        function updateFirestore() {
        if (isUpdatingFromFirebase) return;
        
        petDocRef.update({
        hunger: hunger,
        fun: fun,
        hygiene: hygiene,
        currency: currency,
        level: level,
        xp: xp,
        isSick: isSick,
        shampooCount: shampooCount,
        currentBackground: currentBackground,
        isLightOn: isLightOn,
        chestItems: chestItems,
        accessories: {
        crown: crown.textContent,
        glasses: glasses.textContent,
        hat: hat.textContent
        }
        }).then(() => {
        console.log("Datos actualizados correctamente en Firebase");
        }).catch((error) => {
        console.error("Error al actualizar los datos en Firebase:", error);
        handleFirebaseError(error);
        });
        }
        
        // Listener optimizado para cambios en Firebase
        let lastState = {};
        petDocRef.onSnapshot((doc) => {
        if (doc.exists) {
        isUpdatingFromFirebase = true;
        const data = doc.data();
        let hasChanged = false;
        
        for (let key in data) {
        if (JSON.stringify(data[key]) !== JSON.stringify(lastState[key])) {
        hasChanged = true;
        break;
        }
        }
        
        if (hasChanged) {
        hunger = data.hunger;
        fun = data.fun;
        hygiene = data.hygiene;
        currency = data.currency;
        level = data.level;
        xp = data.xp;
        isSick = data.isSick;
        shampooCount = data.shampooCount;
        currentBackground = data.currentBackground;
        isLightOn = data.isLightOn;
        chestItems = data.chestItems || [];
        crown.textContent = data.accessories.crown;
        glasses.textContent = data.accessories.glasses;
        hat.textContent = data.accessories.hat;
        
        updateUI();
        lastState = {...data};
        }
        isUpdatingFromFirebase = false;
        }
        }, (error) => {
        console.error("Error al escuchar cambios en Firebase:", error);
        handleFirebaseError(error);
        });
        
        // Funci√≥n para manejar desconexiones y reconexiones
        function handleConnectionStatus() {
        const connectedRef = firebase.database().ref('.info/connected');
        connectedRef.on('value', (snap) => {
        if (snap.val() === true) {
        console.log('Conectado a Firebase');
        loadGame();
        } else {
        console.log('Desconectado de Firebase');
        addEventToBar("üì° Conexi√≥n perdida. Intentando reconectar...");
        }
        });
        }
        
  <!-- Continuaci√≥n del c√≥digo en el archivo index.html -->
  
  <!-- Funci√≥n para manejar errores de Firebase -->
  function handleFirebaseError(error) {
  console.error("Error de Firebase:", error);
  addEventToBar("üö® Error de conexi√≥n. Por favor, recarga la p√°gina.");
  }
  
  // Funciones principales
  function updateStatus() {
  hunger = Math.max(0, Math.min(100, hunger));
  fun = Math.max(0, Math.min(100, fun));
  hygiene = Math.max(0, Math.min(100, hygiene));
  
  hungerFill.style.width = `${hunger}%`;
  funFill.style.width = `${fun}%`;
  hygieneFill.style.width = `${hygiene}%`;
  
  currencyElement.textContent = `üí∞ ${currency}`;
  xpElement.textContent = `‚≠ê ${xp}`;
  
  if (hunger <= 0 || fun <= 0 || hygiene <= 0) {
  pet.textContent = 'üíÄ';
  addEventToBar("¬°Tu mascota necesita atenci√≥n urgente!");
  if (hunger <= 0) hunger = 10;
  if (fun <= 0) fun = 10;
  if (hygiene <= 0) hygiene = 10;
  updateFirestore();
  } else if (isSick) {
  pet.textContent = 'ü§¢';
  } else if (hunger < 30 || fun < 30 || hygiene < 30) {
  pet.textContent = 'üò¢';
  } else {
  pet.textContent = petEmojis[currentPetEmojiIndex];
  }
  
  updatePetAppearance();
  }
  
  function updateUI() {
  updateStatus();
  updateChestItems();
  background.style.background = backgrounds[currentBackground];
  lightSwitch.textContent = isLightOn ? 'üí°' : 'üåô';
  }
 
 function updatePetLevels() {
 console.log("Intentando actualizar niveles de mascota");
 db.collection("pet").doc("status").onSnapshot((doc) => {
 if (doc.exists) {
 const status = doc.data().status; // Nota el cambio aqu√≠
 console.log("Datos de mascota recibidos:", status);
 document.querySelector('#hunger-bar .level-fill').style.height = `${status.hunger}%`;
 document.querySelector('#fun-bar .level-fill').style.height = `${status.fun}%`;
 document.querySelector('#hygiene-bar .level-fill').style.height = `${status.hygiene}%`;
 
 updatePetEmoji(status);
 } else {
 console.log("No se encontr√≥ el documento de estado de la mascota");
 }
 }, (error) => {
 console.error("Error getting pet status:", error);
 });
 }
 
 function updatePetStatus(hunger, fun, hygiene) {
 db.collection("pet").doc("status").update({
 hunger: hunger,
 fun: fun,
 hygiene: hygiene
 }).then(() => {
 console.log("Pet status updated successfully");
 }).catch((error) => {
 console.error("Error updating pet status:", error);
 });
 }
 
 // Llamar a esta funci√≥n cada vez que cambie el estado de la mascota
 // Por ejemplo:
 // updatePetStatus(newHunger, newFun, newHygiene);
  
function decreaseStats() {
    if (!isGameActive) return;
  
    if (!isLightOn) {
        hunger = Math.max(0, hunger - 1);
        fun = Math.max(0, fun - 1);
        hygiene = Math.max(0, hygiene - 1);
    } else {
        hunger = Math.max(0, hunger - 3);
        fun = Math.max(0, fun - 3);
        hygiene = Math.max(0, hygiene - 3);
    }
    if (Math.random() < 0.05 && !isSick) {
        isSick = true;
        addEventToBar("ü§¢ Tu mascota se ha enfermado");
    }
    updateStatus();
    updateFirestorePetLevels(); // A√±adir esta l√≠nea
}

// A√±adir llamadas similares en otras funciones que modifiquen los niveles
  
  function addEventToBar(message) {
  const eventIcon = document.createElement('div');
  eventIcon.classList.add('event-icon');
  eventIcon.textContent = message;
  eventBar.appendChild(eventIcon);
  
  // Eliminar el evento despu√©s de cierto tiempo
  setTimeout(() => {
  eventIcon.remove();
  }, 10000);
  }
  
  function changeWeather() {
  if (!isGameActive) return;
  
  currentWeatherIndex = (currentWeatherIndex + 1) % weatherEmojis.length;
  weatherElement.textContent = weatherEmojis[currentWeatherIndex];
  applyWeatherEffects();
  }
  
  function applyWeatherEffects() {
  switch(weatherEmojis[currentWeatherIndex]) {
  case '‚òÄÔ∏è':
  fun = Math.min(100, fun + 5);
  hygiene = Math.max(0, hygiene - 5);
  addEventToBar("‚òÄÔ∏è D√≠a soleado");
  break;
  case 'üåßÔ∏è':
  hygiene = Math.min(100, hygiene + 10);
  fun = Math.max(0, fun - 5);
  addEventToBar("üåßÔ∏è D√≠a lluvioso");
  break;
  case '‚ùÑÔ∏è':
  hunger = Math.max(0, hunger - 10);
  addEventToBar("‚ùÑÔ∏è D√≠a fr√≠o");
  break;
  case 'üå§Ô∏è':
  currency += 50;
  addEventToBar("üå§Ô∏èüí∞ D√≠a despejado, ¬°ganaste monedas!");
  break;
  case 'üåà':
  fun = Math.min(100, fun + 15);
  currency += 100;
  addEventToBar("üåàüí∞ ¬°Arco√≠ris! Ganaste diversi√≥n y monedas");
  break;
  }
  updateStatus();
  updateFirestore();
  }
  
  function gainXP(amount) {
  xp += amount;
  if (xp >= level * 100) {
  levelUp();
  }
  updateStatus();
  updateFirestore();
  }
 
 function updateFirestorePetLevels() {
 db.collection("Pet").doc("status").update({
 hunger: hunger,
 fun: fun,
 hygiene: hygiene
 }).then(() => {
 console.log("Niveles de mascota actualizados en Firestore");
 }).catch((error) => {
 console.error("Error al actualizar niveles de mascota en Firestore:", error);
 });
 }
  function levelUp() {
  level++;
  xp = 0;
  addEventToBar(`üéâ ¬°Subiste al nivel ${level}!`);
  currency += level * 50;
  updateStatus();
  updateFirestore();
  }
  
  // Eventos de botones
  feedBtn.addEventListener('click', () => {
  foodModal.style.display = 'block';
  updateFoodMenu();
  });
  playBtn.addEventListener('click', () => {
  miniGameModal.style.display = 'block';
  if (Math.random() < 0.5) {
  startMemoryGame();
  } else {
  startCatchEmojiGame();
  }
  });
  
  cleanBtn.addEventListener('click', () => {
  if (shampooCount > 0) {
  hygiene = Math.min(100, hygiene + 20);
  shampooCount--;
  currency += 10;
  addEventToBar("üßº‚ú® Mascota limpia");
  gainXP(5);
  updateStatus();
  updateFirestore();
  } else {
  addEventToBar("‚ùå No tienes shampoo");
  }
  });
  
  shopBtn.addEventListener('click', () => {
  shopModal.style.display = 'block';
  updateShop();
  });
  
  pet.addEventListener('click', () => {
  currentPetEmojiIndex = (currentPetEmojiIndex + 1) % petEmojis.length;
  fun = Math.min(100, fun + 1);
  tapCount++;
  if (tapCount >= 20) {
  fun = Math.min(100, fun + 10);
  currency += 50;
  addEventToBar("üéâüí∞ ¬°Bonus por caricias!");
  gainXP(10);
  tapCount = 0;
  }
  updateStatus();
  updateFirestore();
  });
  
  // Funciones de modales
  function updateShop() {
  const shopItemsContainer = document.getElementById('shop-items');
  shopItemsContainer.innerHTML = '';
  shopItems.forEach(item => {
  const itemElement = document.createElement('div');
  itemElement.classList.add('shop-item');
  itemElement.innerHTML = `${item.emoji}<br>üí∞${item.price}<br>Nivel ${item.requiredLevel}`;
  itemElement.onclick = () => buyItem(item);
  if (level < item.requiredLevel) {
  itemElement.style.opacity = '0.5';
  itemElement.style.cursor = 'not-allowed';
  }
  shopItemsContainer.appendChild(itemElement);
  });
  }
  
  function updateFoodMenu() {
  const foodItemsContainer = document.getElementById('food-items');
  foodItemsContainer.innerHTML = '';
  foodItems.forEach(item => {
  const itemElement = document.createElement('div');
  itemElement.classList.add('food-item');
  itemElement.innerHTML = `${item.emoji}<br>üí∞${item.price}<br>Nivel ${item.requiredLevel}`;
  itemElement.onclick = () => feedPet(item);
  if (level < item.requiredLevel) {
  itemElement.style.opacity = '0.5';
  itemElement.style.cursor = 'not-allowed';
  }
  foodItemsContainer.appendChild(itemElement);
  });
  }
  
  function buyItem(item) {
  if (currency >= item.price && level >= item.requiredLevel) {
  currency -= item.price;
  switch(item.type) {
  case 'crown':
  case 'glasses':
  case 'hat':
  case 'topHat':
  const accessoryElement = document.getElementById(item.type);
  if (accessoryElement.textContent !== '') {
  chestItems.push(accessoryElement.textContent);
  }
  accessoryElement.textContent = item.emoji;
  break;
  case 'shampoo':
  shampooCount++;
  chestItems.push(item.emoji);
  break;
  case 'medicine':
  if (isSick) {
  isSick = false;
  addEventToBar("üíä‚úÖ Tu mascota se ha curado");
  } else {
  addEventToBar("üíä‚ùå Tu mascota no est√° enferma");
  return;
  }
  break;
  }
  updateStatus();
  addEventToBar(`${item.emoji}‚úÖ Compra exitosa`);
  gainXP(10);
  updateFirestore();
  } else if (level < item.requiredLevel) {
  addEventToBar(`‚ùå Necesitas nivel ${item.requiredLevel}`);
  } else {
  addEventToBar("üí∞‚ùå No tienes suficientes monedas");
  }
  shopModal.style.display = 'none';
  }
  
  function feedPet(food) {
  if (currency >= food.price && level >= food.requiredLevel) {
  currency -= food.price;
  hunger = Math.min(100, hunger + food.hunger);
  fun = Math.min(100, fun + Math.floor(food.fun / 2));
  addEventToBar(`${food.emoji}‚úÖ Mascota alimentada`);
  gainXP(5);
  if (hunger > 100) {
  isSick = true;
  addEventToBar("ü§¢ Tu mascota comi√≥ demasiado");
  }
  updateStatus();
  updateFirestore();
  } else if (level < food.requiredLevel) {
  addEventToBar(`‚ùå Necesitas nivel ${food.requiredLevel}`);
  } else {
  addEventToBar("üí∞‚ùå No tienes suficientes monedas");
  }
  foodModal.style.display = 'none';
  }
  // Minijuegos
  function startMemoryGame() {
  const miniGameBoard = document.getElementById('mini-game-board');
  miniGameBoard.innerHTML = '';
  const emojis = ['üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä'];
  const gameEmojis = [...emojis, ...emojis].sort(() => Math.random() - 0.5);
  let flippedCards = [];
  let matchedPairs = 0;
  
  gameEmojis.forEach((emoji, index) => {
  const card = document.createElement('div');
  card.classList.add('mini-game-card');
  card.dataset.emoji = emoji;
  card.onclick = () => flipCard(card);
  miniGameBoard.appendChild(card);
  });
  
  function flipCard(card) {
  if (flippedCards.length < 2 && !flippedCards.includes(card) && !card.classList.contains('matched')) {
  card.textContent = card.dataset.emoji;
  flippedCards.push(card);
  
  if (flippedCards.length === 2) {
  setTimeout(checkMatch, 500);
  }
  }
  }
  
  function checkMatch() {
  const [card1, card2] = flippedCards;
  if (card1.dataset.emoji === card2.dataset.emoji) {
  card1.classList.add('matched');
  card2.classList.add('matched');
  matchedPairs++;
  if (matchedPairs === emojis.length) {
  endMiniGame(true);
  }
  } else {
  setTimeout(() => {
  card1.textContent = '';
  card2.textContent = '';
  }, 500);
  }
  flippedCards = [];
  }
  }
  
  function startCatchEmojiGame() {
  const miniGameBoard = document.getElementById('mini-game-board');
  miniGameBoard.innerHTML = '';
  miniGameBoard.style.display = 'grid';
  miniGameBoard.style.gridTemplateColumns = 'repeat(4, 1fr)';
  miniGameBoard.style.gridTemplateRows = 'repeat(3, 1fr)';
  
  const targetEmoji = 'üéØ';
  let score = 0;
  let timeLeft = 30;
  
  const scoreDisplay = document.createElement('div');
  scoreDisplay.textContent = `Puntuaci√≥n: ${score}`;
  miniGameBoard.appendChild(scoreDisplay);
  
  const timeDisplay = document.createElement('div');
  timeDisplay.textContent = `Tiempo: ${timeLeft}s`;
  miniGameBoard.appendChild(timeDisplay);
  
  for (let i = 0; i < 10; i++) {
  const cell = document.createElement('div');
  cell.classList.add('mini-game-card');
  miniGameBoard.appendChild(cell);
  }
  
  function moveTarget() {
  const cells = miniGameBoard.querySelectorAll('.mini-game-card');
  cells.forEach(cell => {
  cell.textContent = '';
  cell.onclick = null;
  });
  const randomCell = cells[Math.floor(Math.random() * cells.length)];
  randomCell.textContent = targetEmoji;
  randomCell.onclick = () => {
  score++;
  scoreDisplay.textContent = `Puntuaci√≥n: ${score}`;
  moveTarget();
  };
  }
  
  moveTarget();
  
  const timer = setInterval(() => {
  timeLeft--;
  timeDisplay.textContent = `Tiempo: ${timeLeft}s`;
  if (timeLeft <= 0) {
  clearInterval(timer);
  endMiniGame(score >= 15);
  }
  }, 1000);
  }
  
  function endMiniGame(won) {
  if (won) {
  fun = Math.min(100, fun + 30);
  currency += 50;
  gainXP(20);
  addEventToBar("üéÆ‚ú®üí∞ ¬°Ganaste el minijuego!");
  } else {
  fun = Math.min(100, fun + 10);
  gainXP(5);
  addEventToBar("üéÆ Mejor suerte la pr√≥xima vez");
  }
  updateStatus();
  miniGameModal.style.display = 'none';
  updateFirestore();
  }
  
  // Sistema de cofre
  chest.addEventListener('click', () => {
  chestModal.style.display = 'block';
  updateChestItems();
  });
  
  closeChest.addEventListener('click', () => {
  chestModal.style.display = 'none';
  });
  
  function updateChestItems() {
  chestItemsContainer.innerHTML = '';
  chestItems.forEach(item => {
  const itemElement = document.createElement('div');
  itemElement.classList.add('chest-item');
  itemElement.textContent = item;
  itemElement.onclick = () => equipItem(item);
  chestItemsContainer.appendChild(itemElement);
  });
  }
  
  function equipItem(item) {
  const accessoryType = getAccessoryType(item);
  if (accessoryType) {
  document.getElementById(accessoryType).textContent = item;
  chestItems = chestItems.filter(i => i !== item);
  updateChestItems();
  addEventToBar(`${item} equipado!`);
  updateFirestore();
  } else if (item === 'üß¥') {
  shampooCount++;
  chestItems = chestItems.filter(i => i !== item);
  updateChestItems();
  addEventToBar(`üß¥ Shampoo a√±adido`);
  updateFirestore();
  }
  }
  
  function getAccessoryType(emoji) {
  switch(emoji) {
  case 'üëë': return 'crown';
  case 'üëì': return 'glasses';
  case 'üß¢': return 'hat';
  case 'üé©': return 'topHat';
  default: return null;
  }
  }
  // Arrastrar y soltar accesorios
  let draggedItem = null;
  
  document.querySelectorAll('.pet-accessory').forEach(accessory => {
  accessory.addEventListener('dragstart', (e) => {
  draggedItem = e.target;
  e.dataTransfer.setData('text/plain', e.target.id);
  setTimeout(() => {
  e.target.style.opacity = '0.5';
  }, 0);
  });
  
  accessory.addEventListener('dragend', (e) => {
  e.target.style.opacity = '1';
  });
  });
  
  chest.addEventListener('dragover', (e) => e.preventDefault());
  chest.addEventListener('drop', (e) => {
  e.preventDefault();
  if (draggedItem) {
  const accessoryType = draggedItem.id;
  const accessoryEmoji = draggedItem.textContent;
  if (accessoryEmoji) {
  chestItems.push(accessoryEmoji);
  draggedItem.textContent = '';
  addEventToBar("üß≥‚úÖ Accesorio guardado");
  updateChestItems();
  updateFirestore();
  }
  draggedItem = null;
  }
  });
  
  // Cerrar modales
  document.querySelectorAll('.close').forEach(closeBtn => {
  closeBtn.onclick = function() {
  this.closest('.modal').style.display = 'none';
  }
  });
  
  window.onclick = function(event) {
  if (event.target.classList.contains('modal')) {
  event.target.style.display = 'none';
  }
  }
  
  // Funci√≥n para actualizar la apariencia basada en el nivel
  function updatePetAppearance() {
  if (level >= 10) {
  pet.style.filter = 'drop-shadow(0 0 10px gold)';
  } else if (level >= 5) {
  pet.style.filter = 'drop-shadow(0 0 5px silver)';
  } else {
  pet.style.filter = 'none';
  }
  }
  
  // Movimiento aleatorio de la mascota
  function movePet() {
  if (!isGameActive) return;
  
  const maxMove = 10; // M√°ximo movimiento en p√≠xeles
  const newX = (Math.random() - 0.5) * maxMove;
  const newY = (Math.random() - 0.5) * maxMove;
  petContainer.style.transform = `translate(${newX}px, ${newY}px)`;
  }
  
  // Cambio aleatorio de expresi√≥n
  function changeExpression() {
  if (!isGameActive) return;
  
  if (!isSick && hunger > 0 && fun > 0 && hygiene > 0) {
  currentPetEmojiIndex = Math.floor(Math.random() * petEmojis.length);
  pet.textContent = petEmojis[currentPetEmojiIndex];
  }
  }
  
  // Ajuste autom√°tico del tama√±o de la mascota y accesorios
  function resizePet() {
  const containerSize = Math.min(petContainer.offsetWidth, petContainer.offsetHeight);
  pet.style.fontSize = `${containerSize * 0.6}px`;
  crown.style.fontSize = `${containerSize * 0.3}px`;
  glasses.style.fontSize = `${containerSize * 0.35}px`;
  hat.style.fontSize = `${containerSize * 0.3}px`;
  }
  
  window.addEventListener('resize', resizePet);
  
  // Funci√≥n de reset
  function resetGame() {
  hunger = 100;
  fun = 100;
  hygiene = 100;
  currency = 2000;
  level = 1;
  xp = 0;
  isSick = false;
  tapCount = 0;
  chestItems = [];
  shampooCount = 0;
  crown.textContent = '';
  glasses.textContent = '';
  hat.textContent = '';
  localStorage.removeItem('neonPetDeluxeState');
  updateStatus();
  addEventToBar("üîÑ‚úÖ Juego reiniciado");
  updateFirestore();
  }
  
  // Agregar evento al bot√≥n de reset
  document.getElementById('resetButton').addEventListener('click', resetGame);
  
  // Guardado autom√°tico
  function saveGame() {
  const gameState = {
  hunger, fun, hygiene, currency, isSick, level, xp, chestItems, shampooCount,
  accessories: {
  crown: crown.textContent,
  glasses: glasses.textContent,
  hat: hat.textContent
  }
  };
  localStorage.setItem('neonPetDeluxeState', JSON.stringify(gameState));
  updateFirestore();
  }
  
  function loadGame() {
  const savedState = localStorage.getItem('neonPetDeluxeState');
  if (savedState) {
  const gameState = JSON.parse(savedState);
  hunger = gameState.hunger;
  fun = gameState.fun;
  hygiene = gameState.hygiene;
  currency = gameState.currency;
  isSick = gameState.isSick;
  level = gameState.level;
  xp = gameState.xp;
  chestItems = gameState.chestItems || [];
  shampooCount = gameState.shampooCount || 0;
  crown.textContent = gameState.accessories.crown;
  glasses.textContent = gameState.accessories.glasses;
  hat.textContent = gameState.accessories.hat;
  updateStatus();
  updateChestItems();
  updateFirestore();
  }
  }
  // Interruptor de luz
  lightSwitch.addEventListener('click', () => {
  isLightOn = !isLightOn;
  lightSwitch.textContent = isLightOn ? 'üí°' : 'üåô';
  if (!isLightOn) {
  pet.textContent = 'üò¥';
  addEventToBar("üí§ Tu mascota est√° durmiendo");
  } else {
  updateStatus();
  addEventToBar("üåû Tu mascota se despert√≥");
  }
  updateFirestore();
  });
  
  // Funci√≥n para generar cacas
  function generatePoop() {
  if (!isGameActive) return;
  
  const poop = document.createElement('div');
  poop.textContent = 'üí©';
  poop.classList.add('poop');
  poop.style.left = `${Math.random() * 80 + 10}%`;
  poop.style.top = `${Math.random() * 80 + 10}%`;
  poop.onclick = () => {
  poop.remove();
  hygiene = Math.max(0, hygiene - 5);
  updateStatus();
  updateFirestore();
  };
  document.querySelector('.pet-frame').appendChild(poop);
  }
  
  // Cambio de fondo
  let startX;
  document.addEventListener('touchstart', (e) => {
  startX = e.touches[0].clientX;
  });
  
  document.addEventListener('touchend', (e) => {
  const endX = e.changedTouches[0].clientX;
  const diff = startX - endX;
  if (Math.abs(diff) > 50) { // Umbral de 50px para considerar un swipe
  if (diff > 0) {
  // Swipe izquierdo
  currentBackground = (currentBackground + 1) % backgrounds.length;
  } else {
  // Swipe derecho
  currentBackground = (currentBackground - 1 + backgrounds.length) % backgrounds.length;
  }
  background.style.background = backgrounds[currentBackground];
  updateFirestore();
  }
  });
  
  // Control de visibilidad de la p√°gina
  document.addEventListener('visibilitychange', handleVisibilityChange);
  
  function handleVisibilityChange() {
  if (document.hidden) {
  isGameActive = false;
  pauseIntervals();
  } else {
  isGameActive = true;
  resumeIntervals();
  }
  }
  
  // Pausar intervalos
  function pauseIntervals() {
  clearInterval(poopInterval);
  // Pausar otros intervalos aqu√≠ si es necesario
  }
  
  // Reanudar intervalos
  function resumeIntervals() {
  poopInterval = setInterval(generatePoop, 30000);
  // Reanudar otros intervalos aqu√≠ si es necesario
  }
  
  // Optimizaci√≥n del rendimiento
  function optimizePerformance() {
  // Usar requestAnimationFrame para animaciones suaves
  function animate() {
  if (isGameActive) {
  movePet();
  }
  requestAnimationFrame(animate);
  }
  requestAnimationFrame(animate);
  
  // Limitar la frecuencia de actualizaci√≥n de Firebase
  let firebaseUpdateTimeout;
  function throttledFirebaseUpdate() {
  if (!firebaseUpdateTimeout) {
  firebaseUpdateTimeout = setTimeout(() => {
  updateFirestore();
  firebaseUpdateTimeout = null;
  }, 5000); // Actualizar Firebase como m√°ximo cada 5 segundos
  }
  }
  
  // Reemplazar llamadas directas a updateFirestore con la versi√≥n throttled
  window.updateFirestore = throttledFirebaseUpdate;
  }
  
  // Gesti√≥n de memoria
  function manageMemory() {
  // Limpiar poops viejos
  setInterval(() => {
  const poops = document.querySelectorAll('.poop');
  if (poops.length > 5) {
  poops[0].remove();
  }
  }, 60000);

window.addEventListener('message', (event) => {
    if (event.data === 'initializePet') {
        initializePet();
    }
});

function updateParentStatus(status) {
    window.parent.postMessage({
        type: 'updatePetStatus',
        status: status
    }, '*');
}

  // Limpiar eventos antiguos del DOM
  const observer = new MutationObserver((mutations) => {
  mutations.forEach((mutation) => {
  if (mutation.type === 'childList') {
  while (eventBar.childNodes.length > 10) {
  eventBar.removeChild(eventBar.firstChild);
  }
  }
  });
  });
  
  observer.observe(eventBar, { childList: true });
  }
  
  // Inicializaci√≥n
  function init() {
  loadGame();
  updateStatus();
  resizePet();
  setInterval(decreaseStats, 10000);
  setInterval(saveGame, 30000);
  setInterval(changeWeather, 60000);
  setInterval(changeExpression, 5000);
  poopInterval = setInterval(generatePoop, 30000);
  background.style.background = backgrounds[currentBackground];
  handleConnectionStatus();
  optimizePerformance();
  manageMemory();
  }
  
  init();
  </script>
  </body>
  </html>