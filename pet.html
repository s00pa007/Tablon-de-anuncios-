<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>üêæ Neonpet Deluxe üêæ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Estilos CSS -->
    <style>
        :root {
            --primary-gradient: linear-gradient(45deg, #ff00ff, #00ffff);
            --secondary-gradient: linear-gradient(45deg, #ff8a00, #e52e71);
            --neon-blue: #00ffff;
            --neon-pink: #ff00ff;
            --neon-yellow: #ffff00;
            --neon-green: #39ff14;
            --background-color: #1a0b2e;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Arial', sans-serif;
            background-color: var(--background-color);
            color: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
            position: relative;
            overflow: hidden;
        }
        .frame {
            border: 2px solid var(--neon-blue);
            border-radius: 20px;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: 0 0 10px var(--neon-blue);
        }
        .info-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .currency, .xp, .weather, .level {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--neon-yellow);
            text-shadow: 0 0 5px var(--neon-yellow);
            margin: 5px 0;
        }
        .status-bars {
            display: flex;
            justify-content: space-around;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .status-bar {
            width: 30%;
            min-width: 80px;
            text-align: center;
        }
        .bar-container {
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            margin-bottom: 5px;
        }
        .status-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
        #hunger-fill { background: var(--primary-gradient); }
        #fun-fill { background: var(--secondary-gradient); }
        #hygiene-fill { background: linear-gradient(45deg, #4facfe, #00f2fe); }
        .status-emoji {
            font-size: 1.5em;
        }
        .event-bar {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: flex-start;
            overflow-y: hidden;
            height: 70px;
            padding: 5px;
            margin-bottom: 10px;
            border: 2px solid var(--neon-blue);
            border-radius: 10px;
            box-shadow: 0 0 5px var(--neon-blue);
            background-color: rgba(0, 0, 0, 0.5);
            flex-shrink: 0;
        }
        .event-icon {
            font-size: 0.9em;
            margin-bottom: 5px;
            color: var(--neon-yellow);
            text-shadow: 0 0 5px var(--neon-yellow);
            opacity: 1;
            transition: opacity 0.5s ease;
        }
        .pet-frame {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
            height: 35vh;
            margin-bottom: 10px;
        }
        .pet-container {
            position: absolute;
            width: 30vh;
            height: 30vh;
            transition: left 2s ease, top 2s ease;
            z-index: 1;
        }
        .pet {
            font-size: 15vh;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            filter: drop-shadow(0 0 5px var(--neon-yellow));
            user-select: none;
            transition: all 0.5s ease;
        }
        .pet-accessory {
            position: absolute;
            font-size: 10vh;
            z-index: 2;
            user-select: none;
            cursor: move;
            transition: all 0.5s ease;
        }
        .accessory-crown { top: -5vh; left: 50%; transform: translateX(-50%); }
        .accessory-glasses { top: 4vh; left: 50%; transform: translateX(-50%); font-size: 11vh; }
        .accessory-hat { top: -5.5vh; left: 50%; transform: translateX(-50%); }
        .action-buttons {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .action-btn {
            font-size: 2em;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid var(--neon-blue);
            border-radius: 10px;
            padding: 10px;
            color: white;
            text-shadow: 0 0 5px var(--neon-blue);
            transition: transform 0.2s ease;
            margin: 5px;
            flex: 1 1 80px;
            max-width: 100px;
            text-align: center;
        }
        .action-btn:active {
            transform: scale(0.9);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 10;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            background-color: rgba(0,0,0,0.8);
        }
        .modal-content {
            background: var(--background-color);
            margin: 10% auto;
            padding: 20px;
            border: 2px solid var(--neon-blue);
            width: 90%;
            max-height: 80%;
            overflow-y: auto;
            border-radius: 20px;
            box-shadow: 0 0 15px var(--neon-blue);
            position: relative;
            z-index: 11;
        }
        .close, .close-chest {
            color: var(--neon-pink);
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
            z-index: 12;
        }
        .close:hover, .close-chest:hover,
        .close:focus, .close-chest:focus {
            color: var(--neon-yellow);
            text-decoration: none;
        }
        .chest-modal {
            display: none;
            position: fixed;
            z-index: 10;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            background-color: rgba(0,0,0,0.7);
        }
        .chest-content {
            background-color: var(--background-color);
            margin: 15% auto;
            padding: 20px;
            border: 2px solid var(--neon-blue);
            width: 80%;
            max-width: 300px;
            border-radius: 10px;
            position: relative;
            z-index: 11;
        }
        .chest-item {
            display: inline-block;
            font-size: 1.5em;
            margin: 5px;
            cursor: pointer;
        }
        .shop-items, .food-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        .shop-item, .food-item {
            font-size: 1.2em;
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .shop-item:active, .food-item:active {
            transform: scale(0.95);
        }
        .mini-game-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 5px;
            width: 240px;
            height: 240px;
            margin: 20px auto;
        }
        .mini-game-card {
            width: 100%;
            height: 100%;
            background-color: var(--neon-blue);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5em;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        .mini-game-card:active {
            transform: scale(0.95);
        }
        .mini-game-card.matched {
            background-color: var(--neon-green);
        }
        .chest {
            position: absolute;
            right: 10px;
            bottom: 10px;
            font-size: 2em;
            cursor: pointer;
            z-index: 2;
        }
        .light-switch {
            position: absolute;
            top: 10px;
            right: 50px;
            font-size: 1.5em;
            cursor: pointer;
            z-index: 2;
        }
        .poop {
            position: absolute;
            font-size: 2em; /* Aumentar el tama√±o de las cacas */
            cursor: pointer;
            z-index: 1;
        }
        .background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            transition: opacity 1s ease;
            z-index: 0;
        }
        @media (max-width: 600px) {
            .currency, .xp, .weather, .level {
                font-size: 1em;
            }
            .action-btn {
                font-size: 1.5em;
                padding: 8px;
                max-width: 80px;
            }
            .pet {
                font-size: 12vh;
            }
            .pet-container {
                width: 25vh;
                height: 25vh;
            }
            .event-icon {
                font-size: 0.8em;
            }
            .action-buttons {
                justify-content: center;
            }
            .action-btn {
                flex: 1 1 70px;
                margin: 5px;
            }
            .close, .close-chest {
                font-size: 1.2em;
            }
        }
    </style>
    <!-- SDKs de Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <!-- Estructura HTML -->
    <div class="game-container">
        <!-- Barra de informaci√≥n -->
        <div class="frame info-bar">
            <div class="currency" id="currency">üí∞ 2000</div>
            <div class="level" id="level">üèÜ Nivel 1</div>
            <div class="xp" id="xp">‚≠ê 0</div>
            <div class="weather" id="weather">‚òÄÔ∏è</div>
        </div>
        <!-- Barras de estado -->
        <div class="frame status-bars">
            <div class="status-bar">
                <div class="bar-container"><div id="hunger-fill" class="status-fill"></div></div>
                <div class="status-emoji">üçî</div>
            </div>
            <div class="status-bar">
                <div class="bar-container"><div id="fun-fill" class="status-fill"></div></div>
                <div class="status-emoji">üéâ</div>
            </div>
            <div class="status-bar">
                <div class="bar-container"><div id="hygiene-fill" class="status-fill"></div></div>
                <div class="status-emoji">üöø</div>
            </div>
        </div>
        <!-- Barra de eventos -->
        <div class="event-bar" id="eventBar"></div>
        <!-- Marco de la mascota -->
        <div class="frame pet-frame" id="petFrame">
            <div class="background" id="background"></div>
            <div class="pet-container" id="petContainer">
                <div class="pet" id="pet">üòä</div>
                <div id="crown" class="pet-accessory accessory-crown" draggable="true"></div>
                <div id="glasses" class="pet-accessory accessory-glasses" draggable="true"></div>
                <div id="hat" class="pet-accessory accessory-hat" draggable="true"></div>
            </div>
            <div class="chest" id="chest">üß≥</div>
            <div class="light-switch" id="lightSwitch">üí°</div>
        </div>
        <!-- Botones de acci√≥n -->
        <div class="action-buttons">
            <button class="action-btn" id="feed-btn">üçΩÔ∏è</button>
            <button class="action-btn" id="play-btn">üéÆ</button>
            <button class="action-btn" id="clean-btn">üßº</button>
            <button class="action-btn" id="shop-btn">üõçÔ∏è</button>
        </div>
    </div>
    <!-- Modales -->
    <div id="shopModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeShop">‚ùå</span>
            <h2>üõçÔ∏è Tienda</h2>
            <div class="shop-items" id="shop-items"></div>
        </div>
    </div>
    <div id="foodModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeFood">‚ùå</span>
            <h2>üçΩÔ∏è Comida</h2>
            <div class="food-items" id="food-items"></div>
        </div>
    </div>
    <div id="miniGameModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeGame">‚ùå</span>
            <h2>üéÆ Minijuego</h2>
            <div id="mini-game-board" class="mini-game-board"></div>
            <div id="scoreDisplay"></div>
            <div id="timeDisplay"></div>
        </div>
    </div>
    <div id="chestModal" class="chest-modal">
        <div class="chest-content">
            <span class="close-chest" id="closeChest">‚ùå</span>
            <h2>üß≥ Cofre</h2>
            <div id="chestItems"></div>
        </div>
    </div>
    <!-- Bot√≥n de reinicio -->
    <button class="debug-button" id="resetButton"></button>
    <!-- Script JavaScript -->
    <script>
        // Configuraci√≥n de Firebase (reemplaza con tus propias credenciales)
const firebaseConfig = {
    apiKey: "AIzaSyBlIRJVI1buU48SPp0ErpCXhnuBdBEp8rk",
    authDomain: "tablon-de-anuncios-d5dea.firebaseapp.com",
    projectId: "tablon-de-anuncios-d5dea",
    storageBucket: "tablon-de-anuncios-d5dea.appspot.com",
    messagingSenderId: "67910184237",
    appId: "1:67910184237:web:e43d424657a948ae5d77a4",
    measurementId: "G-YL5W1VNM9Z"
};

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const database = firebase.database();

        // Referencia al documento de la mascota
        const petDocRef = db.collection('pet').doc('status');

        // Variables globales
        let hunger = 100;
        let fun = 100;
        let hygiene = 100;
        let currency = 2000;
        let xp = 0;
        let level = 1;
        let isSick = false;
        let isAsleep = false;
        let chestItems = [];
        let shampooCount = 0;
        let isLightOn = true;
        let currentBackground = 0;
        let isUpdatingFromFirebase = false;
        let isGameActive = true;
        let lastUpdateTime = Date.now();
        let tapCount = 0;
        let expressionTimeout;

        // Elementos del DOM
        const pet = document.getElementById('pet');
        const petContainer = document.getElementById('petContainer');
        const petFrame = document.getElementById('petFrame');
        const crown = document.getElementById('crown');
        const glasses = document.getElementById('glasses');
        const hat = document.getElementById('hat');
        const hungerFill = document.getElementById('hunger-fill');
        const funFill = document.getElementById('fun-fill');
        const hygieneFill = document.getElementById('hygiene-fill');
        const currencyElement = document.getElementById('currency');
        const xpElement = document.getElementById('xp');
        const levelElement = document.getElementById('level');
        const weatherElement = document.getElementById('weather');
        const eventBar = document.getElementById('eventBar');
        const chest = document.getElementById('chest');
        const lightSwitch = document.getElementById('lightSwitch');
        const background = document.getElementById('background');

        const feedBtn = document.getElementById('feed-btn');
        const playBtn = document.getElementById('play-btn');
        const cleanBtn = document.getElementById('clean-btn');
        const shopBtn = document.getElementById('shop-btn');

        const shopModal = document.getElementById('shopModal');
        const foodModal = document.getElementById('foodModal');
        const miniGameModal = document.getElementById('miniGameModal');
        const chestModal = document.getElementById('chestModal');
        const chestItemsContainer = document.getElementById('chestItems');
        const closeChest = document.getElementById('closeChest');
        const closeShop = document.getElementById('closeShop');
        const closeFood = document.getElementById('closeFood');
        const closeGame = document.getElementById('closeGame');

        const petEmojis = ['üòä', 'üòÑ', 'üòç', 'ü§î', 'üòã', 'üòé', 'ü§ì', 'ü•≥', 'üòù', 'ü§™', 'üòá', 'ü•∞', 'üòå', 'üòè', 'üò≥', 'üôÑ', 'üò¨', 'üòÖ', 'üòÇ', 'ü§£', 'üò≠', 'üò±', 'ü§Ø', 'ü•µ', 'ü•∂', 'üò®', 'üò∞', 'üò•', 'üòì', 'ü§ó', 'ü§≠', 'ü§´', 'ü§•', 'üò∂', 'üòê', 'üòë', 'üò¨', 'üôÑ', 'üòØ', 'üò¶', 'üòß', 'üòÆ', 'üò≤', 'ü•±', 'ü§§', 'üò™', 'üòµ'];
        const weatherEmojis = ['‚òÄÔ∏è', 'üåßÔ∏è', '‚òÅÔ∏è'];
        let currentPetEmojiIndex = 0;
        let currentWeatherIndex = 0;

        const shopItems = [
            { emoji: 'üëë', price: 500, type: 'crown', requiredLevel: 5 },
            { emoji: 'üëì', price: 300, type: 'glasses', requiredLevel: 3 },
            { emoji: 'üß¢', price: 200, type: 'hat', requiredLevel: 2 },
            { emoji: 'üé©', price: 1000, type: 'hat', requiredLevel: 10 },
            { emoji: 'üß¥', price: 50, type: 'shampoo', requiredLevel: 1 },
            { emoji: 'üíä', price: 100, type: 'medicine', requiredLevel: 1 }
        ];

        const foodItems = [
            { emoji: 'üçé', hunger: 10, price: 50, requiredLevel: 1 },
            { emoji: 'üçî', hunger: 25, price: 100, requiredLevel: 2 },
            { emoji: 'üçï', hunger: 20, price: 150, requiredLevel: 3 },
            { emoji: 'üç¶', hunger: 5, price: 80, requiredLevel: 1 },
            { emoji: 'ü•ó', hunger: 15, price: 120, requiredLevel: 2 },
            { emoji: 'üç±', hunger: 30, price: 200, requiredLevel: 4 }
        ];

        const backgrounds = [
            'linear-gradient(to bottom, #87CEEB, #E0F6FF)', // D√≠a
            'linear-gradient(to bottom, #FF7F50, #FFB6C1)', // Amanecer/Atardecer
            'linear-gradient(to bottom, #191970, #000000)'  // Noche
        ];

        const messages = [
            "¬°Tu mascota est√° feliz!",
            "Tu mascota quiere jugar.",
            "¬°Qu√© d√≠a tan bonito!",
            "Tu mascota tiene hambre.",
            "¬°Cuidado con la lluvia!",
            "Tu mascota te quiere mucho.",
            "¬°Hora de limpiar!",
            "Tu mascota se siente sola.",
            "¬°Divi√©rtete con tu mascota!",
            "Tu mascota est√° so√±ando contigo."
        ];

        // Funciones principales

        function updateStatus() {
            // Asegurarnos de que los valores est√°n dentro de los l√≠mites
            hunger = Math.max(0, Math.min(100, hunger));
            fun = Math.max(0, Math.min(100, fun));
            hygiene = Math.max(0, Math.min(100, hygiene));

            // Actualizar las barras de estado
            hungerFill.style.width = `${hunger}%`;
            funFill.style.width = `${fun}%`;
            hygieneFill.style.width = `${hygiene}%`;

            // Actualizar el texto de monedas, experiencia y nivel
            currencyElement.textContent = `üí∞ ${currency}`;
            xpElement.textContent = `‚≠ê ${xp}`;
            levelElement.textContent = `üèÜ Nivel ${level}`;

            // Manejo de estados extremos y apariencia de la mascota
            if (hunger <= 0 || fun <= 0 || hygiene <= 0) {
                pet.textContent = 'üíÄ';
                addEventToBar("‚ö†Ô∏è Tu mascota est√° en peligro. Necesita atenci√≥n inmediata.");
                isGameActive = false; // Pausar el juego
            } else if (isSick) {
                pet.textContent = 'ü§¢';
            } else if (hunger < 30 || fun < 30 || hygiene < 30) {
                pet.textContent = 'üò¢';
            } else {
                pet.textContent = petEmojis[currentPetEmojiIndex];
            }

            // Actualizar la apariencia de la mascota seg√∫n el nivel
            updatePetAppearance();
        }

        function updateUI() {
            updateStatus();
            updateChestItems();
            background.style.background = backgrounds[currentBackground];
            lightSwitch.textContent = isLightOn ? 'üí°' : 'üåô';
        }

        // Funci√≥n para manejar la disminuci√≥n de las estad√≠sticas con el tiempo
        function decreaseStats() {
            if (!isGameActive || isAsleep) return;

            const currentTime = Date.now();
            const elapsedMinutes = (currentTime - lastUpdateTime) / 60000; // Convertir a minutos
            lastUpdateTime = currentTime;

            const decreaseAmount = isLightOn ? elapsedMinutes * 10 : elapsedMinutes * 5;

            hunger = Math.max(0, hunger - decreaseAmount);
            fun = Math.max(0, fun - decreaseAmount * 2); // La diversi√≥n disminuye m√°s r√°pido
            hygiene = Math.max(0, hygiene - decreaseAmount);

            // Probabilidad de enfermar
            if (Math.random() < 0.05 * elapsedMinutes && !isSick) {
                isSick = true;
                addEventToBar("ü§í Tu mascota se ha enfermado");
            }

            updateStatus();
            updateFirestore();
        }

        // Funci√≥n para a√±adir eventos al event bar con tiempo de expiraci√≥n
        function addEventToBar(message) {
            const eventIcon = document.createElement('div');
            eventIcon.classList.add('event-icon');
            eventIcon.textContent = message;
            eventBar.appendChild(eventIcon);

            // Mantener solo los √∫ltimos 5 mensajes
            if (eventBar.childNodes.length > 5) {
                eventBar.removeChild(eventBar.firstChild);
            }

            // Eliminar el evento despu√©s de cierto tiempo
            setTimeout(() => {
                if (eventBar.contains(eventIcon)) {
                    eventBar.removeChild(eventIcon);
                }
            }, 10000);
        }

        // Funci√≥n para cambiar el clima y aplicar efectos
        function changeWeather() {
            if (!isGameActive) return;

            currentWeatherIndex = Math.floor(Math.random() * weatherEmojis.length);
            weatherElement.textContent = weatherEmojis[currentWeatherIndex];
            applyWeatherEffects();
        }

        // Funci√≥n para aplicar efectos seg√∫n el clima
        function applyWeatherEffects() {
            switch (weatherEmojis[currentWeatherIndex]) {
                case '‚òÄÔ∏è':
                    fun = Math.min(100, fun + 5);
                    addEventToBar("‚òÄÔ∏è D√≠a soleado: +5 diversi√≥n");
                    break;
                case 'üåßÔ∏è':
                    isSick = true;
                    addEventToBar("üåßÔ∏è D√≠a lluvioso: Tu mascota se ha enfermado");
                    break;
                case '‚òÅÔ∏è':
                    fun = Math.max(0, fun - 5);
                    addEventToBar("‚òÅÔ∏è D√≠a nublado: -5 diversi√≥n");
                    break;
            }
            updateStatus();
            updateFirestore();
        }

        // Funci√≥n para mostrar mensajes aleatorios
        function showRandomMessage() {
            const randomMessage = messages[Math.floor(Math.random() * messages.length)];
            addEventToBar(randomMessage);
        }

        // Funci√≥n para ganar experiencia y manejar nivel
        function gainXP(amount) {
            xp += amount;
            while (xp >= level * 100) {
                xp -= level * 100;
                levelUp();
            }
            updateStatus();
            updateFirestore();
        }

        // Funci√≥n para subir de nivel
        function levelUp() {
            level++;
            addEventToBar(`üéâ ¬°Has alcanzado el nivel ${level}!`);
            currency += level * 50;
            updateStatus();
            updateFirestore();
        }

        // Eventos de botones

        feedBtn.addEventListener('click', () => {
            if (isGameActive) {
                foodModal.style.display = 'block';
                updateFoodMenu();
            }
        });

        playBtn.addEventListener('click', () => {
            if (isGameActive) {
                miniGameModal.style.display = 'block';
                if (Math.random() < 0.5) {
                    startMemoryGame();
                } else {
                    startCatchEmojiGame();
                }
            }
        });

        cleanBtn.addEventListener('click', () => {
            if (isGameActive) {
                if (shampooCount > 0) {
                    hygiene = Math.min(100, hygiene + 20);
                    shampooCount--;
                    currency += 10;
                    addEventToBar("üßº Tu mascota est√° limpia y feliz");
                    gainXP(5);

                    // Eliminar todas las cacas
                    document.querySelectorAll('.poop').forEach(poop => poop.remove());

                    updateStatus();
                    updateFirestore();
                } else {
                    addEventToBar("‚ùå No tienes shampoo. Compra m√°s en la tienda.");
                }
            }
        });

        shopBtn.addEventListener('click', () => {
            if (isGameActive) {
                shopModal.style.display = 'block';
                updateShop();
            }
        });

        // Evento al hacer clic en la mascota
        pet.addEventListener('click', () => {
            if (isGameActive) {
                currentPetEmojiIndex = Math.floor(Math.random() * petEmojis.length);
                pet.textContent = petEmojis[currentPetEmojiIndex];
                fun = Math.min(100, fun + 1);
                tapCount++;
                clearTimeout(expressionTimeout);
                expressionTimeout = setTimeout(() => {
                    startChangingExpressions();
                }, 10000); // Mantener expresi√≥n por 10 segundos
                if (tapCount >= 10) {
                    addEventToBar("ü§ó ¬°A tu mascota le encantan las caricias!");
                    gainXP(10);
                    tapCount = 0;
                }
                updateStatus();
                updateFirestore();
            }
        });

        // Funciones de actualizaci√≥n de la tienda y comida
        function updateShop() {
            const shopItemsContainer = document.getElementById('shop-items');
            shopItemsContainer.innerHTML = '';
            shopItems.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.classList.add('shop-item');
                itemElement.innerHTML = `${item.emoji}<br>üí∞${item.price}<br>Nivel ${item.requiredLevel}`;
                itemElement.onclick = () => buyItem(item);
                if (level < item.requiredLevel) {
                    itemElement.style.opacity = '0.5';
                    itemElement.style.cursor = 'not-allowed';
                }
                shopItemsContainer.appendChild(itemElement);
            });
        }

        function updateFoodMenu() {
            const foodItemsContainer = document.getElementById('food-items');
            foodItemsContainer.innerHTML = '';
            foodItems.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.classList.add('food-item');
                itemElement.innerHTML = `${item.emoji}<br>üí∞${item.price}<br>Nivel ${item.requiredLevel}`;
                itemElement.onclick = () => feedPet(item);
                if (level < item.requiredLevel) {
                    itemElement.style.opacity = '0.5';
                    itemElement.style.cursor = 'not-allowed';
                }
                foodItemsContainer.appendChild(itemElement);
            });
        }

        // Funci√≥n para comprar un √≠tem en la tienda
        function buyItem(item) {
            if (currency >= item.price && level >= item.requiredLevel) {
                currency -= item.price;
                switch (item.type) {
                    case 'crown':
                    case 'glasses':
                    case 'hat':
                        const accessoryElement = document.getElementById(item.type);
                        if (accessoryElement.textContent !== '') {
                            chestItems.push(accessoryElement.textContent);
                        }
                        accessoryElement.textContent = item.emoji;
                        addEventToBar(`${item.emoji} equipado`);
                        break;
                    case 'shampoo':
                        shampooCount++;
                        addEventToBar("üß¥ Shampoo a√±adido al inventario");
                        break;
                    case 'medicine':
                        if (isSick) {
                            isSick = false;
                            addEventToBar("üíä Tu mascota se ha recuperado");
                        } else {
                            addEventToBar("üíä Tu mascota no est√° enferma");
                            currency += item.price; // Devolver el dinero
                        }
                        break;
                }
                gainXP(10);
                updateStatus();
                updateFirestore();
            } else if (level < item.requiredLevel) {
                addEventToBar(`‚ùå Necesitas ser nivel ${item.requiredLevel} para comprar esto.`);
            } else {
                addEventToBar("üí∞ No tienes suficientes monedas");
            }
            shopModal.style.display = 'none';
        }

        // Funci√≥n para alimentar a la mascota
        function feedPet(food) {
            if (currency >= food.price && level >= food.requiredLevel) {
                currency -= food.price;
                hunger = Math.min(100, hunger + food.hunger);
                addEventToBar(`${food.emoji} ¬°Delicioso!`);
                gainXP(5);
                if (hunger > 100) {
                    isSick = true;
                    addEventToBar("ü§¢ Tu mascota comi√≥ demasiado y se enferm√≥");
                }
                updateStatus();
                updateFirestore();
            } else if (level < food.requiredLevel) {
                addEventToBar(`‚ùå Necesitas ser nivel ${food.requiredLevel} para comprar esto.`);
            } else {
                addEventToBar("üí∞ No tienes suficientes monedas");
            }
            foodModal.style.display = 'none';
        }

        // Funciones de minijuegos
        function startMemoryGame() {
            const miniGameBoard = document.getElementById('mini-game-board');
            miniGameBoard.innerHTML = '';
            const emojis = ['üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº'];
            const gameEmojis = [...emojis, ...emojis].sort(() => Math.random() - 0.5);
            let flippedCards = [];
            let matchedPairs = 0;

            gameEmojis.forEach((emoji, index) => {
                const card = document.createElement('div');
                card.classList.add('mini-game-card');
                card.dataset.emoji = emoji;
                card.onclick = () => flipCard(card);
                miniGameBoard.appendChild(card);
            });

            function flipCard(card) {
                if (flippedCards.length < 2 && !flippedCards.includes(card) && !card.classList.contains('matched')) {
                    card.textContent = card.dataset.emoji;
                    flippedCards.push(card);

                    if (flippedCards.length === 2) {
                        setTimeout(checkMatch, 500);
                    }
                }
            }

            function checkMatch() {
                const [card1, card2] = flippedCards;
                if (card1.dataset.emoji === card2.dataset.emoji) {
                    card1.classList.add('matched');
                    card2.classList.add('matched');
                    matchedPairs++;
                    if (matchedPairs === emojis.length) {
                        endMiniGame(true);
                    }
                } else {
                    setTimeout(() => {
                        card1.textContent = '';
                        card2.textContent = '';
                    }, 500);
                }
                flippedCards = [];
            }
        }

        function startCatchEmojiGame() {
            const miniGameBoard = document.getElementById('mini-game-board');
            miniGameBoard.innerHTML = '';

            const targetEmoji = 'üéØ';
            let score = 0;
            let timeLeft = 15;

            const scoreDisplay = document.getElementById('scoreDisplay');
            const timeDisplay = document.getElementById('timeDisplay');
            scoreDisplay.textContent = `Puntuaci√≥n: ${score}`;
            timeDisplay.textContent = `Tiempo: ${timeLeft}s`;

            const cells = [];
            for (let i = 0; i < 16; i++) {
                const cell = document.createElement('div');
                cell.classList.add('mini-game-card');
                miniGameBoard.appendChild(cell);
                cells.push(cell);
            }

            function moveTarget() {
                cells.forEach(cell => {
                    cell.textContent = '';
                    cell.onclick = null;
                });
                const randomCell = cells[Math.floor(Math.random() * cells.length)];
                randomCell.textContent = targetEmoji;
                randomCell.onclick = () => {
                    score++;
                    scoreDisplay.textContent = `Puntuaci√≥n: ${score}`;
                    moveTarget();
                };
            }

            moveTarget();

            const timer = setInterval(() => {
                timeLeft--;
                timeDisplay.textContent = `Tiempo: ${timeLeft}s`;
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    endMiniGame(score >= 10);
                }
            }, 1000);
        }

        function endMiniGame(won) {
            if (won) {
                fun = Math.min(100, fun + 30);
                currency += 50;
                gainXP(20);
                addEventToBar("üéÆ ¬°Ganaste el minijuego!");
            } else {
                fun = Math.min(100, fun + 10);
                gainXP(5);
                addEventToBar("üéÆ Mejor suerte la pr√≥xima vez");
            }
            updateStatus();
            miniGameModal.style.display = 'none';
            updateFirestore();
        }

        // Sistema de cofre (inventario)
        chest.addEventListener('click', () => {
            chestModal.style.display = 'block';
            updateChestItems();
        });

        closeChest.addEventListener('click', () => {
            chestModal.style.display = 'none';
        });

        function updateChestItems() {
            chestItemsContainer.innerHTML = '';
            chestItems.forEach((item, index) => {
                const itemElement = document.createElement('div');
                itemElement.classList.add('chest-item');
                itemElement.textContent = item;
                itemElement.onclick = () => equipItem(item, index);
                chestItemsContainer.appendChild(itemElement);
            });
        }

        function equipItem(item, index) {
            const accessoryType = getAccessoryType(item);
            if (accessoryType) {
                const accessoryElement = document.getElementById(accessoryType);
                if (accessoryElement.textContent !== '') {
                    chestItems.push(accessoryElement.textContent);
                }
                accessoryElement.textContent = item;
                chestItems.splice(index, 1);
                addEventToBar(`${item} equipado`);
                updateChestItems();
                updateStatus();
                updateFirestore();
            } else if (item === 'üß¥') {
                shampooCount++;
                chestItems.splice(index, 1);
                addEventToBar(`üß¥ Shampoo a√±adido`);
                updateChestItems();
                updateStatus();
                updateFirestore();
            }
        }

        function getAccessoryType(emoji) {
            switch (emoji) {
                case 'üëë': return 'crown';
                case 'üëì': return 'glasses';
                case 'üß¢': return 'hat';
                case 'üé©': return 'hat';
                default: return null;
            }
        }

        // Arrastrar y soltar accesorios al cofre
        document.querySelectorAll('.pet-accessory').forEach(accessory => {
            accessory.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', accessory.id);
            });
        });

        chest.addEventListener('dragover', (e) => e.preventDefault());
        chest.addEventListener('drop', (e) => {
            e.preventDefault();
            const accessoryId = e.dataTransfer.getData('text/plain');
            const accessoryElement = document.getElementById(accessoryId);
            if (accessoryElement && accessoryElement.textContent !== '') {
                chestItems.push(accessoryElement.textContent);
                addEventToBar("üß≥ Accesorio guardado en el cofre");
                accessoryElement.textContent = '';
                updateChestItems();
                updateStatus();
                updateFirestore();
            }
        });

        // Cerrar modales
        closeShop.onclick = () => shopModal.style.display = 'none';
        closeFood.onclick = () => foodModal.style.display = 'none';
        closeGame.onclick = () => {
            miniGameModal.style.display = 'none';
            isGameActive = true;
        };

        window.onclick = function(event) {
            if (event.target.classList.contains('modal') || event.target.classList.contains('chest-modal')) {
                event.target.style.display = 'none';
            }
        };

        // Actualizar apariencia de la mascota seg√∫n el nivel
        function updatePetAppearance() {
            if (level >= 10) {
                pet.style.filter = 'drop-shadow(0 0 10px gold)';
            } else if (level >= 5) {
                pet.style.filter = 'drop-shadow(0 0 5px silver)';
            } else {
                pet.style.filter = 'none';
            }
        }

        // Movimiento del emoji de la mascota
        function movePet() {
            if (!isGameActive || isAsleep) return;

            const maxX = petFrame.offsetWidth - petContainer.offsetWidth;
            const maxY = petFrame.offsetHeight - petContainer.offsetHeight;
            const newX = Math.random() * maxX;
            const newY = Math.random() * maxY;
            petContainer.style.left = `${newX}px`;
            petContainer.style.top = `${newY}px`;
        }

        // Cambio de expresi√≥n aleatorio
        function changeExpression() {
            if (!isGameActive || isAsleep) return;

            if (!isSick && hunger > 0 && fun > 0 && hygiene > 0) {
                currentPetEmojiIndex = Math.floor(Math.random() * petEmojis.length);
                pet.textContent = petEmojis[currentPetEmojiIndex];
            }
        }

        function startChangingExpressions() {
            clearInterval(expressionInterval);
            expressionInterval = setInterval(() => {
                changeExpression();
            }, Math.random() * 3000 + 3000); // Cambiar expresi√≥n cada 3-6 segundos
        }

        let expressionInterval = setInterval(() => {
            changeExpression();
        }, Math.random() * 3000 + 3000);

        // Ajuste del tama√±o de la mascota y accesorios
        function resizePet() {
            const containerSize = Math.min(petContainer.offsetWidth, petContainer.offsetHeight);
            pet.style.fontSize = `${containerSize * 0.6}px`;
            crown.style.fontSize = `${containerSize * 0.3}px`;
            glasses.style.fontSize = `${containerSize * 0.35}px`;
            hat.style.fontSize = `${containerSize * 0.3}px`;
        }

        window.addEventListener('resize', resizePet);

        // Funci√≥n para reiniciar el juego
        function resetGame() {
            hunger = 100;
            fun = 100;
            hygiene = 100;
            currency = 2000;
            level = 1;
            xp = 0;
            isSick = false;
            isAsleep = false;
            chestItems = [];
            shampooCount = 0;
            crown.textContent = '';
            glasses.textContent = '';
            hat.textContent = '';
            isGameActive = true;
            tapCount = 0;
            addEventToBar("üîÑ Juego reiniciado");
            updateStatus();
            updateFirestore();
        }

        // Evento del bot√≥n de reinicio
        document.getElementById('resetButton').addEventListener('click', resetGame);

        // Guardado autom√°tico
        function saveGame() {
            updateFirestore();
        }

        // Cargar el juego desde Firebase
        function loadGame() {
            petDocRef.get().then((doc) => {
                if (doc.exists) {
                    isUpdatingFromFirebase = true;
                    const data = doc.data();
                    hunger = data.hunger;
                    fun = data.fun;
                    hygiene = data.hygiene;
                    currency = data.currency;
                    level = data.level;
                    xp = data.xp;
                    isSick = data.isSick;
                    shampooCount = data.shampooCount;
                    currentBackground = data.currentBackground;
                    isLightOn = data.isLightOn;
                    chestItems = data.chestItems || [];
                    crown.textContent = data.accessories.crown;
                    glasses.textContent = data.accessories.glasses;
                    hat.textContent = data.accessories.hat;
                    isGameActive = !data.isDead;
                    tapCount = data.tapCount || 0;

                    updateUI();
                    isUpdatingFromFirebase = false;
                } else {
                    // Si no existe el documento, inicializar con valores predeterminados
                    updateFirestore();
                }
            }).catch((error) => {
                console.error("Error al cargar los datos:", error);
                handleFirebaseError(error);
            });
        }

        // Interruptor de luz
        lightSwitch.addEventListener('click', () => {
            isLightOn = !isLightOn;
            lightSwitch.textContent = isLightOn ? 'üí°' : 'üåô';
            if (!isLightOn) {
                isAsleep = true;
                pet.textContent = 'üò¥';
                addEventToBar("üí§ Tu mascota se ha ido a dormir");
            } else {
                isAsleep = false;
                updateStatus();
                addEventToBar("üåû Tu mascota se ha despertado");
            }
            updateFirestore();
        });

        // Generar cacas con m√°s frecuencia
        function generatePoop() {
            if (!isGameActive || isAsleep) return;

            const poopCount = document.querySelectorAll('.poop').length;
            if (poopCount >= 5) return; // Limitar a 5 cacas m√°ximo

            // Aumentar la frecuencia de aparici√≥n
            if (Math.random() < 0.8) { // 80% de probabilidad cada intervalo
                const poop = document.createElement('div');
                poop.textContent = 'üí©';
                poop.classList.add('poop');
                poop.style.left = `${Math.random() * 80 + 10}%`;
                poop.style.top = `${Math.random() * 80 + 10}%`;
                poop.onclick = () => {
                    poop.remove();
                    hygiene = Math.max(0, hygiene - 5);
                    addEventToBar("üßπ Limpiaste una caca");
                    updateStatus();
                    updateFirestore();
                };
                document.querySelector('.pet-frame').appendChild(poop);

                // Afectar la salud de la mascota
                hygiene = Math.max(0, hygiene - 2);
                updateStatus();
                updateFirestore();
            }
        }

        // Cambio de fondo al deslizar
        let startX;
        document.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
        });

        document.addEventListener('touchend', (e) => {
            const endX = e.changedTouches[0].clientX;
            const diff = startX - endX;
            if (Math.abs(diff) > 50) { // Umbral de 50px para considerar un swipe
                if (diff > 0) {
                    // Swipe izquierdo
                    currentBackground = (currentBackground + 1) % backgrounds.length;
                } else {
                    // Swipe derecho
                    currentBackground = (currentBackground - 1 + backgrounds.length) % backgrounds.length;
                }
                background.style.background = backgrounds[currentBackground];
                addEventToBar("üñºÔ∏è Cambiaste el fondo");
                updateFirestore();
            }
        });

        // Control de visibilidad de la p√°gina
        document.addEventListener('visibilitychange', handleVisibilityChange);

        function handleVisibilityChange() {
            if (document.hidden) {
                isGameActive = false;
                pauseIntervals();
            } else {
                isGameActive = true;
                lastUpdateTime = Date.now();
                resumeIntervals();
                decreaseStats(); // Actualizar estad√≠sticas inmediatamente
            }
        }

        // Pausar y reanudar intervalos
        let intervals = [];

        function pauseIntervals() {
            intervals.forEach(interval => clearInterval(interval));
            intervals = [];
        }

        function resumeIntervals() {
            intervals.push(setInterval(decreaseStats, 10000)); // Actualizar cada 10 segundos
            intervals.push(setInterval(changeWeather, 7000)); // Cambiar clima cada 6-7 segundos
            intervals.push(setInterval(generatePoop, 20000)); // Generar caca cada 20 segundos (m√°s frecuente)
            intervals.push(setInterval(movePet, 3000)); // Mover mascota cada 3 segundos
            intervals.push(setInterval(showRandomMessage, 15000)); // Mostrar mensaje cada 15 segundos
        }

        // Optimizaci√≥n del rendimiento y gesti√≥n de memoria
        function optimizePerformance() {
            // Usar requestAnimationFrame para animaciones suaves
            function animate() {
                if (isGameActive) {
                    movePet();
                }
                requestAnimationFrame(animate);
            }
            requestAnimationFrame(animate);

            // Limpiar eventos antiguos del DOM
            const observer = new MutationObserver(() => {
                while (eventBar.childNodes.length > 5) {
                    eventBar.removeChild(eventBar.firstChild);
                }
            });

            observer.observe(eventBar, { childList: true });
        }

        // Manejo de errores de Firebase
        function handleFirebaseError(error) {
            console.error("Error de Firebase:", error);
            addEventToBar("üö® Error de conexi√≥n. Reintentando...");
            setTimeout(updateFirestore, 5000);
        }

        // Funci√≥n para actualizar los datos en Firebase
        function updateFirestore() {
            if (isUpdatingFromFirebase) return;

            petDocRef.set({
                hunger: hunger,
                fun: fun,
                hygiene: hygiene,
                currency: currency,
                level: level,
                xp: xp,
                isSick: isSick,
                isAsleep: isAsleep,
                shampooCount: shampooCount,
                currentBackground: currentBackground,
                isLightOn: isLightOn,
                chestItems: chestItems,
                isDead: !isGameActive,
                tapCount: tapCount,
                accessories: {
                    crown: crown.textContent,
                    glasses: glasses.textContent,
                    hat: hat.textContent
                }
            }).then(() => {
                console.log("Datos actualizados correctamente en Firebase");
            }).catch((error) => {
                console.error("Error al actualizar los datos en Firebase:", error);
                handleFirebaseError(error);
            });
        }

        // Inicializaci√≥n del juego
        function init() {
            loadGame();
            updateStatus();
            resizePet();
            lastUpdateTime = Date.now();
            resumeIntervals();
            optimizePerformance();
        }

        // Iniciar el juego
        init();

    </script>
</body>
</html>