<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üêæ Neonpet Deluxe üêæ</title>
    <style>
        :root {
            --primary-gradient: linear-gradient(45deg, #ff00ff, #00ffff);
            --secondary-gradient: linear-gradient(45deg, #ff8a00, #e52e71);
            --neon-blue: #00ffff;
            --neon-pink: #ff00ff;
            --neon-yellow: #ffff00;
            --neon-green: #39ff14;
            --background-color: #1a0b2e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: var(--background-color);
            color: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
            position: relative;
            overflow: hidden;
            min-height: 100vh;
        }

        .frame {
            border: 2px solid var(--neon-blue);
            border-radius: 20px;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: 0 0 10px var(--neon-blue);
        }

        .info-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .currency, .xp, .level, .weather {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--neon-yellow);
            text-shadow: 0 0 5px var(--neon-yellow);
            margin: 5px 0;
        }

        .status-bars {
            display: flex;
            justify-content: space-around;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .status-bar {
            width: 30%;
            min-width: 80px;
            text-align: center;
        }

        .bar-container {
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            margin-bottom: 5px;
        }

        .status-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        #hunger-fill { background: var(--primary-gradient); }
        #fun-fill { background: var(--secondary-gradient); }
        #hygiene-fill { background: linear-gradient(45deg, #4facfe, #00f2fe); }

        .status-emoji {
            font-size: 1.5em;
        }

        .display-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .display-left, .display-right {
            width: 48%;
            border: 2px solid var(--neon-blue);
            border-radius: 10px;
            padding: 5px;
            height: 70px;
            overflow-y: auto;
        }

        .display-right {
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }

        .event-icon {
            font-size: 0.9em;
            margin-bottom: 5px;
            color: var(--neon-yellow);
            text-shadow: 0 0 5px var(--neon-yellow);
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        .pet-frame {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .pet-container {
            position: absolute;
            width: 30vh;
            height: 30vh;
            transition: transform 0.5s ease;
        }

        .pet {
            font-size: 15vh;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            filter: drop-shadow(0 0 5px var(--neon-yellow));
            user-select: none;
            transition: all 0.5s ease;
            cursor: pointer;
            z-index: 10;
        }

        .pet-accessory {
            position: absolute;
            font-size: 10vh;
            z-index: 11;
            cursor: move;
            transition: all 0.5s ease;
        }

        .accessory-crown { top: -5vh; left: 50%; transform: translateX(-50%); }
        .accessory-glasses { top: 4vh; left: 50%; transform: translateX(-50%); font-size: 11vh; }
        .accessory-hat { top: -5.5vh; left: 50%; transform: translateX(-50%); }

        .action-buttons {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
            position: sticky;
            bottom: 0;
            background-color: var(--background-color);
        }

        .action-btn {
            font-size: 2em;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid var(--neon-blue);
            border-radius: 10px;
            padding: 10px;
            color: white;
            text-shadow: 0 0 5px var(--neon-blue);
            transition: transform 0.2s ease;
            margin: 5px;
            flex: 1 1 80px;
            max-width: 100px;
            text-align: center;
            cursor: pointer;
        }

        .action-btn:active {
            transform: scale(0.9);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 20;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            background-color: rgba(0,0,0,0.8);
        }

        .modal-content {
            background: var(--background-color);
            margin: 10% auto;
            padding: 20px;
            border: 2px solid var(--neon-blue);
            width: 90%;
            max-height: 80%;
            overflow-y: auto;
            border-radius: 20px;
            box-shadow: 0 0 15px var(--neon-blue);
            position: relative;
        }

        .close, .close-chest {
            color: var(--neon-pink);
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover, .close-chest:hover,
        .close:focus, .close-chest:focus {
            color: var(--neon-yellow);
            text-decoration: none;
        }

        .chest-modal {
            display: none;
            position: fixed;
            z-index: 20;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            background-color: rgba(0,0,0,0.7);
        }

        .chest-content {
            background-color: var(--background-color);
            margin: 15% auto;
            padding: 20px;
            border: 2px solid var(--neon-blue);
            width: 80%;
            max-width: 300px;
            border-radius: 10px;
            position: relative;
        }

        .chest-item {
            display: inline-block;
            font-size: 1.5em;
            margin: 5px;
            cursor: pointer;
        }

        .shop-items, .food-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        .shop-item, .food-item {
            font-size: 1.2em;
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .shop-item:active, .food-item:active {
            transform: scale(0.95);
        }

        .mini-game-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 5px;
            width: 200px;
            height: 200px;
            margin: 20px auto;
        }

        .mini-game-cell {
            width: 100%;
            height: 100%;
            background-color: var(--neon-blue);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5em;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .mini-game-cell:active {
            transform: scale(0.95);
        }

        .chest, .shop-icon {
            font-size: 2em;
            cursor: pointer;
            margin: 0 15px;
        }

        .light-switch {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5em;
            cursor: pointer;
            z-index: 12;
        }

        .poop {
            position: absolute;
            font-size: 3em;
            cursor: pointer;
            z-index: 9;
        }

        .background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            transition: opacity 1s ease;
        }

        .grid-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            z-index: 1;
        }

        .grid-cell {
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-sizing: border-box;
        }

        @media (max-width: 600px) {
            .currency, .xp, .weather {
                font-size: 1em;
            }
            .action-btn {
                font-size: 1.5em;
                padding: 8px;
                max-width: 80px;
            }
            .pet {
                font-size: 12vh;
            }
            .pet-container {
                width: 25vh;
                height: 25vh;
            }
            .event-icon {
                font-size: 0.8em;
            }
            .action-buttons {
                justify-content: center;
            }
            .action-btn {
                flex: 1 1 70px;
                margin: 5px;
            }
            .close, .close-chest {
                font-size: 1.2em;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="frame info-bar">
            <div class="currency" id="currency">üí∞ 2000</div>
            <div class="xp" id="xp">‚≠ê 0</div>
            <div class="level" id="level">üî∫ Nivel 1</div>
            <div class="weather" id="weather">‚òÄÔ∏è</div>
        </div>
        <div class="frame status-bars">
            <div class="status-bar">
                <div class="bar-container"><div id="hunger-fill" class="status-fill"></div></div>
                <div class="status-emoji">üçî</div>
            </div>
            <div class="status-bar">
                <div class="bar-container"><div id="fun-fill" class="status-fill"></div></div>
                <div class="status-emoji">üéâ</div>
            </div>
            <div class="status-bar">
                <div class="bar-container"><div id="hygiene-fill" class="status-fill"></div></div>
                <div class="status-emoji">üöø</div>
            </div>
        </div>
        <div class="display-container">
            <div class="display-left" id="eventBar"></div>
            <div class="display-right">
                <div class="shop-icon" id="shopIcon">üè™</div>
                <div class="chest" id="chest">üì¶</div>
            </div>
        </div>
        <div class="frame pet-frame">
            <div class="background" id="background"></div>
            <div class="grid-container" id="gridContainer"></div>
            <div class="pet-container">
                <div class="pet" id="pet" draggable="true">üòä</div>
                <div id="crown" class="pet-accessory accessory-crown" draggable="true"></div>
                <div id="glasses" class="pet-accessory accessory-glasses" draggable="true"></div>
                <div id="hat" class="pet-accessory accessory-hat" draggable="true"></div>
            </div>
            <div class="light-switch" id="lightSwitch">üí°</div>
        </div>
        <div class="action-buttons">
            <button class="action-btn" id="feed-btn">üçΩÔ∏è</button>
            <button class="action-btn" id="play-btn">üéÆ</button>
            <button class="action-btn" id="clean-btn">üßº</button>
        </div>
    </div>
    
    <!-- Modales -->
    <div id="shopModal" class="modal">
        <div class="modal-content">
            <span class="close">‚ùå</span>
            <h2>üõçÔ∏è Tienda</h2>
            <div class="shop-items" id="shop-items"></div>
        </div>
    </div>
    
<div id="foodModal" class="modal">
        <div class="modal-content">
            <span class="close">‚ùå</span>
            <h2>üçΩÔ∏è Comida</h2>
            <div class="food-items" id="food-items"></div>
        </div>
    </div>
    
    <div id="miniGameModal" class="modal">
        <div class="modal-content">
            <span class="close">‚ùå</span>
            <h2>üéÆ Minijuego</h2>
            <div id="mini-game-board" class="mini-game-board"></div>
        </div>
    </div>
    
    <div id="chestModal" class="chest-modal">
        <div class="chest-content">
            <span class="close-chest" id="closeChest">‚ùå</span>
            <h2>üì¶ Cofre</h2>
            <div id="chestItems"></div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <!-- Tu script principal -->
    <script>
    // Configuraci√≥n de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBlIRJVI1buU48SPp0ErpCXhnuBdBEp8rk",
      authDomain: "tablon-de-anuncios-d5dea.firebaseapp.com",
      projectId: "tablon-de-anuncios-d5dea",
      storageBucket: "tablon-de-anuncios-d5dea.appspot.com",
      messagingSenderId: "67910184237",
      appId: "1:67910184237:web:e43d424657a948ae5d77a4",
      measurementId: "G-YL5W1VNM9Z"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const database = firebase.database();

    // Referencia del documento
    const petDocRef = db.collection('pet').doc('status');

    // Variables globales
    let hunger = 100;
    let fun = 100;
    let hygiene = 100;
    let currency = 2000;
    let xp = 0;
    let level = 1;
    let isSick = false;
    let caressCount = 0;
    let chestItems = [];
    let shampooCount = 0;
    let isLightOn = true;
    let currentBackground = 0;
    let isGameActive = true;
    let lastExpressionChangeTime = 0;
    let tapCount = 0;
    let expressionTimeout;
    let isExpressionLocked = false;
    let isRandomExpressionMode = true;
    let expressionChangeTimeout;

    // Elementos del DOM
    const pet = document.getElementById('pet');
    const petContainer = document.querySelector('.pet-container');
    const crown = document.getElementById('crown');
    const glasses = document.getElementById('glasses');
    const hat = document.getElementById('hat');
    const hungerFill = document.getElementById('hunger-fill');
    const funFill = document.getElementById('fun-fill');
    const hygieneFill = document.getElementById('hygiene-fill');
    const currencyElement = document.getElementById('currency');
    const xpElement = document.getElementById('xp');
    let levelElement = document.getElementById('level');
    const weatherElement = document.getElementById('weather');
    const eventBar = document.getElementById('eventBar');
    const chest = document.getElementById('chest');
    const lightSwitch = document.getElementById('lightSwitch');
    const background = document.getElementById('background');

    // Botones de acci√≥n
    const feedBtn = document.getElementById('feed-btn');
    const playBtn = document.getElementById('play-btn');
    const cleanBtn = document.getElementById('clean-btn');
    const shopIcon = document.getElementById('shopIcon');

    // Modales
    const shopModal = document.getElementById('shopModal');
    const foodModal = document.getElementById('foodModal');
    const miniGameModal = document.getElementById('miniGameModal');
    const chestModal = document.getElementById('chestModal');
    const chestItemsContainer = document.getElementById('chestItems');
    const closeChest = document.getElementById('closeChest');

    // Emojis
    const petEmojis = ['üòä', 'üòÑ', 'üòç', 'ü§î', 'üò¥', 'üòã', 'üòé', 'ü§ì', 'ü•≥', 'üòù', 'ü§™', 'üòá', 'ü•∞', 'üòå', 'üòè', 'üò≥', 'üôÑ', 'üò¨', 'üòÖ', 'üòÇ', 'ü§£', 'üò≠', 'üò±', 'ü§Ø', 'ü•µ', 'ü•∂', 'üò®', 'üò∞', 'üò•', 'üòì', 'ü§ó', 'ü§≠', 'ü§´', 'ü§•', 'üò∂', 'üòê', 'üòë', 'üò¨', 'üôÑ', 'üòØ', 'üò¶', 'üòß', 'üòÆ', 'üò≤', 'ü•±', 'üò¥', 'ü§§', 'üò™', 'üòµ'];
    const weatherEmojis = ['‚òÄÔ∏è', 'üåßÔ∏è', '‚ùÑÔ∏è', 'üå§Ô∏è', 'üåà'];
    let currentpetEmojiIndex = 0;
    let currentWeatherIndex = 0;

    // Items
    const shopItems = [
      { emoji: 'üëë', price: 500, type: 'crown', requiredLevel: 5 },
      { emoji: 'üëì', price: 300, type: 'glasses', requiredLevel: 3 },
      { emoji: 'üß¢', price: 200, type: 'hat', requiredLevel: 2 },
      { emoji: 'üé©', price: 1000, type: 'topHat', requiredLevel: 10 },
      { emoji: 'üß¥', price: 50, type: 'shampoo', requiredLevel: 1 },
      { emoji: 'üíä', price: 100, type: 'medicine', requiredLevel: 1 },
      { emoji: 'ü•Ω', price: 800, type: 'goggles', requiredLevel: 8 }
    ];

    const foodItems = [
      { emoji: 'üçé', hunger: 10, price: 50, requiredLevel: 1 },
      { emoji: 'üçî', hunger: 25, price: 100, requiredLevel: 2 },
      { emoji: 'üçï', hunger: 20, price: 150, requiredLevel: 3 },
      { emoji: 'üç¶', hunger: 5, price: 80, requiredLevel: 1 },
      { emoji: 'ü•ó', hunger: 15, price: 120, requiredLevel: 2 },
      { emoji: 'üç±', hunger: 30, price: 200, requiredLevel: 4 },
      { emoji: 'üçâ', hunger: 12, price: 70, requiredLevel: 1 },
      { emoji: 'üçó', hunger: 28, price: 180, requiredLevel: 3 },
      { emoji: 'üç£', hunger: 22, price: 160, requiredLevel: 5 },
      { emoji: 'ü•©', hunger: 35, price: 250, requiredLevel: 6 },
      { emoji: 'üç∞', hunger: 18, price: 140, requiredLevel: 4 }
    ];

    const backgrounds = [
      'linear-gradient(to bottom, #87CEEB, #E0F6FF)',
      'linear-gradient(to bottom, #FF7F50, #FFB6C1)',
      'linear-gradient(to bottom, #191970, #000000)',
      'linear-gradient(to bottom, #3CB371, #98FB98)',
      'linear-gradient(to bottom, #8A2BE2, #E6E6FA)'
    ];

    // Frases variadas para la interfaz
    const phrases = {
      feed: [
        "¬°Qu√© rico! üòã",
        "¬°Gracias por la comida! üçΩÔ∏è",
        "¬°Estaba delicioso! ü§§",
        "¬°Justo lo que necesitaba! üç¥",
        "¬°Mmm, mi favorito! üòç",
        "¬°Cakiwaki est√° satisfecho! ü•∞",
        "¬°Energ√≠a renovada! üí™",
        "¬°Cakiwaki dice gracias! üôè",
        "¬°Esto sabe a felicidad! üòä",
        "¬°Comida de campeones! üèÜ"
      ],
      play: [
        "¬°Qu√© divertido! üéâ",
        "¬°Me encanta jugar contigo! ü•≥",
        "¬°Eres el mejor compa√±ero de juegos! üéÆ",
        "¬°Otra vez, otra vez! üîÑ",
        "¬°Esto es genial! ü§©",
        "¬°Cakiwaki est√° muy feliz! üòÑ",
        "¬°Diversi√≥n al m√°ximo! üéà",
        "¬°Cakiwaki quiere m√°s juegos! üïπÔ∏è",
        "¬°Jugando se aprende! üìö",
        "¬°Risas y diversi√≥n sin fin! üòÜ"
      ],
      clean: [
        "¬°Qu√© fresquito! üßº",
        "¬°Gracias por el ba√±o! üöø",
        "¬°Me siento como nuevo! ‚ú®",
        "¬°Adi√≥s, suciedad! üëã",
        "¬°Ahora estoy reluciente! üíé",
        "¬°Cakiwaki est√° limpio y feliz! üßΩ",
        "¬°Qu√© bien huele Cakiwaki! üå∏",
        "¬°Ba√±o refrescante para Cakiwaki! üõÅ",
        "¬°Limpio por fuera, feliz por dentro! üòä",
        "¬°Un Cakiwaki limpio es un Cakiwaki feliz! üåü"
      ],
      caress: [
        "¬°Me encantan tus caricias! üíñ",
        "¬°Qu√© agradable! üòä",
        "¬°M√°s, por favor! ü•∞",
        "¬°Eres el mejor! üåü",
        "¬°Me haces tan feliz! üòÑ",
        "¬°Cakiwaki se siente amado! ‚ù§Ô∏è",
        "¬°Cari√±os para Cakiwaki! ü§ó",
        "¬°Cakiwaki ronronea de felicidad! üò∫",
        "¬°Tus caricias son m√°gicas! ‚ú®",
        "¬°Cakiwaki se derrite de amor! üíì"
      ],
      levelUp: [
        "¬°Sub√≠ de nivel! üéä",
        "¬°Cada vez m√°s fuerte! üí™",
        "¬°Mira lo grande que estoy! üìè",
        "¬°Gracias por cuidarme tan bien! üèÜ",
        "¬°Somos un gran equipo! ü§ù",
        "¬°Cakiwaki evoluciona! üåü",
        "¬°Nuevo nivel desbloqueado! üîì",
        "¬°Cakiwaki se hace m√°s poderoso! üí•",
        "¬°Un paso m√°s hacia la grandeza! üöÄ",
        "¬°Cakiwaki alcanza nuevas alturas! üèîÔ∏è"
      ],
      random: [
        "¬øJugamos a algo? üé≤",
        "Tengo ganas de aventuras üó∫Ô∏è",
        "¬øMe cuentas un chiste? üòÜ",
        "¬øQu√© tal si bailamos? üíÉ",
        "Me pregunto qu√© habr√° en el cofre... ü§î",
        "Cakiwaki tiene una idea loca üí°",
        "¬øY si aprendemos algo nuevo hoy? üìö",
        "Cakiwaki quiere explorar el mundo üåç",
        "¬øPodemos hacer un picnic virtual? üß∫",
        "Cakiwaki sue√±a con ser una estrella üå†",
        "¬øQu√© tal si inventamos un nuevo juego? üéØ",
        "Cakiwaki quiere hacer un desfile de moda üëó",
        "¬øPodemos tener una fiesta de pijamas? üõèÔ∏è",
        "Cakiwaki quiere aprender a cocinar üë®‚Äçüç≥",
        "¬øY si construimos un fuerte de almohadas? üè∞"
      ],
      sick: [
        "Cakiwaki no se siente muy bien ü§í",
        "¬øPuedes cuidar de Cakiwaki? ü§ß",
        "Cakiwaki necesita descansar üò¥",
        "Un poco de medicina ayudar√≠a üíä",
        "Cakiwaki tiene escalofr√≠os ü•∂",
        "Cakiwaki necesita un abrazo reconfortante ü§ó",
        "¬øPodr√≠as traerle una sopita a Cakiwaki? üç≤",
        "Cakiwaki se siente d√©bil üòî",
        "Un d√≠a de reposo har√° bien a Cakiwaki üõå",
        "Cakiwaki necesita mimos extra hoy ü•∫"
      ]
    };

    // Funci√≥n para obtener una frase aleatoria
    function getRandomPhrase(category) {
      return phrases[category][Math.floor(Math.random() * phrases[category].length)];
    }

    // Funciones principales
    function updateStatus() {
      hunger = Math.max(0, Math.min(100, hunger));
      fun = Math.max(0, Math.min(100, fun));
      hygiene = Math.max(0, Math.min(100, hygiene));

      hungerFill.style.width = `${hunger}%`;
      funFill.style.width = `${fun}%`;
      hygieneFill.style.width = `${hygiene}%`;

      currencyElement.textContent = `üí∞ ${currency}`;
      xpElement.textContent = `‚≠ê ${xp}`;

      if (levelElement) {
        levelElement.textContent = `üî∫ Nivel ${level}`;
      } else {
        levelElement = document.createElement('div');
        levelElement.classList.add('level');
        levelElement.id = 'level';
        levelElement.style.fontSize = '1.2em';
        levelElement.style.fontWeight = 'bold';
        levelElement.style.color = 'var(--neon-yellow)';
        levelElement.style.textShadow = '0 0 5px var(--neon-yellow)';

        const infoBar = document.querySelector('.info-bar');
        const weatherElement = document.getElementById('weather');
infoBar.insertBefore(levelElement, weatherElement);
        levelElement.textContent = `üî∫ Nivel ${level}`;
      }

      updatePetExpression();
      updatePetAppearance();
      resizePet();
    }

    function updatePetExpression() {
      const currentTime = Date.now();
      if (currentTime - lastExpressionChangeTime < 10000) {
        return;
      }

      if (!isLightOn) {
        pet.textContent = 'üò¥';
        pet.style.fontSize = '15vh';
      } else if (isSick) {
        pet.textContent = 'ü§í';
        pet.style.fontSize = '15vh';
      } else if (hunger <= 30 || fun <= 30 || hygiene <= 30) {
        pet.textContent = 'üò¢';
        pet.style.fontSize = '12vh';
      } else {
        if (isRandomExpressionMode) {
          changePetFace();
        }
      }

      const size = 12 + (hunger / 100) * 8; // Tama√±o base de 12vh, aumenta hasta 20vh
      pet.style.fontSize = `${size}vh`;

      updatePetAppearance();
    }

    function changePetFace() {
      if (!isGameActive || !isLightOn || isSick) return;

      clearTimeout(expressionChangeTimeout);

      if (isRandomExpressionMode) {
        currentpetEmojiIndex = Math.floor(Math.random() * petEmojis.length);
        pet.textContent = petEmojis[currentpetEmojiIndex];

        const nextChangeTime = Math.floor(Math.random() * 4000) + 3000; // 3 a 7 segundos
        expressionChangeTimeout = setTimeout(changePetFace, nextChangeTime);
      }
    }

    function decreaseStats() {
      if (!isGameActive) return;

      const decreaseAmountHunger = 0.5;
      const decreaseAmountFun = 0.3;
      const decreaseAmountHygiene = 0.4;

      hunger = Math.max(0, hunger - decreaseAmountHunger);
      fun = Math.max(0, fun - decreaseAmountFun);
      hygiene = Math.max(0, hygiene - decreaseAmountHygiene);

      if (hunger <= 0) {
        addEventToBar("üíÄ Cakiwaki ha muerto de hambre", "¬°Oh no! Recuerda alimentar a tu mascota regularmente para mantenerla con vida.");
        petDeath();
      }

      randomSickness();
      updateStatus();
      updateFirestore();
    }

    function addEventToBar(message, additionalInfo = "") {
      const eventIcon = document.createElement('div');
      eventIcon.classList.add('event-icon');
      eventIcon.innerHTML = `${message}<br><small>${additionalInfo}</small>`;
      eventIcon.style.fontSize = '0.8em';
      eventBar.insertBefore(eventIcon, eventBar.firstChild);

      while (eventBar.childNodes.length > 5) {
        eventBar.removeChild(eventBar.lastChild);
      }
    }

    function changeWeather() {
      if (!isGameActive) return;

      currentWeatherIndex = (currentWeatherIndex + 1) % weatherEmojis.length;
      weatherElement.textContent = weatherEmojis[currentWeatherIndex];
      applyWeatherEffects();
    }

    function applyWeatherEffects() {
      switch(weatherEmojis[currentWeatherIndex]) {
        case '‚òÄÔ∏è':
          fun = Math.min(100, fun + 5);
          hygiene = Math.max(0, hygiene - 5);
          addEventToBar("‚òÄÔ∏è D√≠a soleado, ¬°Cakiwaki quiere jugar afuera!", "El sol anima a Cakiwaki, pero ten cuidado con el sudor.");
          break;
        case 'üåßÔ∏è':
          hygiene = Math.min(100, hygiene + 10);
          fun = Math.max(0, fun - 5);
          if (Math.random() < 0.2 && !isSick) {
            isSick = true;
            addEventToBar(getRandomPhrase('sick'), "La lluvia puede enfermar a Cakiwaki. Considera darle medicina.");
            fun = Math.max(0, fun - 20);
          }
          addEventToBar("üåßÔ∏è D√≠a lluvioso, ¬°Cakiwaki se da un ba√±o natural!", "La lluvia limpia a Cakiwaki, pero puede aburrirlo un poco.");
          break;
        case '‚ùÑÔ∏è':
          hunger = Math.min(100, hunger + 10);
          if (Math.random() < 0.3 && !isSick) {
            isSick = true;
            addEventToBar(getRandomPhrase('sick'), "El fr√≠o puede enfermar a Cakiwaki. Mantenlo caliente y dale medicina si es necesario.");
          }
          addEventToBar("‚ùÑÔ∏è D√≠a fr√≠o, Cakiwaki necesita m√°s energ√≠a", "El fr√≠o aumenta el apetito de Cakiwaki. Aseg√∫rate de alimentarlo bien.");
          break;
        case 'üå§Ô∏è':
          currency += 50;
          addEventToBar("üå§Ô∏èüí∞ D√≠a despejado, ¬°Cakiwaki encontr√≥ monedas brillando al sol!", "¬°Qu√© suerte! Usa estas monedas sabiamente para cuidar mejor a Cakiwaki.");
          break;
        case 'üåà':
          fun = Math.min(100, fun + 15);
          currency += 100;
          addEventToBar("üåàüí∞ ¬°Arco√≠ris! Cakiwaki est√° feliz y encontr√≥ un tesoro", "Los arco√≠ris traen alegr√≠a y fortuna. ¬°Aprovecha este momento especial!");
          break;
      }
      updateStatus();
      updateFirestore();
    }

    function gainXP(amount) {
      xp += amount;
      if (xp >= level * 100) {
        levelUp();
      } else {
        addEventToBar(`‚≠ê +${amount} XP`, "¬°Sigue as√≠! Cada punto de experiencia te acerca al siguiente nivel.");
      }
      updateStatus();
      updateFirestore();
    }

    function levelUp() {
      level++;
      xp = 0;
      addEventToBar(getRandomPhrase('levelUp'), "¬°Incre√≠ble progreso! Cada nivel desbloquea nuevas posibilidades para Cakiwaki.");
      currency += level * 50;
      updateStatus();
      updateFirestore();
    }

    feedBtn.addEventListener('click', () => {
      foodModal.style.display = 'block';
      updateFoodMenu();
    });

    playBtn.addEventListener('click', () => {
      miniGameModal.style.display = 'block';
      startRandomMiniGame();
    });

    cleanBtn.addEventListener('click', () => {
      cleanPet();
    });

    shopIcon.addEventListener('click', () => {
      shopModal.style.display = 'block';
      updateShopItems();
    });

    lightSwitch.addEventListener('click', () => {
      isLightOn = !isLightOn;
      lightSwitch.textContent = isLightOn ? 'üí°' : 'üåô';
      addEventToBar(isLightOn ? "üí° Luz encendida" : "üåô Luz apagada", isLightOn ? "Cakiwaki puede jugar y divertirse ahora." : "Cakiwaki descansar√° mejor en la oscuridad.");
      updateStatus();
      updateFirestore();
    });

    chest.addEventListener('click', () => {
      chestModal.style.display = 'block';
      updateChestItems();
    });

    closeChest.addEventListener('click', () => {
      chestModal.style.display = 'none';
    });

    pet.addEventListener('click', () => {
      if (!isLightOn) {
        isLightOn = true;
        lightSwitch.textContent = 'üí°';
        addEventToBar("üåû Cakiwaki se despert√≥", "¬°Qu√© bueno que lo despertaste! Ahora podr√° jugar y divertirse contigo.");
      }

      isRandomExpressionMode = false;
      clearTimeout(expressionChangeTimeout);
      clearTimeout(expressionTimeout);
      currentpetEmojiIndex = (currentpetEmojiIndex + 1) % petEmojis.length;
      pet.textContent = petEmojis[currentpetEmojiIndex];

      if (!isSick) {
        addEventToBar("üòä Cakiwaki est√° feliz por tu atenci√≥n", "Tus caricias hacen que Cakiwaki se sienta querido y especial.");
      } else {
        addEventToBar("ü§í Cakiwaki no se siente bien", "Necesita descansar y tal vez algo de medicina para sentirse mejor.");
      }

      updateStatus();
      updateFirestore();
    });

    function updateShopItems() {
      const shopItemsContainer = document.getElementById('shop-items');
      shopItemsContainer.innerHTML = '';
      shopItems.forEach(item => {
        const itemElement = document.createElement('div');
        itemElement.classList.add('shop-item');
        itemElement.innerHTML = `${item.emoji}<br>üí∞${item.price}<br>Nivel ${item.requiredLevel}`;
        itemElement.onclick = () => buyItem(item);
        if (level < item.requiredLevel || currency < item.price) {
          itemElement.style.opacity = '0.5';
          itemElement.style.cursor = 'not-allowed';
        }
        shopItemsContainer.appendChild(itemElement);
      });
    }

    function updateFoodMenu() {
      const foodItemsContainer = document.getElementById('food-items');
      foodItemsContainer.innerHTML = '';
      foodItems.forEach(item => {
        const itemElement = document.createElement('div');
        itemElement.classList.add('food-item');
        itemElement.innerHTML = `${item.emoji}<br>üí∞${item.price}<br>Nivel ${item.requiredLevel}`;
        itemElement.onclick = () => feedPet(item);
        if (level < item.requiredLevel) {
          itemElement.style.opacity = '0.5';
          itemElement.style.cursor = 'not-allowed';
        }
        foodItemsContainer.appendChild(itemElement);
      });
    }

    function buyItem(item) {
      if (currency >= item.price && level >= item.requiredLevel) {
        currency -= item.price;
        switch(item.type) {
          case 'crown':
            crown.textContent = item.emoji;
            addEventToBar(`üëë ¬°Cakiwaki ahora lleva una corona!`, "La realeza le sienta bien a Cakiwaki.");
            break;
          case 'glasses':
          case 'goggles':
            glasses.textContent = item.emoji;
            addEventToBar(`üëì ¬°Cakiwaki tiene nuevas gafas!`, "Ahora Cakiwaki puede ver el mundo de una nueva manera.");
            break;
          case 'hat':
          case 'topHat':
            hat.textContent = item.emoji;
            addEventToBar(`üé© ¬°Cakiwaki tiene un nuevo sombrero!`, "¬°Qu√© elegante se ve Cakiwaki con su nuevo sombrero!");
            break;
          case 'shampoo':
            shampooCount++;
            addEventToBar(`üß¥ Has comprado shampoo`, "Mantener limpio a Cakiwaki ser√° m√°s f√°cil ahora.");
            break;
          case 'medicine':
            if (isSick) {
              isSick = false;
              addEventToBar("üíä Cakiwaki se ha curado", "¬°Bien hecho! Cakiwaki se siente mucho mejor gracias a ti.");
            } else {
              addEventToBar("üíä Guardaste la medicina para m√°s tarde", "Es bueno estar preparado. Podr√°s usar la medicina cuando Cakiwaki se enferme.");
              chestItems.push(item.emoji);
            }
            break;
          default:
            break;
        }
        addEventToBar(`üõçÔ∏è Compraste: ${item.emoji}`, "¬°Buena compra! Estos art√≠culos har√°n la vida de Cakiwaki m√°s interesante.");
        gainXP(10);
        updateStatus();
        updateFirestore();
        shopModal.style.display = 'none';
      } else if (level < item.requiredLevel) {
        addEventToBar(`‚ùå Necesitas nivel ${item.requiredLevel} para comprar esto.`, "Sigue cuidando a Cakiwaki para subir de nivel y desbloquear nuevos art√≠culos.");
      } else {
        addEventToBar("‚ùå No tienes suficientes monedas.", "Juega minijuegos o completa logros para ganar m√°s monedas.");
      }
    }

    function feedPet(food) {
      if (currency >= food.price && level >= food.requiredLevel) {
        currency -= food.price;
        if (!isGameActive) {
          isGameActive = true;
          hunger = 50;
          fun = 50;
          hygiene = 50;
          level = 1;
          xp = 0;
          addEventToBar("üéâ Cakiwaki ha revivido!", "¬°Incre√≠ble! Has tra√≠do a Cakiwaki de vuelta. Cu√≠dalo bien esta vez.");
        } else {
          hunger = Math.min(100, hunger + food.hunger);
        }
        addEventToBar(getRandomPhrase('feed'), "Alimentar a Cakiwaki regularmente lo mantendr√° feliz y saludable.");
        gainXP(5);
        if (hunger > 100) {
          isSick = true;
          addEventToBar("ü§¢ Cakiwaki comi√≥ demasiado", "¬°Uh oh! Parece que Cakiwaki se excedi√≥. Un poco de descanso lo ayudar√° a sentirse mejor.");
        }
        updateStatus();
        updateFirestore();
        foodModal.style.display = 'none';
      } else if (level < food.requiredLevel) {
        addEventToBar(`‚ùå Necesitas nivel ${food.requiredLevel}`, "Sigue jugando y cuidando a Cakiwaki para desbloquear m√°s opciones de comida.");
      } else {
        addEventToBar("üí∞‚ùå No tienes suficientes monedas", "¬°No te desanimes! Juega minijuegos o completa logros para ganar m√°s monedas.");
      }
    }

    function cleanPet() {
      if (shampooCount > 0) {
        hygiene = Math.min(100, hygiene + 40);
        shampooCount--;
        currency += 10;
        addEventToBar(getRandomPhrase('clean'), "Mantener a Cakiwaki limpio lo hace m√°s feliz y saludable. ¬°Buen trabajo!");
        gainXP(5);

        const poops = document.querySelectorAll('.poop');
        poops.forEach(poop => poop.remove());
        if (poops.length > 3) {
addEventToBar("üßº ¬°Gran limpieza!", "Has eliminado muchas cacas. Cakiwaki se siente mucho mejor ahora.");
        }

        updateStatus();
        updateFirestore();
      } else {
        addEventToBar("‚ùå No tienes shampoo", "Puedes comprar m√°s shampoo en la tienda. ¬°Mantener la higiene es importante!");
      }
    }

    function startRandomMiniGame() {
      const games = [startCatchEmojiGame, startFollowEmojiGame, startMemoryGame];
      const randomGame = games[Math.floor(Math.random() * games.length)];
      randomGame();
    }

    function startCatchEmojiGame() {
      const miniGameBoard = document.getElementById('mini-game-board');
      miniGameBoard.innerHTML = '';
      miniGameBoard.style.gridTemplateColumns = 'repeat(4, 1fr)';
      miniGameBoard.style.gridTemplateRows = 'repeat(4, 1fr)';

      const targetEmoji = 'üéØ';
      let score = 0;
      let timeLeft = 30;

      const scoreDisplay = document.createElement('div');
      scoreDisplay.textContent = `Puntuaci√≥n: ${score}`;
      miniGameBoard.appendChild(scoreDisplay);

      const timeDisplay = document.createElement('div');
      timeDisplay.textContent = `Tiempo: ${timeLeft}s`;
      miniGameBoard.appendChild(timeDisplay);

      for (let i = 0; i < 16; i++) {
        const cell = document.createElement('div');
        cell.classList.add('mini-game-cell');
        miniGameBoard.appendChild(cell);
      }

      function placeTarget() {
        const cells = miniGameBoard.querySelectorAll('.mini-game-cell');
        cells.forEach(cell => {
          cell.textContent = '';
          cell.onclick = null;
        });
        const randomCell = cells[Math.floor(Math.random() * cells.length)];
        randomCell.textContent = targetEmoji;
        randomCell.onclick = () => {
          score++;
          gainXP(2);
          addEventToBar("üéØ ¬°Has alcanzado el objetivo!", "¬°Bien hecho! Sigue as√≠ para conseguir una gran puntuaci√≥n.");
          scoreDisplay.textContent = `Puntuaci√≥n: ${score}`;
          placeTarget();
        };
      }

      placeTarget();

      const timerInterval = setInterval(() => {
        timeLeft--;
        timeDisplay.textContent = `Tiempo: ${timeLeft}s`;
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          endCatchEmojiGame();
        }
      }, 1000);

      function endCatchEmojiGame() {
        addEventToBar(`üèÅ Fin del juego: Puntuaci√≥n = ${score}`, "¬°Gran partida! Jugar minijuegos ayuda a Cakiwaki a divertirse y ganar recompensas.");
        fun = Math.min(100, fun + score * 2);
        currency += score * 10;
        gainXP(score);
        updateStatus();
        miniGameModal.style.display = 'none';
        updateFirestore();
      }
    }

    function startFollowEmojiGame() {
      const miniGameBoard = document.getElementById('mini-game-board');
      miniGameBoard.innerHTML = '';
      miniGameBoard.style.gridTemplateColumns = 'repeat(4, 1fr)';
      miniGameBoard.style.gridTemplateRows = 'repeat(4, 1fr)';

      const targetEmoji = 'üéØ';
      let score = 0;
      let timeLeft = 15;
      let currentTargetCell = null;

      const scoreDisplay = document.createElement('div');
      scoreDisplay.textContent = `Puntuaci√≥n: ${score}`;
      miniGameBoard.appendChild(scoreDisplay);

      const timeDisplay = document.createElement('div');
      timeDisplay.textContent = `Tiempo: ${timeLeft}s`;
      miniGameBoard.appendChild(timeDisplay);

      for (let i = 0; i < 16; i++) {
        const cell = document.createElement('div');
        cell.classList.add('mini-game-cell');
        miniGameBoard.appendChild(cell);
      }

      function placeTarget() {
        const cells = miniGameBoard.querySelectorAll('.mini-game-cell');
        cells.forEach(cell => cell.textContent = '');
        const randomIndex = Math.floor(Math.random() * cells.length);
        currentTargetCell = cells[randomIndex];
        currentTargetCell.textContent = targetEmoji;
        currentTargetCell.onclick = () => {
          score++;
          gainXP(2);
          addEventToBar("üéØ ¬°Has alcanzado el objetivo!", "¬°Excelentes reflejos! Sigue as√≠ para mejorar tu puntuaci√≥n.");
          scoreDisplay.textContent = `Puntuaci√≥n: ${score}`;
          placeTarget();
        };
      }

      placeTarget();

      const timerInterval = setInterval(() => {
        timeLeft--;
        timeDisplay.textContent = `Tiempo: ${timeLeft}s`;
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          endFollowEmojiGame();
        } else {
          placeTarget();
        }
      }, 1000);

      function endFollowEmojiGame() {
        addEventToBar(`üèÅ Fin del juego: Puntuaci√≥n = ${score}`, "¬°Buen juego! Tus reflejos r√°pidos han impresionado a Cakiwaki.");
        fun = Math.min(100, fun + score * 2);
        currency += score * 10;
        gainXP(score);
        updateStatus();
        miniGameModal.style.display = 'none';
        updateFirestore();
      }
    }

    function startMemoryGame() {
      const miniGameBoard = document.getElementById('mini-game-board');
      miniGameBoard.innerHTML = '';
      miniGameBoard.style.gridTemplateColumns = 'repeat(4, 1fr)';
      miniGameBoard.style.gridTemplateRows = 'repeat(4, 1fr)';

      const emojis = ['üçé', 'üçå', 'üçí', 'üçì', 'üçä', 'üçã', 'üçâ', 'üçá'];
      const gameEmojis = [...emojis, ...emojis];
      gameEmojis.sort(() => Math.random() - 0.5);

      let flippedCards = [];
      let matchedPairs = 0;
      let canFlip = true;

      for (let i = 0; i < 16; i++) {
        const cell = document.createElement('div');
        cell.classList.add('mini-game-cell');
        cell.textContent = '‚ùì';
        cell.addEventListener('click', () => {
          if (canFlip && cell.textContent === '‚ùì' && flippedCards.length < 2) {
            cell.textContent = gameEmojis[i];
            flippedCards.push(cell);

            if (flippedCards.length === 2) {
              canFlip = false;
              setTimeout(checkMatch, 1000);
            }
          }
        });
        miniGameBoard.appendChild(cell);
      }

      function checkMatch() {
        const [card1, card2] = flippedCards;
        if (card1.textContent === card2.textContent) {
          matchedPairs++;
          gainXP(5);
          addEventToBar("üéâ ¬°Encontraste un par!", "¬°Buena memoria! Sigue as√≠ para completar el juego.");
          if (matchedPairs === 8) {
            endMemoryGame();
          }
        } else {
          card1.textContent = '‚ùì';
          card2.textContent = '‚ùì';
        }
        flippedCards = [];
        canFlip = true;
      }

      function endMemoryGame() {
        addEventToBar("üèÜ ¬°Has completado el juego de memoria!", "¬°Incre√≠ble trabajo! Tu memoria ha impresionado a Cakiwaki.");
        fun = Math.min(100, fun + 30);
        currency += 100;
        gainXP(50);
        updateStatus();
        miniGameModal.style.display = 'none';
        updateFirestore();
      }
    }

    function updateChestItems() {
      chestItemsContainer.innerHTML = '';
      chestItems.forEach(item => {
        const itemElement = document.createElement('div');
        itemElement.classList.add('chest-item');
        itemElement.textContent = item;
        itemElement.onclick = () => equipItem(item);
        chestItemsContainer.appendChild(itemElement);
      });
    }

    function equipItem(item) {
      const accessoryType = getAccessoryType(item);
      if (accessoryType) {
        document.getElementById(accessoryType).textContent = item;
        chestItems = chestItems.filter(i => i !== item);
        updateChestItems();
        addEventToBar(`${item} equipado!`, "¬°Cakiwaki luce genial con su nuevo accesorio!");
        gainXP(5);
        updateFirestore();
      } else if (item === 'üß¥') {
        shampooCount++;
        chestItems = chestItems.filter(i => i !== item);
        updateChestItems();
        addEventToBar(`üß¥ Shampoo a√±adido`, "Ahora puedes dar un ba√±o refrescante a Cakiwaki.");
        gainXP(2);
        updateFirestore();
      } else if (item === 'üíä') {
        if (isSick) {
          isSick = false;
          addEventToBar("üíä Cakiwaki se ha curado", "¬°Bien hecho! Has ayudado a Cakiwaki a recuperarse.");
        } else {
          addEventToBar("üíä No es necesario usar la medicina ahora", "Guarda la medicina para cuando Cakiwaki realmente la necesite.");
        }
        chestItems = chestItems.filter(i => i !== item);
        updateChestItems();
        gainXP(5);
        updateFirestore();
      }
    }

    function getAccessoryType(emoji) {
      switch(emoji) {
        case 'üëë': return 'crown';
        case 'üëì': case 'ü•Ω': return 'glasses';
        case 'üß¢': case 'üé©': return 'hat';
        default: return null;
      }
    }

    // Arrastrar y soltar accesorios
    let draggedItem = null;

    document.querySelectorAll('.pet-accessory').forEach(accessory => {
      accessory.addEventListener('dragstart', (e) => {
        draggedItem = e.target;
        e.dataTransfer.setData('text/plain', e.target.id);
        setTimeout(() => {
          e.target.style.opacity = '0.5';
        }, 0);
      });

      accessory.addEventListener('dragend', (e) => {
        e.target.style.opacity = '1';
      });
    });

    chest.addEventListener('dragover', (e) => e.preventDefault());
    chest.addEventListener('drop', (e) => {
      e.preventDefault();
      if (draggedItem) {
        const accessoryType = draggedItem.id;
        const accessoryEmoji = draggedItem.textContent;
        if (accessoryEmoji) {
          chestItems.push(accessoryEmoji);
          draggedItem.textContent = '';
          addEventToBar("üß≥‚úÖ Accesorio guardado", "Has guardado un accesorio en el cofre para usarlo m√°s tarde.");
          gainXP(2);
          updateChestItems();
          updateFirestore();
        }
        draggedItem = null;
      }
    });

    // Cerrar modales
    document.querySelectorAll('.close').forEach(closeBtn => {
      closeBtn.onclick = function() {
        this.closest('.modal').style.display = 'none';
      }
    });

    window.onclick = function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
      }
    }

    function updatePetAppearance() {
      if (level >= 20) {
        pet.style.filter = 'drop-shadow(0 0 15px gold)';
      } else if (level >= 10) {
        pet.style.filter = 'drop-shadow(0 0 10px silver)';
      } else if (level >= 5) {
        pet.style.filter = 'drop-shadow(0 0 5px bronze)';
      } else {
        pet.style.filter = 'none';
      }
    }

    function movePet() {
      if (!isGameActive) return;

      const oscillationRange = 5;
      const oscillationSpeed = 0.005;
      const oscillationX = oscillationRange * Math.sin(Date.now() * oscillationSpeed);
      const oscillationY = oscillationRange * Math.cos(Date.now() * oscillationSpeed);
      
      petContainer.style.left = `calc(50% + ${oscillationX}px)`;
      petContainer.style.top = `calc(50% + ${oscillationY}px)`;
      petContainer.style.transform = 'translate(-50%, -50%)';
    }

    function resizePet() {
      // El tama√±o del pet se maneja en updatePetExpression
    }

    window.addEventListener('resize', resizePet);

    function resetGame() {
      hunger = 50;
      fun = 100;
      hygiene = 100;
      currency = 2000;
      level = 1;
      xp = 0;
      isSick = false;
      caressCount = 0;
      chestItems = [];
      shampooCount = 0;
      crown.textContent = '';
      glasses.textContent = '';
      hat.textContent = '';
      petDocRef.set({
        hunger: hunger,
        fun: fun,
        hygiene: hygiene,
        currency: currency,
        level: level,
        xp: xp,
        isSick: isSick,
        caressCount: caressCount,
        chestItems: chestItems,
        shampooCount: shampooCount,
        isLightOn: isLightOn,
        currentBackground: currentBackground,
        accessories: {
          crown: crown.textContent,
          glasses: glasses.textContent,
          hat: hat.textContent
        }
      }).then(() => {
        addEventToBar("üîÑ‚úÖ Juego reiniciado", "¬°Es hora de un nuevo comienzo! Cuida bien a Cakiwaki desde el principio.");
        updateStatus();
      }).catch((error) => {
        console.error("Error al reiniciar el juego en Firebase:", error);
        addEventToBar("üö® Error al reiniciar el juego.", "Ha ocurrido un problema. Por favor, int√©ntalo de nuevo m√°s tarde.");
      });
    }

    function handleConnectionStatus() {
      const connectedRef = firebase.database().ref('.info/connected');
      connectedRef.on('value', (snap) => {
        if (snap.val() === true) {
          addEventToBar("‚úÖ Conectado a Firebase", "Tu progreso se guardar√° autom√°ticamente.");
        } else {
          addEventToBar("üì° Conexi√≥n perdida. Esperando reconexi√≥n...", "No te preocupes, intentaremos reconectar pronto.");
        }
      });
    }

petDocRef.onSnapshot((doc) => {
      if (doc.exists) {
        const data = doc.data();
        hunger = data.hunger;
        fun = data.fun;
        hygiene = data.hygiene;
        currency = data.currency;
        level = data.level;
        xp = data.xp;
        isSick = data.isSick;
        caressCount = data.caressCount;
        chestItems = data.chestItems || [];
        shampooCount = data.shampooCount;
        isLightOn = data.isLightOn;
        currentBackground = data.currentBackground;
        crown.textContent = data.accessories.crown;
        glasses.textContent = data.accessories.glasses;
        hat.textContent = data.accessories.hat;
        updateUI();
      } else {
        updateFirestore();
      }
    }, (error) => {
      console.error("Error al escuchar cambios en Firebase:", error);
      addEventToBar("üö® Error de conexi√≥n con Firebase.", "Estamos experimentando problemas t√©cnicos. Por favor, int√©ntalo de nuevo m√°s tarde.");
    });

    function updateFirestore() {
      petDocRef.set({
        hunger: hunger,
        fun: fun,
        hygiene: hygiene,
        currency: currency,
        level: level,
        xp: xp,
        isSick: isSick,
        caressCount: caressCount,
        chestItems: chestItems,
        shampooCount: shampooCount,
        isLightOn: isLightOn,
        currentBackground: currentBackground,
        accessories: {
          crown: crown.textContent,
          glasses: glasses.textContent,
          hat: hat.textContent
        }
      }).then(() => {
        console.log("Datos actualizados correctamente en Firebase");
      }).catch((error) => {
        console.error("Error al actualizar los datos en Firebase:", error);
        addEventToBar("üö® Error al actualizar datos en Firebase.", "Ha ocurrido un problema al guardar tu progreso. Por favor, int√©ntalo de nuevo m√°s tarde.");
      });
    }

    function loadGame() {
      petDocRef.get().then((doc) => {
        if (doc.exists) {
          const data = doc.data();
          hunger = data.hunger;
          fun = data.fun;
          hygiene = data.hygiene;
          currency = data.currency;
          level = data.level;
          xp = data.xp;
          isSick = data.isSick;
          caressCount = data.caressCount;
          chestItems = data.chestItems || [];
          shampooCount = data.shampooCount;
          isLightOn = data.isLightOn;
          currentBackground = data.currentBackground;
          crown.textContent = data.accessories.crown;
          glasses.textContent = data.accessories.glasses;
          hat.textContent = data.accessories.hat;
          updateUI();
          addEventToBar("üéÆ Juego cargado", "¬°Bienvenido de vuelta! Cakiwaki est√° feliz de verte.");
        } else {
          updateFirestore();
          addEventToBar("üÜï Nuevo juego iniciado", "¬°Bienvenido a Neonpet Deluxe! Cuida bien de tu nuevo amigo Cakiwaki.");
        }
      }).catch((error) => {
        console.error("Error al cargar el juego desde Firebase:", error);
        addEventToBar("üö® Error al cargar el juego.", "Ha ocurrido un problema al cargar tu progreso. Por favor, int√©ntalo de nuevo m√°s tarde.");
      });
    }

    function generatePoop() {
      if (!isGameActive) return;
      const poops = document.querySelectorAll('.poop');
      if (poops.length >= 6) return; // No generar m√°s de 6 cacas

      const poop = document.createElement('div');
      poop.classList.add('poop');
      poop.textContent = 'üí©';
      const petFrame = document.querySelector('.pet-frame');
      const petRect = pet.getBoundingClientRect();
      
      let x, y;
      do {
        x = Math.random() * (petFrame.offsetWidth - 30);
        y = Math.random() * (petFrame.offsetHeight - 30);
      } while (
        x > petRect.left - 30 && x < petRect.right + 30 &&
        y > petRect.top - 30 && y < petRect.bottom + 30
      );
      
      poop.style.left = `${x}px`;
      poop.style.top = `${y}px`;
      petFrame.appendChild(poop);

      poop.addEventListener('click', () => {
        poop.remove();
        hygiene = Math.max(0, hygiene - 10);
        addEventToBar("üßπ Has limpiado una caca", "Mantener limpio el ambiente de Cakiwaki es importante para su salud.");
        updateStatus();
        updateFirestore();
      });

      hygiene = Math.max(0, hygiene - 5);
      updateStatus();
      updateFirestore();
    }

    function updateUI() {
      updateStatus();
      updateChestItems();
      background.style.background = backgrounds[currentBackground];
      lightSwitch.textContent = isLightOn ? 'üí°' : 'üåô';
    }

    function petDeath() {
      isGameActive = false;
      pet.textContent = Math.random() < 0.5 ? 'üíÄ' : 'üëπ';
      pet.style.fontSize = '15vh'; // Tama√±o fijo al morir
      addEventToBar("üíÄ Cakiwaki ha muerto. Dale de comer para revivirlo.", "No te desanimes, puedes traer a Cakiwaki de vuelta con algo de comida.");
    }

    function randomSickness() {
      if (!isGameActive || isSick) return;

      const sicknessProbability = 0.02 + (document.querySelectorAll('.poop').length * 0.01);

      if (Math.random() < sicknessProbability) {
        isSick = true;
        isRandomExpressionMode = false;
        pet.textContent = 'ü§í';
        pet.style.fontSize = '15vh'; // Tama√±o fijo cuando est√° enfermo
        addEventToBar(getRandomPhrase('sick'), "Cuidar la salud de Cakiwaki es importante. Aseg√∫rate de mantenerlo limpio y bien alimentado.");
        fun = Math.max(0, fun - 20);
        updateStatus();
        updateFirestore();
      }
    }

    function randomEvent() {
      if (!isGameActive) return;

      const events = [
        { probability: 0.05, action: () => { addEventToBar("üåü ¬°Cakiwaki encontr√≥ una moneda brillante!", "¬°Qu√© suerte! Cada moneda ayuda a cuidar mejor a Cakiwaki."); currency += 10; gainXP(5); updateFirestore(); } },
        { probability: 0.03, action: () => { addEventToBar(getRandomPhrase('random'), "Cakiwaki tiene ideas interesantes. ¬øPor qu√© no juegas con √©l?"); } },
        { probability: 0.04, action: () => { addEventToBar("üéÅ ¬°Regalo sorpresa para Cakiwaki!", "¬°Qu√© emoci√≥n! Jugar minijuegos ayuda a Cakiwaki a divertirse y ganar recompensas."); xp += 20; gainXP(20); updateFirestore(); } },
        { probability: 0.02, action: () => { addEventToBar("üçÄ ¬°D√≠a de suerte para Cakiwaki!", "La buena suerte sonr√≠e a Cakiwaki hoy. ¬°Aprovecha este momento especial!"); fun = Math.min(100, fun + 15); gainXP(5); updateFirestore(); } },
        { probability: 0.01, action: () => { addEventToBar("üìö Cakiwaki aprendi√≥ algo nuevo", "¬°Incre√≠ble! Cakiwaki est√° creciendo y aprendiendo. Sigue ense√±√°ndole cosas nuevas."); gainXP(15); updateFirestore(); } },
        { probability: 0.02, action: () => { addEventToBar("üåà Un arco√≠ris apareci√≥ en el cielo", "Los arco√≠ris traen alegr√≠a y fortuna. ¬°Disfruta este momento m√°gico con Cakiwaki!"); currency += 30; gainXP(10); updateFirestore(); } },
        { probability: 0.01, action: () => { addEventToBar("üéà Cakiwaki encontr√≥ un globo", "¬°Qu√© divertido! Los globos siempre alegran el d√≠a de Cakiwaki."); fun = Math.min(100, fun + 20); gainXP(5); updateFirestore(); } }
      ];

      events.forEach(event => {
        if (Math.random() < event.probability) {
          event.action();
          updateStatus();
          updateFirestore();
        }
      });
    }

    function petRandomMessage() {
      if (!isGameActive || !isLightOn) return;
      addEventToBar(getRandomPhrase('random'), "Cakiwaki tiene mucho que decir. ¬°Presta atenci√≥n a sus ocurrencias!");
    }

    function optimizePerformance() {
      function animate() {
        if (isGameActive) {
          movePet();
        }
        requestAnimationFrame(animate);
      }
      requestAnimationFrame(animate);

      let firebaseUpdateTimeout;
      function throttledFirebaseUpdate() {
        if (!firebaseUpdateTimeout) {
          firebaseUpdateTimeout = setTimeout(() => {
            updateFirestore();
            firebaseUpdateTimeout = null;
          }, 5000);
        }
      }

      window.updateFirestore = throttledFirebaseUpdate;
    }

    function manageMemory() {
      setInterval(() => {
        const poops = document.querySelectorAll('.poop');
        if (poops.length > 6) {
          poops[0].remove();
          addEventToBar("üßπ Limpieza autom√°tica", "El entorno de Cakiwaki se mantiene limpio autom√°ticamente para evitar problemas de salud.");
        }
      }, 60000);

      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.type === 'childList') {
            while (eventBar.childNodes.length > 5) {
              eventBar.removeChild(eventBar.lastChild);
            }
          }
        });
      });

      observer.observe(eventBar, { childList: true });
    }

    function init() {
      loadGame();
      updateStatus();
      resizePet();
      setInterval(decreaseStats, 10000);
      setInterval(changeWeather, 15000);
      setInterval(() => {
        if (isLightOn && isGameActive && !isSick) {
          changePetFace();
        }
      }, Math.floor(Math.random() * 4000) + 3000);
      setInterval(randomEvent, 60000);
      setInterval(petRandomMessage, 90000);
      setInterval(generatePoop, Math.floor(Math.random() * 50000) + 20000);
      setInterval(specialEvents, 300000);
      setInterval(seasonalEvents, 86400000);
      background.style.background = backgrounds[currentBackground];
      handleConnectionStatus();
      optimizePerformance();
      manageMemory();
      dailyReward();
      achievementSystem();
    }

    function resizeContent() {
      const gameContainer = document.querySelector('.game-container');
      const height = window.innerHeight;
      gameContainer.style.height = `${height}px`;

      window.parent.postMessage({ type: 'resize', height: height }, '*');
    }

    window.addEventListener('resize', resizeContent);

    document.addEventListener('DOMContentLoaded', () => {
      init();
      resizeContent();
    });

    window.addEventListener('message', (event) => {
      if (event.data === 'initializePet') {
        init();
      }
    });

    function dailyReward() {
      const lastRewardDate = localStorage.getItem('lastRewardDate');
      const today = new Date().toDateString();

      if (lastRewardDate !== today) {
        const rewardAmount = 100 + (level * 10);
        currency += rewardAmount;
        addEventToBar(`üéÅ ¬°Recompensa diaria! +${rewardAmount} monedas`, "¬°Vuelve ma√±ana para otra recompensa! Jugar regularmente ayuda a Cakiwaki a crecer m√°s r√°pido.");
        localStorage.setItem('lastRewardDate', today);
        updateStatus();
        updateFirestore();
      }
    }

    function achievementSystem() {
      const achievements = [
        { id: 'level10', name: 'Mascota Adolescente', condition: () => level >= 10, reward: 500 },
        { id: 'level20', name: 'Mascota Adulta', condition: () => level >= 20, reward: 1000 },
        { id: 'rich', name: 'Rico y Famoso', condition: () => currency >= 10000, reward: 2000 },
        { id: 'collector', name: 'Coleccionista', condition: () => chestItems.length >= 10, reward: 1500 }
      ];

      achievements.forEach(achievement => {
        if (achievement.condition() && !localStorage.getItem(`achievement_${achievement.id}`)) {
          currency += achievement.reward;
          addEventToBar(`üèÜ Logro desbloqueado: ${achievement.name}. +${achievement.reward} monedas`, "¬°Fant√°stico! Los logros demuestran tu dedicaci√≥n como cuidador de mascotas virtuales.");
          localStorage.setItem(`achievement_${achievement.id}`, 'true');
          updateStatus();
          updateFirestore();
        }
      });
    }

    function specialEvents() {
      const events = [
        { name: 'Lluvia de Meteoritos', probability: 0.01, action: () => {
          addEventToBar('‚òÑÔ∏è ¬°Lluvia de meteoritos! Cakiwaki est√° emocionado.', "Un evento raro y emocionante. ¬°Disfr√∫talo con Cakiwaki!");
          fun = Math.min(100, fun + 30);
          gainXP(50);
        }},
        { name: 'Visita del Hada Madrina', probability: 0.005, action: () => {
          addEventToBar('üßö‚Äç‚ôÄÔ∏è El Hada Madrina visit√≥ a Cakiwaki y le concedi√≥ un deseo.', "¬°Qu√© suerte! El Hada Madrina trae magia y buenos deseos.");
          const randomStat = Math.floor(Math.random() * 3);
          switch(randomStat) {
            case 0:
              hunger = 100;
              addEventToBar('üçΩÔ∏è ¬°Cakiwaki est√° completamente satisfecho!', "El Hada Madrina llen√≥ m√°gicamente el est√≥mago de Cakiwaki.");
              break;
            case 1:
              fun = 100;
addEventToBar('üéâ ¬°Cakiwaki est√° extremadamente feliz!', "El Hada Madrina trajo mucha diversi√≥n a Cakiwaki.");
              break;
            case 2:
              hygiene = 100;
              addEventToBar('‚ú® ¬°Cakiwaki est√° impecablemente limpio!', "El Hada Madrina dio un ba√±o m√°gico a Cakiwaki.");
              break;
          }
        }},
        { name: 'Invasi√≥n Alien√≠gena', probability: 0.002, action: () => {
          addEventToBar('üëΩ ¬°Una invasi√≥n alien√≠gena! Cakiwaki est√° fascinado.', "¬°Incre√≠ble! Los alien√≠genas trajeron tecnolog√≠a avanzada y diversi√≥n.");
          gainXP(100);
          currency += 500;
        }}
      ];

      events.forEach(event => {
        if (Math.random() < event.probability) {
          event.action();
          updateStatus();
          updateFirestore();
        }
      });
    }

    function seasonalEvents() {
      const now = new Date();
      const month = now.getMonth();
      const day = now.getDate();

      if (month === 11 && day === 25) { // Navidad
        addEventToBar("üéÑ ¬°Feliz Navidad!", "Cakiwaki ha recibido un regalo especial.");
        currency += 1000;
        chestItems.push('üéÅ');
      } else if (month === 0 && day === 1) { // A√±o Nuevo
        addEventToBar("üéÜ ¬°Feliz A√±o Nuevo!", "Cakiwaki est√° emocionado por un nuevo a√±o de aventuras.");
        gainXP(500);
      } else if (month === 9 && day === 31) { // Halloween
        addEventToBar("üéÉ ¬°Feliz Halloween!", "Cakiwaki se ha disfrazado para la ocasi√≥n.");
        chestItems.push('üëª');
      }

      updateStatus();
      updateFirestore();
    }

    // Iniciar el juego
    init();
    </script>
</body>
</html>