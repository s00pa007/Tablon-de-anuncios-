<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Cafetería Retro</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

body, html { 
    margin: 0; 
    padding: 0; 
    height: 100%; 
    font-family: 'Press Start 2P', monospace; 
    background-color: #9bbc0f; 
    color: #ffffff; 
}

#game { 
    display: flex; 
    flex-direction: column; 
    height: 100%; 
    position: relative;
}

#header { 
    height: 5%; 
    background-color: #8bac0f; 
    display: flex; 
    align-items: center; 
    justify-content: space-around; 
    font-size: 8px; 
    position: relative;
    border: 4px solid #333333;
    box-sizing: border-box;
    z-index: 200;
}

#header div { 
    display: flex; 
    align-items: center; 
}

#header .money, #header .weather, #header .time, #header .level { 
    margin: 0 5px; 
}

.bars-wrapper { 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
}

.bar-container { 
    display: flex; 
    align-items: center; 
    margin: 2px 0;
}

.bar { 
    width: 80px; 
    height: 8px; 
    background-color: #333333; 
    position: relative; 
    border-radius: 4px;
}

.benefits-bar, .satisfaction-bar { 
    width: 0%; 
    height: 100%; 
    position: absolute; 
    left: 0; 
    border-radius: 4px 0 0 4px;
    transition: width 0.3s ease-in-out;
    z-index: 150;
}

.benefits-bar { 
    background-color: #00ff00; 
}

.satisfaction-bar { 
    background-color: #ff0000; 
}

.bar-icon {
    margin-left: 4px;
    font-size: 8px;
    z-index: 150;
}

#monitor { 
    flex: 1; 
    background: url('coffee.png') no-repeat center center; 
    background-size: cover; 
    position: relative; 
    z-index: 1;
    overflow: hidden; 
}

.drink-serving {
    position: absolute;
    bottom: 138px;
    width: 40px; 
    height: 40px;
    transform: translateX(-50%);
    z-index: 150;
}

#drink-serving-0 { left: 20%; }
#drink-serving-1 { left: 40%; }
#drink-serving-2 { left: 60%; }
#drink-serving-3 { left: 80%; }

.drink-serving img {
    width: 60%;
    height: 60%;
    image-rendering: pixelated;
}

#waiter {
    position: absolute;
    width: 128px;
    height: 128px;
    bottom: 47%;
    left: 50%;
    transform: translateX(-50%);
    transition: left 0.5s linear;
    z-index: 100;
}

#waiter img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    image-rendering: pixelated;
}

.customer { 
    position: absolute;
    bottom: 70px;
    left: -10%;
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    font-size: 32px; 
    width: 50px;
    z-index: 200;
    transition: left 1.5s ease, bottom 1s ease;
}

.customer.sitting {
    bottom: 165px;
}

.speech-bubble {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    margin-bottom: 20px;
    width: auto;
    padding: 5px;
    background: #ffffff;
    border-radius: 5px;
    box-shadow: 0px 0px 5px #000;
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 250;
}

.speech-bubble::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    width: 0;
    height: 0;
    border: 5px solid transparent;
    border-top-color: #ffffff;
}

.speech-bubble img {
    width: 19px;
    height: 20px;
    margin-left: 2px;
}

.ingredient-additional {
    display: flex;
    align-items: center;
    margin-left: 4px;
    font-size: 10px;
    color: #000000;
}

.ingredient-additional img {
    width: 14px;
    height: 14px;
    margin-left: 2px;
}

.customer-emoji {
    position: absolute;
    top: 10px; 
    left: 50%;
    transform: translateX(-50%);
    font-size: 32px;
    z-index: 200;
}

#bottom { 
    height: 45%; 
    display: flex; 
    font-size: 6px; 
    padding: 10px;
}

#left, #right { 
    flex: 1; 
    padding: 10px; 
    background-color: #8bac0f; 
    border: 4px solid #333333; 
    box-shadow: inset 0 0 10px #333333;
    box-sizing: border-box;
}

#left {
    margin-right: 2px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

#right {
    margin-left: 2px;
    overflow-y: auto;
}

#left .section { 
    margin-bottom: 10px;
}

#left .section h3 { 
    margin-bottom: 5px;
    font-size: 6px;
}

/* Estilos para el inventario en columna */
#left .inventory {
    display: flex; /* Fila para los tres elementos */
    justify-content: space-between; /* Espacio uniforme entre los items */
    align-items: center; /* Alinear verticalmente al centro */
    gap: 2px; /* Espaciado mínimo entre los elementos */
    background-color: rgba(51, 51, 51, 0.8); /* Fondo oscuro semi-transparente */
    border: 1px solid #ffffff; /* Bordes blancos */
    border-radius: 3px; /* Bordes redondeados */
    padding: 2px; /* Espaciado interno compacto */
}

#left .inventory-item {
    background-color: #333333; /* Fondo oscuro sólido */
    border: 1px solid #ffffff; /* Bordes blancos */
    border-radius: 3px; /* Bordes redondeados */
    text-align: center;
    font-size: 6px; /* Fuente pequeña */
    flex: 1; /* Distribución uniforme de ancho */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-around; /* Alineación compacta */
    padding: 2px; /* Margen interno compacto */
}

#left .inventory-item img {
    width: 20px;
    height: 20px; /* Iconos pequeños para ahorrar espacio */
    margin-bottom: 2px;
}

#left .inventory-item span {
    font-size: 5px; /* Fuente compacta */
    color: #ffffff; /* Texto blanco */
}

#left .inventory-item button {
    font-size: 5px; /* Fuente pequeña */
    padding: 2px 4px; /* Botón compacto */
    background: linear-gradient(145deg, #555555, #777777); /* Estilo retro */
    color: #ffffff; /* Texto blanco */
    border: none;
    border-radius: 2px; /* Bordes mínimos */
    box-shadow: 1px 1px 2px #222222; /* Sombras retro */
    cursor: pointer;
}



/* Opcional: Scroll personalizado */
#left .inventory::-webkit-scrollbar {
    width: 6px;
}

#left .inventory::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 3px;
}

#left .inventory::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 3px;
}

#left .recipe-board {
    display: grid;
    grid-template-columns: 1fr;
    gap: 2px;
    background-color: rgba(51,51,51,0.8);
    border-radius: 5px;
    padding: 5px;
    margin-top: 3px;
    font-size: 5px;
}

.recipe {
    background-color: #333333;
    border: 1px solid #ffffff;
    border-radius: 3px;
    padding: 5px;
    text-align: center;
    display: grid;
    grid-template-columns: 40px 1fr;
    align-items: center;
    gap: 5px;
}

.recipe-image {
    justify-self: center;
}

.recipe-ingredients {
    display: flex;
    justify-content: space-around;
    align-items: center;
    gap: 8px;
}

.recipe-ingredients img {
    width: 16px;
    height: 16px;
    margin: 0 2px;
}

.recipe-ingredients span {
    font-size: 6px;
    color: #ffffff;
}

#price-setting {
    margin-top: 5px;
    display: flex;
    align-items: center;
    gap: 3px;
    font-family: 'Press Start 2P', monospace; /* Fuente retro */
    font-size: 6px; /* Tamaño reducido */
    text-transform: uppercase; /* Estilo retro */
    color: #ffffff;
}

#price-setting label {
    font-size: 6px;
    margin-right: 5px;
}

#price-setting input {
    width: 40px;
    padding: 2px;
    border: 2px solid #ffffff;
    border-radius: 3px;
    background-color: #333333;
    color: #00ff00; /* Verde retro */
    text-align: center;
    font-family: 'Press Start 2P', monospace;
    font-size: 6px;
    text-transform: uppercase;
    box-shadow: 0px 0px 5px #000;
}

#price-setting .adjust-buttons {
    display: flex;
    flex-direction: column;
    gap: 1px;
}

#price-setting .adjust-buttons button {
    width: 20px;
    height: 20px;
    padding: 2px;
    font-size: 6px;
    border: none;
    border-radius: 3px;
    background-color: #555555;
    color: #ffffff;
    cursor: pointer;
    font-family: 'Press Start 2P', monospace;
    text-transform: uppercase;
    transition: transform 0.2s, background-color 0.2s;
}

#price-setting .adjust-buttons button:hover {
    transform: translateY(-2px);
    background-color: #777777;
    box-shadow: 0px 0px 5px #ffffff;
}
#right h3 { 
    margin-bottom: 5px;
    font-size: 6px;
}

.order-list { 
    display: flex; 
    flex-direction: column; 
    gap: 4px;
}

.pending-orders, .cleaning-orders {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.order { 
    background-color: rgba(51,51,51,0.8); 
    border: 1px solid #333333; 
    padding: 4px; 
    border-radius: 5px;
    display: flex;
    flex-direction: column;
    gap: 4px;
    transition: height 0.3s ease;
    overflow: hidden;
}

.order-header { 
    display: flex; 
    flex-direction: column;
    gap: 2px;
    cursor: pointer;
}

.coffee-name {
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 0;
}

.coffee-name img {
    width: 25px;
    height: 25px;
}

.coffee-extra {
    display: flex;
    align-items: center;
    margin-left: 4px;
    font-size: 6px;
    color: #000000;
}

.coffee-extra img {
    width: 14px;
    height: 14px;
    margin-left: 2px;
}

.timer {
    font-size: 5px;
    text-align: center;
}

.ingredients-row {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-top: 2px;
}

.ingredient-button {
    position: relative;
    width: 40px;
    height: 40px;
    padding: 0;
    font-size: 24px;
    border: none;
    border-radius: 4px;
    background: linear-gradient(145deg, #555555, #777777);
    color: #ffffff;
    cursor: pointer;
    box-shadow: 2px 2px 4px #222222;
    transition: transform 0.2s, box-shadow 0.2s;
}

.ingredient-button:hover {
    transform: translateY(-2px);
    box-shadow: 4px 4px 8px #222222;
}

.ingredient-counter {
    position: absolute;
    top: -2px;
    right: -2px;
    font-size: 4px;
    background-color: rgba(0, 0, 0, 0.8);
    color: #00ff00;
    padding: 1px;
    border-radius: 2px;
    min-width: 8px;
    text-align: center;
}

.serve-button {
    align-self: center;
    margin-top: 2px;
    padding: 3px 6px;
    font-size: 6px;
    border: none;
    border-radius: 8px;
    background: linear-gradient(145deg, #555555, #777777);
    color: #ffffff;
    cursor: pointer;
    box-shadow: 2px 2px 4px #222222;
    transition: transform 0.2s, box-shadow 0.2s;
    font-family: 'Press Start 2P', monospace;
}

.serve-button:hover {
    transform: translateY(-2px);
    box-shadow: 4px 4px 8px #222222;
}

.serve-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

#summary { 
    position: absolute; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background-color: rgba(51,51,51,0.95); 
    color: #ffffff; 
    display: none; 
    flex-direction: column; 
    align-items: center; 
    justify-content: center; 
    font-size: 10px; 
    text-align: center; 
    z-index: 1000;
}

#summary h2 { 
    margin-bottom: 10px; 
    color: #00ff00; 
}

#summary p { 
    margin: 5px 0; 
}

#summary button { 
    margin-top: 10px; 
    padding: 5px 10px; 
    font-size: 8px; 
    border: none;
    border-radius: 8px;
    background: linear-gradient(145deg, #555555, #777777);
    color: #ffffff;
    cursor: pointer;
    box-shadow: 3px 3px 6px #222222;
    transition: transform 0.2s, box-shadow 0.2s;
    font-family: 'Press Start 2P', monospace;
}

#summary button:hover {
    transform: translateY(-2px);
    box-shadow: 6px 6px 12px #222222;
}

.ingredient-img {
    width: 16px;
    height: 16px;
    vertical-align: middle;
}

.coffee-type-img {
    width: 21px;
    height: 21px;
}

.coffee-type-img-order {
    width: 25px;
    height: 25px;
}

.served-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 4px;
}

.served-content img {
    width: 20px;
    height: 20px;
}

.limpiar-button {
    padding: 3px 6px;
    font-size: 6px;
    border: none;
    border-radius: 8px;
    background: linear-gradient(145deg, #00ff00, #00cc00);
    color: #ffffff;
    cursor: pointer;
    box-shadow: 2px 2px 4px #222222;
    font-family: 'Press Start 2P', monospace;
    transition: background 0.3s, cursor 0.3s;
}

.limpiar-button:hover {
    transform: translateY(-2px);
    box-shadow: 4px 4px 8px #222222;
}

.limpiar-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Estilos para Hora Punta */
#peak-hour-banner {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 1001;
    display: none;
}

#peak-hour-banner img {
    width: 200px;
    height: auto;
}

/* Estilos para las estrellitas */
.star-effect {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%) scale(0.8);
    width: 30px;
    height: 30px;
    background: url('star.png') no-repeat center center;
    background-size: contain;
    animation: starAnimation 1.5s forwards;
    pointer-events: none;
    image-rendering: pixelated;
}

@keyframes starAnimation {
    0% {
        transform: translateX(-50%) translateY(0) scale(0.8);
        opacity: 1;
    }
    50% {
        transform: translateX(-50%) translateY(-20px) scale(1.2);
        opacity: 1;
    }
    100% {
        transform: translateX(-50%) translateY(-40px) scale(1);
        opacity: 0;
    }
}

/* Estilos para mensajes en la interfaz */
.in-game-message {
    position: absolute;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    padding: 4px 8px;
    background-color: #b6f542;
    border: 1px solid #333333;
    border-radius: 4px;
    font-size: 8px;
    color: #000000;
    opacity: 0;
    animation: messageFadeInOut 3s forwards;
    pointer-events: none;
    font-family: 'Press Start 2P', monospace;
    z-index: 1000;
}

@keyframes messageFadeInOut {
    0% {
        opacity: 0;
    }
    10% {
        opacity: 1;
    }
    90% {
        opacity: 1;
    }
    100% {
        opacity: 0;
    }
}

/* Estilos para el mensaje "Clean" */
.clean-message {
    position: absolute;
    top: -30px;
    left: 50%;
    transform: translateX(-50%);
    padding: 2px 4px;
    background-color: #b6f542;
    border: 1px solid #333333;
    border-radius: 4px;
    font-size: 6px;
    color: #000000;
    opacity: 1;
    animation: messageFade 2s forwards;
    pointer-events: none;
    font-family: 'Press Start 2P', monospace;
}

@keyframes messageFade {
    0% {
        opacity: 1;
    }
    100% {
        opacity: 0;
    }
}


.inventory-button {
    padding: 2px 6px;
    font-size: 6px;
    border: none;
    border-radius: 3px;
    background-color: #555555;
    color: #ffffff;
    cursor: pointer;
    font-family: 'Press Start 2P', monospace; /* Fuente retro */
    text-transform: uppercase; /* Estilo retro */
    transition: transform 0.2s, background-color 0.2s;
}

.inventory-button:hover {
    transform: translateY(-2px);
    background-color: #777777;
    box-shadow: 0px 0px 5px #ffffff;
}

/* Contenedor general del inventario */
#left .section {
    margin-bottom: 10px; /* Más espacio entre secciones */
}

/* Tabla de recetas */
#recipe-board {
    margin-top: 15px; /* Más separación del inventario */
}

/* Contenedor del precio */
#price-setting {
    margin-top: 15px; /* Más espacio debajo de la tabla de recetas */
    display: flex;
    align-items: center;
    gap: 5px;
    font-family: 'Press Start 2P', monospace;
    font-size: 6px;
    text-transform: uppercase;
    color: #ffffff;
}

</style>
</head>
<body>
<div id="game">
    <div id="header">
        <div class="weather">☀️</div>
        <div class="money">Dinero: $100</div>
        <div class="level">Nivel: 1</div>
        <div class="time">07:00</div>
        <div class="bars-wrapper">
            <div class="bar-container">
                <div class="bar">
                    <div class="benefits-bar"></div>
                </div>
                <div class="bar-icon">💰</div>
            </div>
            <div class="bar-container">
                <div class="bar">
                    <div class="satisfaction-bar"></div>
                </div>
                <div class="bar-icon">❤️</div>
            </div>
        </div>
    </div>
    <div id="monitor">
        <!-- Cartel de Hora Punta -->
        <div id="peak-hour-banner">
            <img src="punta.png" alt="Hora Punta" />
        </div>
        <!-- Drink Servings -->
        <div id="drink-serving-0" class="drink-serving">
            <img src="" alt="Bebida Servida" class="served-drink" style="display: none;">
        </div>
        <div id="drink-serving-1" class="drink-serving">
            <img src="" alt="Bebida Servida" class="served-drink" style="display: none;">
        </div>
        <div id="drink-serving-2" class="drink-serving">
            <img src="" alt="Bebida Servida" class="served-drink" style="display: none;">
        </div>
        <div id="drink-serving-3" class="drink-serving">
            <img src="" alt="Bebida Servida" class="served-drink" style="display: none;">
        </div>
        <div id="waiter">
            <img src="./waiter1.png" alt="Waiter" style="display: block;">
        </div>
    </div>
    <div id="bottom">
        <div id="left">
            <div class="section">
<h3>Inventario</h3>
<div class="inventory">
    <div class="inventory-item">
        <div class="inventory-ingredient">
            <img src="cof.png" alt="Coffee" class="ingredient-img">
            <span id="coffee">10</span>
        </div>
        <button class="inventory-button" data-item="coffee">+10</button>
    </div>
    <div class="inventory-item">
        <div class="inventory-ingredient">
            <img src="mil.png" alt="Milk" class="ingredient-img">
            <span id="milk">10</span>
        </div>
        <button class="inventory-button" data-item="milk">+10</button>
    </div>
    <div class="inventory-item">
        <div class="inventory-ingredient">
            <img src="sug.png" alt="Sugar" class="ingredient-img">
            <span id="sugar">10</span>
        </div>
        <button class="inventory-button" data-item="sugar">+10</button>
    </div>
</div>
<div id="recipe-board">
    <div class="recipe">
        <div class="recipe-image">
            <img src="sol.png" alt="Solo" class="coffee-type-img">
        </div>
        <div class="recipe-ingredients">
            <div>
                <img src="cof.png" alt="Coffee" class="ingredient-img">
                <span>x1</span>
            </div>
            <div>
                <img src="sug.png" alt="Sugar" class="ingredient-img">
                <span>x1</span>
            </div>
        </div>
    </div>
    <div class="recipe">
        <div class="recipe-image">
            <img src="cor.png" alt="Cortado" class="coffee-type-img">
        </div>
        <div class="recipe-ingredients">
            <div>
                <img src="cof.png" alt="Coffee" class="ingredient-img">
                <span>x1</span>
            </div>
            <div>
                <img src="mil.png" alt="Milk" class="ingredient-img">
                <span>x1</span>
            </div>
            <div>
                <img src="sug.png" alt="Sugar" class="ingredient-img">
                <span>x1</span>
            </div>
        </div>
    </div>
    <div class="recipe">
        <div class="recipe-image">
            <img src="lec.png" alt="Leche y Leche" class="coffee-type-img">
        </div>
        <div class="recipe-ingredients">
            <div>
                <img src="cof.png" alt="Coffee" class="ingredient-img">
                <span>x1</span>
            </div>
            <div>
                <img src="mil.png" alt="Milk" class="ingredient-img">
                <span>x2</span>
            </div>
            <div>
                <img src="sug.png" alt="Sugar" class="ingredient-img">
                <span>x1</span>
            </div>
        </div>
    </div>
</div>
                <div id="price-setting">
                    <label for="coffee-price">Precio:</label>
                    <input type="number" id="coffee-price" value="5" min="1">
                    <div class="adjust-buttons">
                        <button id="increase-price">+</button>
                        <button id="decrease-price">-</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="right">
            <h3>Pedidos</h3>
            <div class="order-list">
                <div class="pending-orders"></div> <!-- Pedidos pendientes -->
                <div class="cleaning-orders"></div> <!-- Órdenes de limpieza -->
            </div>
        </div>
    </div>
</div>
<div id="summary">
    <h2>Resumen Semanal</h2>
    <div style="text-align: left; padding: 20px;">
        <p>💰 Beneficios Totales: $<span id="total-benefits">0</span></p>
        <p>🍽️ Gastos Totales: $<span id="total-expenses">0</span></p>
        <p>💵 Beneficios Netos: $<span id="net-benefits">0</span></p>
        <p>☕️ Cafés Vendidos: <span id="total-sold">0</span></p>
        <p>👥 Clientes Totales: <span id="total-customers">0</span></p>
        <p>😊 Clientes Satisfechos: <span id="satisfied-customers">0</span></p>
        <p>😞 Clientes Insatisfechos: <span id="unsatisfied-customers">0</span></p>
        <p>⭐️ Satisfacción Promedio: <span id="average-satisfaction">0</span>%</p>
        <h3>Ingredientes Utilizados:</h3>
        <p>
            <img src="cof.png" alt="Coffee" class="ingredient-img"> Café: 
            <span id="used-coffee">0</span>
        </p>
        <p>
            <img src="mil.png" alt="Milk" class="ingredient-img"> Leche: 
            <span id="used-milk">0</span>
        </p>
        <p>
            <img src="sug.png" alt="Sugar" class="ingredient-img"> Azúcar: 
            <span id="used-sugar">0</span>
        </p>
        <p>🏆 Café Más Vendido: <span id="most-popular">ninguno</span></p>
    </div>
    <button onclick="startNextDay()">Siguiente Nivel</button>
</div>



<script>

// Selección de elementos del DOM
const moneyDisplay = document.querySelector('.money');
const weatherDisplay = document.querySelector('.weather');
const timeDisplay = document.querySelector('.time');
const benefitsBar = document.querySelector('.benefits-bar');
const satisfactionBar = document.querySelector('.satisfaction-bar');
const levelDisplay = document.querySelector('.level');
const monitor = document.getElementById('monitor');
const inventoryButtons = document.querySelectorAll('.inventory button'); // Actualizado
const coffeeSpan = document.getElementById('coffee');
const milkSpan = document.getElementById('milk');
const sugarSpan = document.getElementById('sugar');
const pendingOrdersContainer = document.querySelector('.pending-orders');
const cleaningOrdersContainer = document.querySelector('.cleaning-orders');
const summary = document.getElementById('summary');
const totalBenefits = document.getElementById('total-benefits');
const totalExpenses = document.getElementById('total-expenses');
const netBenefits = document.getElementById('net-benefits');
const totalSold = document.getElementById('total-sold');
const totalCustomers = document.getElementById('total-customers');
const satisfiedCustomers = document.getElementById('satisfied-customers');
const unsatisfiedCustomers = document.getElementById('unsatisfied-customers');
const averageSatisfaction = document.getElementById('average-satisfaction');
const usedCoffee = document.getElementById('used-coffee');
const usedMilk = document.getElementById('used-milk');
const usedSugar = document.getElementById('used-sugar');
const mostPopular = document.getElementById('most-popular');
const coffeePriceInput = document.getElementById('coffee-price');
const increasePriceBtn = document.getElementById('increase-price');
const decreasePriceBtn = document.getElementById('decrease-price');
const waiter = document.getElementById('waiter');
let waiterImg = waiter.querySelector('img');

// Funciones auxiliares
function getIngredientImg(name) {
    switch(name) {
        case 'coffee': return 'cof.png';
        case 'milk': return 'mil.png';
        case 'sugar': return 'sug.png';
        default: return '';
    }
}

function getCoffeeTypeImg(name) {
    switch(name) {
        case 'Solo': return 'sol.png';
        case 'Cortado': return 'cor.png';
        case 'Leche y Leche': return 'lec.png';
        default: return '';
    }
}

// Estados y configuración del camarero
let currentWaiterState = 'waiting';
let waiterWaitInterval = null;
let isPreparingOrder = false;
const WAITER_STATES = {
    RIGHT: './waiter1.png',
    LEFT: './waiter2.png',
    WAIT1: './waiterwait.png',
    WAIT2: './waiterwait2.png',
    PREP: './waiterprep.png'
};

// Recetas de café
const RECIPES = {
    'Solo': { coffee: 1, milk: 0, sugar: 1 },
    'Cortado': { coffee: 1, milk: 1, sugar: 1 },
    'Leche y Leche': { coffee: 1, milk: 2, sugar: 1 }
};

// Variables del juego
let money = 100;
let weather = '☀️';
let time = 7;
let benefits = 0;
let satisfaction = 50;
let inventory = { coffee: 10, milk: 10, sugar: 10 };
let orders = [];
let sold = 0;
let totalExpense = 0;
const customerEmojis = ['😀','🙂','😅','🙃','😇'];
let customerSlots = [null, null, null, null];
let customerQueue = [];
let openOrders = new Set();
let level = 1;
let customerArrivalInterval = 5000;
let orderPreparationInterval;
let gameTimerInterval;
let isWaiterMoving = false;
let gameTime = 0;
const startHour = 7;
const endHour = 12;
let minTime = 15;
let maxTime = 40;
const slotCooldown = [false, false, false, false];
const cooldownDuration = 1000;
let gameStats = {
    totalCoffeesSold: 0,
    totalCustomers: 0,
    satisfiedCustomers: 0,
    unsatisfiedCustomers: 0,
    ingredientsUsed: {
        coffee: 0,
        milk: 0,
        sugar: 0
    },
    coffeeTypes: {
        'Solo': 0,
        'Cortado': 0,
        'Leche y Leche': 0
    }
};

let dirtySlots = new Set();

const peakStartHour = 10;
const peakStartMinute = 30;
const peakEndHour = 11;
const peakEndMinute = 30;
let isPeakHour = false;

let customerSpeedMultiplier = 1.0;
let orderTimeMultiplier = 1.0;
let waiterSpeedMultiplier = 1.0;

let messageTimeout;

// Funciones del camarero
function startWaiterWaitAnimation() {
    if (waiterWaitInterval) {
        clearTimeout(waiterWaitInterval);
    }
    let isFirstImage = true;
    function toggleWaitImage() {
        if (currentWaiterState === 'waiting' && !isPreparingOrder) {
            waiterImg.src = isFirstImage ? WAITER_STATES.WAIT1 : WAITER_STATES.WAIT2;
            isFirstImage = !isFirstImage;
        }
    }
    function setRandomInterval() {
        const randomTime = Math.floor(Math.random() * 2000) + 1000;
        waiterWaitInterval = setTimeout(() => {
            toggleWaitImage();
            if (currentWaiterState === 'waiting') {
                setRandomInterval();
            }
        }, randomTime);
    }
    setRandomInterval();
}

function stopWaiterWaitAnimation() {
    if (waiterWaitInterval) {
        clearTimeout(waiterWaitInterval);
        waiterWaitInterval = null;
    }
}

function initializeWaiter() {
    const waiterElement = document.getElementById('waiter');
    const monitorRect = monitor.getBoundingClientRect();
    const centerX = monitorRect.width / 2;
    waiterElement.style.left = `${centerX}px`;
    currentWaiterState = 'waiting';
    startWaiterWaitAnimation();
}

async function moveWaiter(targetX) {
    return new Promise((resolve, reject) => {
        if (isWaiterMoving) {
            resolve();
            return;
        }
        isWaiterMoving = true;
        currentWaiterState = 'serving';
        stopWaiterWaitAnimation();
        const waiterElement = document.getElementById('waiter');
        const waiterImgElement = waiterElement.querySelector('img');
        const monitorRect = monitor.getBoundingClientRect();
        const currentX = waiterElement.getBoundingClientRect().left - monitorRect.left;
        targetX = Math.max(waiterElement.offsetWidth / 2, 
            Math.min(targetX, monitorRect.width - waiterElement.offsetWidth / 2));
        waiterImgElement.src = targetX > currentX ? WAITER_STATES.RIGHT : WAITER_STATES.LEFT;
        requestAnimationFrame(() => {
            waiterElement.style.left = `${targetX}px`;
        });
        setTimeout(() => {
            isWaiterMoving = false;
            if (targetX === monitorRect.width / 2) {
                currentWaiterState = 'waiting';
                startWaiterWaitAnimation();
            }
            resolve();
        }, 500 / waiterSpeedMultiplier);
    });
}

async function serveCustomer(customerElement, slotIndex) {
    if (!customerElement) return;
    const drinkServing = document.getElementById(`drink-serving-${slotIndex}`);
    if (!drinkServing) return;
    const monitorRect = monitor.getBoundingClientRect();
    const targetX = drinkServing.getBoundingClientRect().left - monitorRect.left + (drinkServing.offsetWidth / 2);
    try {
        await moveWaiter(targetX);
        await new Promise(resolve => setTimeout(resolve, 300 / waiterSpeedMultiplier));
        await moveWaiter(monitorRect.width / 2);
    } catch (error) {
        isWaiterMoving = false;
    }
}

// Funciones de actualización de display
function updateDisplay() {
    moneyDisplay.textContent = `Dinero: $${money}`;
    weatherDisplay.textContent = weather;
    const totalMinutes = gameTime;
    const displayMinutes = totalMinutes % 60;
    const formattedMinutes = displayMinutes < 10 ? `0${displayMinutes}` : displayMinutes;
    const displayTime = time < 10 ? `0${time}:${formattedMinutes}` : `${time}:${formattedMinutes}`;
    timeDisplay.textContent = displayTime;
    benefitsBar.style.width = `${Math.min(benefits, 100)}%`;
    satisfactionBar.style.width = `${Math.min(satisfaction, 100)}%`;
    coffeeSpan.textContent = inventory.coffee;
    milkSpan.textContent = inventory.milk;
    sugarSpan.textContent = inventory.sugar;
    levelDisplay.textContent = `Nivel: ${level}`;
}

// Función para mostrar mensajes en el juego
function showInGameMessage(message) {
    const existingMessage = document.querySelector('.in-game-message');
    if (existingMessage) {
        existingMessage.parentNode.removeChild(existingMessage);
    }
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('in-game-message');
    messageDiv.textContent = message;
    document.getElementById('game').appendChild(messageDiv);
    setTimeout(() => {
        if (messageDiv && messageDiv.parentNode) {
            messageDiv.parentNode.removeChild(messageDiv);
        }
    }, 3000);
}

// Funciones de gestión de clientes
function addCustomer() {
    if((customerQueue.length + customerSlots.filter(slot => slot !== null).length) >= 4) return;
    const customerEmoji = customerEmojis[Math.floor(Math.random() * customerEmojis.length)];
    const coffeeTypes = Object.keys(RECIPES);
    const selectedCoffee = coffeeTypes[Math.floor(Math.random() * coffeeTypes.length)];
    const randomTime = getRandomInt(minTime, maxTime);

    let extraIngredient = null;
    let specialOrder = false;
    let specialProbability = 0.1;

    if(level === 2) {
        specialProbability = 0.2;
    } else if(level >= 3) {
        specialProbability = 0.3;
    }

    if (Math.random() < specialProbability) {
        specialOrder = true;
        const possibleExtras = Object.keys(RECIPES[selectedCoffee]).filter(key => RECIPES[selectedCoffee][key] > 0);
        if (possibleExtras.length > 0) {
            const randomIndex = getRandomInt(0, possibleExtras.length - 1);
            extraIngredient = possibleExtras[randomIndex];
            RECIPES[selectedCoffee][extraIngredient] += 1;
        }
    }

    const order = {
        id: Date.now() + Math.random(),
        customer: customerEmoji,
        coffeeName: selectedCoffee,
        ingredients: {...RECIPES[selectedCoffee]},
        requiredIngredients: {...RECIPES[selectedCoffee]},
        timeLeft: randomTime * orderTimeMultiplier,
        served: false,
        happy: true,
        bubbleTimeouts: [],
        extraIngredient: extraIngredient,
        slotIndex: null,
        elementList: null,
        state: 'pending'
    };

    if (extraIngredient) {
        RECIPES[selectedCoffee][extraIngredient] -= 1;
    }

    orders.push(order);
    renderOrders();
    assignCustomerToSlot(order);
}

function assignCustomerToSlot(order) {
    const slotOffsets = [9, 30, 53, 79];
    const freeSlots = customerSlots.map((slot, index) => (slot === null && !slotCooldown[index]) ? index : null).filter(index => index !== null);
    if(freeSlots.length > 0) {
        const randomIndex = freeSlots[Math.floor(Math.random() * freeSlots.length)];

        customerSlots[randomIndex] = order;
        order.slotIndex = randomIndex;
        const customerDiv = document.createElement('div');
        customerDiv.classList.add('customer');
        customerDiv.innerHTML = `
            <div class="customer-emoji">${order.customer}</div>
            <div class="speech-bubble">
                <img src="${getCoffeeTypeImg(order.coffeeName)}" alt="${order.coffeeName}" class="order-img">
                ${order.extraIngredient ? `<div class="ingredient-additional">+1 <img src="${getIngredientImg(order.extraIngredient)}" alt="${order.extraIngredient}" class="ingredient-img"></div>` : ''}
            </div>
        `;
        monitor.appendChild(customerDiv);
        order.element = customerDiv;
        const targetLeft = slotOffsets[randomIndex];
        customerDiv.style.left = `-10%`;
        customerDiv.style.bottom = `70px`;

        const moveDuration = 1500 / customerSpeedMultiplier;
        const sitDuration = 1000 / customerSpeedMultiplier;

        setTimeout(() => {
            customerDiv.style.transition = `left ${moveDuration}ms ease, bottom ${sitDuration}ms ease`;
            customerDiv.style.left = `${targetLeft}%`;
            setTimeout(() => {
                customerDiv.style.bottom = `165px`;
                setTimeout(() => {
                    customerDiv.classList.add('sitting');
                }, sitDuration);
            }, moveDuration);
        }, 100);

        if (!dirtySlots.has(order.slotIndex)) {
            satisfaction = Math.min(satisfaction + 1, 100);
        } else {
            satisfaction = Math.max(satisfaction - 1, 0);
        }
        updateDisplay();

        showSpeechBubble(order);
    } else {
        customerQueue.push(order);
    }
}

function showSpeechBubble(order) {
    const bubble = order.element.querySelector('.speech-bubble');
    if(bubble && !order.served) {
        setTimeout(() => {
            bubble.style.display = 'flex';
            const hideTime = Math.random() * 1000 + 1000;
            const hideTimeout = setTimeout(() => {
                bubble.style.display = 'none';
                if(!order.served) {
                    setTimeout(() => {
                        showSpeechBubble(order);
                    }, Math.random() * 1000 + 3000);
                }
            }, hideTime);
            order.bubbleTimeouts.push(hideTimeout);
        }, 0);
    }
}

function removeCustomerFromSlot(order) {
    const slotIndex = customerSlots.indexOf(order);
    if(slotIndex !== -1) {
        customerSlots[slotIndex] = null;
        slotCooldown[slotIndex] = true;
        setTimeout(() => {
            slotCooldown[slotIndex] = false;
            if(customerQueue.length > 0) {
                const nextOrder = customerQueue.shift();
                assignCustomerToSlot(nextOrder);
            }
        }, cooldownDuration);
    }
    order.bubbleTimeouts.forEach(timeout => clearTimeout(timeout));
}

function markSlotDirty(slotIndex) {
    dirtySlots.add(slotIndex);
}

function cleanSlot(slotIndex) {
    dirtySlots.delete(slotIndex);
    const drinkServing = document.getElementById(`drink-serving-${slotIndex}`);
    if(drinkServing) {
        drinkServing.querySelector('.served-drink').style.display = 'none';
    }
}

function getRandomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs < 10 ? '0'+secs : secs}`;
}

// Función para obtener el precio máximo por nivel
function getMaxPriceForLevel() {
    return 5 + (level - 1);
}

// Renderizar órdenes
function renderOrders() {
    pendingOrdersContainer.innerHTML = '';
    cleaningOrdersContainer.innerHTML = '';

    orders.forEach(order => {
        const orderDiv = document.createElement('div');
        orderDiv.classList.add('order');
        orderDiv.setAttribute('data-id', order.id);

        if (order.state === 'pending') {
            const headerDiv = document.createElement('div');
            headerDiv.classList.add('order-header');

            const coffeeName = document.createElement('div');
            coffeeName.classList.add('coffee-name');

            const coffeeImg = document.createElement('img');
            coffeeImg.src = getCoffeeTypeImg(order.coffeeName);
            coffeeImg.alt = order.coffeeName;
            coffeeImg.classList.add('coffee-type-img-order');
            coffeeName.appendChild(coffeeImg);

            if(order.extraIngredient) {
                const coffeeExtra = document.createElement('div');
                coffeeExtra.classList.add('coffee-extra');
                coffeeExtra.innerHTML = `+1 <img src="${getIngredientImg(order.extraIngredient)}" alt="${order.extraIngredient}" class="ingredient-img">`;
                coffeeName.appendChild(coffeeExtra);
            }

            const timer = document.createElement('div');
            timer.classList.add('timer');
            timer.id = `timer-${order.id}`;
            timer.textContent = formatTime(order.timeLeft);
            headerDiv.appendChild(coffeeName);
            headerDiv.appendChild(timer);
            orderDiv.appendChild(headerDiv);

            if (!order.served) {
                if (openOrders.has(order.id)) {
                    const ingredientsRow = document.createElement('div');
                    ingredientsRow.classList.add('ingredients-row');

                    const used = {
                        coffee: RECIPES[order.coffeeName].coffee - order.ingredients.coffee,
                        milk: RECIPES[order.coffeeName].milk - order.ingredients.milk,
                        sugar: RECIPES[order.coffeeName].sugar - order.ingredients.sugar
                    };

                    if(order.extraIngredient) {
                        used[order.extraIngredient] += 1;
                    }

                    const ingredients = [
                        { name: 'coffee', emoji: '☕️' },
                        { name: 'milk', emoji: '☁️' },
                        { name: 'sugar', emoji: '🍚' }
                    ];

                    ingredients.forEach(ing => {
                        const btn = document.createElement('button');
                        btn.classList.add('ingredient-button');
                        btn.innerHTML = `
                            <img src="${getIngredientImg(ing.name)}" alt="${ing.name}" class="ingredient-img">
                            <div class="ingredient-counter">${Math.abs(used[ing.name])}</div>
                        `;
                        btn.onclick = (e) => {
                            e.stopPropagation();
                            addIngredient(order.id, ing.name);
                        };
                        ingredientsRow.appendChild(btn);
                    });

                    orderDiv.appendChild(ingredientsRow);

                    const serveBtn = document.createElement('button');
                    serveBtn.classList.add('serve-button');
                    serveBtn.textContent = 'Servir';
                    serveBtn.disabled = isWaiterMoving;
                    serveBtn.onclick = (e) => {
                        e.stopPropagation();
                        if (!isWaiterMoving) {
                            serveOrder(order.id);
                        }
                    };
                    orderDiv.appendChild(serveBtn);
                }
            }

            headerDiv.onclick = () => toggleOrder(order.id);
            pendingOrdersContainer.appendChild(orderDiv);
        } else if (order.state === 'empty') {
            const limpiarContent = document.createElement('div');
            limpiarContent.classList.add('served-content');
            limpiarContent.innerHTML = `
                <img src="gla.png" alt="Vaso Vacío" class="ingredient-img" style="width: 20px; height: 20px;">
                <button class="limpiar-button" data-id="${order.id}">Limpiar</button>
            `;
            const limpiarBtn = limpiarContent.querySelector('.limpiar-button');
            limpiarBtn.onclick = () => {
                limpiarOrder(order.id);
            };
            orderDiv.appendChild(limpiarContent);
            cleaningOrdersContainer.appendChild(orderDiv);
        }

        order.elementList = orderDiv;
    });
}

function toggleOrder(id) {
    if (openOrders.has(id)) {
        openOrders.delete(id);
    } else {
        openOrders.clear();
        openOrders.add(id);
    }
    renderOrders();
}

function addIngredient(id, item) {
    const order = orders.find(o => o.id === id);
    if(order && !order.served) {
        if (inventory[item] > 0) {
            if (!isPreparingOrder) {
                isPreparingOrder = true;
                currentWaiterState = 'preparing';
                stopWaiterWaitAnimation();
                waiterImg.src = WAITER_STATES.PREP;
            }
            order.ingredients[item] = (order.ingredients[item] || 0) - 1;
            inventory[item]--;
            gameStats.ingredientsUsed[item]++;
            renderOrders();
            updateDisplay();
            clearTimeout(window.preparationTimeout);
            window.preparationTimeout = setTimeout(() => {
                isPreparingOrder = false;
                if (!isWaiterMoving) {
                    currentWaiterState = 'waiting';
                    startWaiterWaitAnimation();
                }
            }, 1000 / waiterSpeedMultiplier);
        } else {
            showInGameMessage('No hay ingrediente');
            satisfaction = Math.max(satisfaction - 5, 0);
            updateDisplay();
        }
    }
}

async function serveOrder(id) {
    const order = orders.find(o => o.id === id);
    if(order && !order.served && !isWaiterMoving) {
        order.state = 'served';
        renderOrders();

        if(dirtySlots.has(order.slotIndex)) {
            dirtySlots.delete(order.slotIndex);
            const cleaningOrder = orders.find(o => o.slotIndex === order.slotIndex && o.state === 'empty');
            if (cleaningOrder) {
                cleaningOrder.state = 'cleaned';
                orders = orders.filter(o => o.state !== 'cleaned');
            }
        }

        let correct = true;
        for(let key in order.requiredIngredients) {
            if(order.ingredients[key] !== 0) {
                correct = false;
                break;
            }
        }
        await serveCustomer(order.element, order.slotIndex);
        const drinkServing = document.getElementById(`drink-serving-${order.slotIndex}`);
        if(correct) {
            benefits +=10;
            satisfaction = Math.min(satisfaction + 10, 100);
            benefits = Math.min(benefits, 100);
            const price = parseInt(coffeePriceInput.value) || 5;
            money += price;
            sold += 1;
            gameStats.totalCoffeesSold++;
            gameStats.satisfiedCustomers++;
            gameStats.totalCustomers++;
            gameStats.coffeeTypes[order.coffeeName]++;
            gameStats.ingredientsUsed.coffee += RECIPES[order.coffeeName].coffee;
            gameStats.ingredientsUsed.milk += RECIPES[order.coffeeName].milk;
            gameStats.ingredientsUsed.sugar += RECIPES[order.coffeeName].sugar;
            if(order.extraIngredient) {
                gameStats.ingredientsUsed[order.extraIngredient]++;
            }
            if(drinkServing) {
                drinkServing.querySelector('.served-drink').src = getCoffeeTypeImg(order.coffeeName);
                drinkServing.querySelector('.served-drink').style.display = 'block';
            }

            const initialTime = order.timeLeft / orderTimeMultiplier;
            const halfTime = initialTime / 2;
            const timeUsed = initialTime - order.timeLeft;

            if(timeUsed < halfTime) {
                satisfaction = Math.min(satisfaction + 1, 100);
            }

            setTimeout(() => {
                if(drinkServing) {
                    drinkServing.querySelector('.served-drink').src = 'gla.png';
                }
                order.state = 'empty';
                markSlotDirty(order.slotIndex);
                renderOrders();
                const customerEmoji = order.element.querySelector('.customer-emoji');
                customerEmoji.textContent = '😄';
                setTimeout(() => animateDeparture(order), getRandomInt(2000, 5000));
            }, 2000 * orderTimeMultiplier);
        } else {
            satisfaction = Math.max(satisfaction - 10, 0);
            gameStats.unsatisfiedCustomers++;
            gameStats.totalCustomers++;
            if(drinkServing) {
                drinkServing.querySelector('.served-drink').src = 'gla.png';
                drinkServing.querySelector('.served-drink').style.display = 'block';
            }
            order.state = 'empty';
            markSlotDirty(order.slotIndex);
            renderOrders();
            const customerEmoji = order.element.querySelector('.customer-emoji');
            customerEmoji.textContent = '😞';
            setTimeout(() => {
                setTimeout(() => animateDeparture(order), getRandomInt(2000, 5000));
            }, 1500 * orderTimeMultiplier);
        }
        order.served = true;
        openOrders.delete(order.id);
        updateDisplay();
    }
}

function animateDeparture(order) {
    if(order.element) {
        order.element.classList.remove('sitting');
        setTimeout(() => {
            order.element.style.left = `-10%`;
            setTimeout(() => {
                if(order.element && order.element.parentNode) {
                    monitor.removeChild(order.element);
                }
            }, 1500 / customerSpeedMultiplier);
        }, 1000 / customerSpeedMultiplier);
        removeCustomerFromSlot(order);
    }
}

// Eventos de botones de inventario y precio
inventoryButtons.forEach(btn => {
    btn.onclick = () => {
        const item = btn.getAttribute('data-item');
        if(inventory[item] + 10 <= 10 && money >= 20) { // Asegúrate de que el límite sea correcto
            inventory[item] += 10;
            money -= 20;
            totalExpense += 20; // Registrar el gasto
            updateDisplay();
        } else {
            showInGameMessage('No hay más espacio o dinero insuficiente');
        }
    };
});

// Ajuste de precios
increasePriceBtn.onclick = () => {
    let currentPrice = parseInt(coffeePriceInput.value) || 5;
    let maxPrice = getMaxPriceForLevel();
    if (currentPrice < maxPrice) {
        coffeePriceInput.value = currentPrice + 1;
    }
};

decreasePriceBtn.onclick = () => {
    let currentPrice = parseInt(coffeePriceInput.value) || 5;
    if(currentPrice > 1) {
        coffeePriceInput.value = currentPrice - 1;
    }
};

// Funciones de limpieza de órdenes
function limpiarOrder(id) {
    const order = orders.find(o => o.id === id);
    if (order) {
        triggerCleanEffects(order.slotIndex);

        order.state = 'cleaned';
        orders = orders.filter(o => o.state !== 'cleaned');
        cleanSlot(order.slotIndex);
        renderOrders();
        updateDisplay();
    }
}

function triggerCleanEffects(slotIndex) {
    const drinkServing = document.getElementById(`drink-serving-${slotIndex}`);
    if (drinkServing) {
        const effectContainer = document.createElement('div');
        effectContainer.style.position = 'absolute';
        effectContainer.style.top = '0';
        effectContainer.style.left = '50%';
        effectContainer.style.transform = 'translateX(-50%)';
        effectContainer.style.pointerEvents = 'none';
        effectContainer.style.zIndex = '300';

        const star = document.createElement('div');
        star.classList.add('star-effect');
        effectContainer.appendChild(star);

        const message = document.createElement('div');
        message.classList.add('clean-message');
        message.textContent = 'Clean';
        effectContainer.appendChild(message);

        drinkServing.appendChild(effectContainer);

        setTimeout(() => {
            if (effectContainer && effectContainer.parentNode) {
                effectContainer.parentNode.removeChild(effectContainer);
            }
        }, 2000);
    }
}

// Funciones de control del juego
function showSummary() {
    const mostPopularCoffeeEntry = Object.entries(gameStats.coffeeTypes)
        .reduce((a, b) => a[1] > b[1] ? a : b, ['', 0]);
    const mostPopularCoffee = mostPopularCoffeeEntry[0] || 'ninguno';
    totalBenefits.textContent = benefits;
    totalExpenses.textContent = totalExpense;
    netBenefits.textContent = benefits - totalExpense;
    totalSold.textContent = gameStats.totalCoffeesSold;
    totalCustomers.textContent = gameStats.totalCustomers;
    satisfiedCustomers.textContent = gameStats.satisfiedCustomers;
    unsatisfiedCustomers.textContent = gameStats.unsatisfiedCustomers;
    averageSatisfaction.textContent = gameStats.totalCustomers > 0 ? Math.floor((gameStats.satisfiedCustomers * 100) / gameStats.totalCustomers) : 0;
    usedCoffee.textContent = gameStats.ingredientsUsed.coffee;
    usedMilk.textContent = gameStats.ingredientsUsed.milk;
    usedSugar.textContent = gameStats.ingredientsUsed.sugar;
    mostPopular.textContent = mostPopularCoffee;
    summary.style.display = 'flex';
    clearInterval(orderPreparationInterval);
    clearInterval(gameTimerInterval);
}

function startNextDay() {
    clearInterval(orderPreparationInterval);
    clearInterval(gameTimerInterval);
    stopWaiterWaitAnimation();
    currentWaiterState = 'waiting';
    isPreparingOrder = false;
    summary.style.display = 'none';
    level++;
    minTime = Math.max(5, Math.round(minTime * 0.85));
    maxTime = Math.max(20, Math.round(maxTime * 0.85));
    customerArrivalInterval = Math.max(1000, customerArrivalInterval - 1000);
    gameTime = 0;
    time = startHour;
    benefits = 0;
    satisfaction = 50;
    inventory = { coffee: 10, milk: 10, sugar: 10 };
    orders = [];
    sold = 0;
    customerQueue = [];
    customerSlots = [null, null, null, null];
    openOrders = new Set();
    totalExpense = 0;
    dirtySlots.clear();
    gameStats = {
        totalCoffeesSold: 0,
        totalCustomers: 0,
        satisfiedCustomers: 0,
        unsatisfiedCustomers: 0,
        ingredientsUsed: {
            coffee: 0,
            milk: 0,
            sugar: 0
        },
        coffeeTypes: {
            'Solo': 0,
            'Cortado': 0,
            'Leche y Leche': 0
        }
    };
    let maxPrice = getMaxPriceForLevel();
    if (parseInt(coffeePriceInput.value) > maxPrice) {
        coffeePriceInput.value = maxPrice;
    }
    monitor.innerHTML = '';
    monitor.innerHTML = `
        <!-- Cartel de Hora Punta -->
        <div id="peak-hour-banner">
            <img src="punta.png" alt="Hora Punta" />
        </div>
        <div id="drink-serving-0" class="drink-serving">
            <img src="" alt="Bebida Servida" class="served-drink" style="display: none;">
        </div>
        <div id="drink-serving-1" class="drink-serving">
            <img src="" alt="Bebida Servida" class="served-drink" style="display: none;">
        </div>
        <div id="drink-serving-2" class="drink-serving">
            <img src="" alt="Bebida Servida" class="served-drink" style="display: none;">
        </div>
        <div id="drink-serving-3" class="drink-serving">
            <img src="" alt="Bebida Servida" class="served-drink" style="display: none;">
        </div>
        <div id="waiter">
            <img src="./waiter1.png" alt="Waiter" style="display: block;">
        </div>
    `;
    waiterImg = waiter.querySelector('img');
    updateDisplay();
    initializeWaiter();
    renderOrders();
    startGame();
}

function checkPeakHour(currentHour, currentMinute) {
    if (
        (currentHour === peakStartHour && currentMinute >= peakStartMinute) ||
        (currentHour > peakStartHour && currentHour < peakEndHour) ||
        (currentHour === peakEndHour && currentMinute <= peakEndMinute)
    ) {
        if (!isPeakHour) {
            activatePeakHour();
        }
    } else {
        if (isPeakHour) {
            deactivatePeakHour();
        }
    }
}

function activatePeakHour() {
    isPeakHour = true;
    const peakBanner = document.getElementById('peak-hour-banner');
    peakBanner.style.display = 'block';

    setTimeout(() => {
        peakBanner.style.display = 'none';
    }, 1500);

    customerSpeedMultiplier = 1.3;
    orderTimeMultiplier = 0.7;
    waiterSpeedMultiplier = 1.3;
}

function deactivatePeakHour() {
    isPeakHour = false;
    customerSpeedMultiplier = 1.0;
    orderTimeMultiplier = 1.0;
    waiterSpeedMultiplier = 1.0;
}

function startGame() {
    updateDisplay();
    initializeWaiter();
    orderPreparationInterval = setInterval(() => {
        const currentOrders = [...orders];
        currentOrders.forEach(order => {
            if (!order.served && order.state === 'pending') {
                if(order.timeLeft > 0) { 
                    order.timeLeft--; 
                }
                const timerSpan = document.getElementById(`timer-${order.id}`);
                if(timerSpan) {
                    timerSpan.textContent = formatTime(order.timeLeft);
                    if(order.timeLeft <= 60 && order.timeLeft > 30) {
                        timerSpan.style.color = '#ffaa00';
                    }
                    if(order.timeLeft <= 30 && order.timeLeft > 0) {
                        timerSpan.style.color = '#ff0000';
                    }
                }
                if(order.timeLeft <= 0 && !order.served) {
                    order.timeLeft = 0;

                    satisfaction = Math.max(satisfaction - 10, 0);
                    gameStats.unsatisfiedCustomers++;
                    gameStats.totalCustomers++;

                    if(order.element) {
                        const customerEmoji = order.element.querySelector('.customer-emoji');
                        if(customerEmoji) {
                            customerEmoji.textContent = '😞';
                        }
                        const bubble = order.element.querySelector('.speech-bubble');
                        if(bubble) {
                            bubble.style.display = 'none';
                            order.bubbleTimeouts.forEach(timeout => clearTimeout(timeout));
                        }
                    }

                    animateDeparture(order);
                    removeCustomerFromSlot(order);

                    order.state = 'cleaned';
                    orders = orders.filter(o => o.state !== 'cleaned');
                    openOrders.delete(order.id);
                    renderOrders();
                    updateDisplay();
                }
            }
        });
    }, 1000 / orderTimeMultiplier);
   
   
   // Función para verificar y aplicar la hora punta

   // Función para activar la hora punta
   function activatePeakHour() {
       gameState.isPeakHour = true;
       peakBanner.style.display = 'block';
       
       setTimeout(() => {
           peakBanner.style.display = 'none';
       }, 1500);
       
       gameState.customerSpeedMultiplier = 1.3;
       gameState.orderTimeMultiplier = 0.7;
       gameState.waiterSpeedMultiplier = 1.3;
       
       // Ajustar los intervalos de llegada de clientes y preparación de órdenes
       clearInterval(customerArrivalInterval);
       customerArrivalInterval = setInterval(() => {
           addCustomer();
       }, 2000 / gameState.customerSpeedMultiplier); // Reducir el intervalo para más clientes
       
       clearInterval(orderPreparationInterval);
       orderPreparationInterval = setInterval(() => {
           handleOrderPreparation();
       }, 1000 / gameState.orderTimeMultiplier); // Acelerar la preparación de órdenes
   }
   
   // Función para desactivar la hora punta
   function deactivatePeakHour() {
       gameState.isPeakHour = false;
       gameState.customerSpeedMultiplier = 1.0;
       gameState.orderTimeMultiplier = 1.0;
       gameState.waiterSpeedMultiplier = 1.0;
       
       // Restaurar los intervalos de llegada de clientes y preparación de órdenes
       clearInterval(customerArrivalInterval);
       customerArrivalInterval = setInterval(() => {
           addCustomer();
       }, 2000 / gameState.customerSpeedMultiplier);
       
       clearInterval(orderPreparationInterval);
       orderPreparationInterval = setInterval(() => {
           handleOrderPreparation();
       }, 1000 / gameState.orderTimeMultiplier);
   }

    const customerArrivalTimer = setInterval(() => {
        addCustomer();
    }, customerArrivalInterval / customerSpeedMultiplier);

    gameTimerInterval = setInterval(() => {
        gameTime += 1;
        const totalMinutes = gameTime;
        const currentHour = startHour + Math.floor(totalMinutes / 60);
        const currentMinute = totalMinutes % 60;
        if(currentHour >= endHour) {
            clearInterval(gameTimerInterval);
            clearInterval(orderPreparationInterval);
            clearInterval(customerArrivalTimer);
            showSummary();
        } else {
            time = currentHour;
            updateDisplay();
            checkPeakHour(currentHour, currentMinute);
        }
    }, 200);
}

window.addEventListener('load', () => {
    initializeWaiter();
    startGame();
});
</script>
</body>
</html>