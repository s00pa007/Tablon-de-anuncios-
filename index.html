<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablón de anuncios anónimos</title>
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;700&family=Roboto+Slab:wght@700&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<style>
    :root {
        --background-color: #f0f0f0;
        --text-color: #333333;
        --header-bg: #ffffff;
        --counter-bg: #e0e0e0;
        --button-bg: #4caf50;
        --button-text: #ffffff;
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        background-color: var(--background-color);
        color: var(--text-color);
        font-family: 'Comfortaa', cursive;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        overflow-x: hidden;
    }

    header {
        background-color: var(--header-bg);
        padding: 10px 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        width: 100%;
    }

    #header-image {
        max-width: 100%;
        height: auto;
        display: block;
        margin: 0 auto;
    }

    #slogan {
        background-color: #ffff00;
        color: #000000;
        padding: 5px;
        margin-top: 5px;
        border-radius: 5px;
        font-size: 16px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        height: 60px;
    }

    .pet-status-container {
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: var(--header-bg);
        padding: 10px 20px;
        border-radius: 10px;
        border: 2px solid var(--button-bg);
        position: sticky;
        top: 0;
        width: 100%;
        z-index: 1000;
        gap: 40px;
        flex-wrap: nowrap;
    }

    .pet-status-container div {
        width: 120px;
        height: 120px;
        position: relative;
        flex-shrink: 0;
    }

    .pet-status-container div img, .gallery-link img, .candy-game-link img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 10%;
        cursor: pointer;
        border: 4px solid var(--button-bg);
        box-shadow: 0 0 10px rgba(0, 255, 255, 0.6);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        display: block;
    }

    .gallery-link img:hover, .pet-emoji img:hover, .candy-game-link img:hover {
        transform: scale(1.1);
        box-shadow: 0 0 15px rgba(0, 255, 255, 0.8);
    }

    .main-container {
        display: flex;
        flex: 1;
        padding: 20px;
        position: relative;
    }

    .left-column {
        flex: 1;
        padding-right: 20px;
    }

    #message-form {
        background-color: var(--header-bg);
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    #message-form textarea {
        width: 100%;
        height: 80px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        resize: vertical;
        font-size: 16px;
        font-family: 'Comfortaa', cursive;
    }

    #message-form button {
        width: 100%;
        padding: 10px;
        margin-top: 10px;
        background-color: var(--button-bg);
        color: var(--button-text);
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 18px;
        font-family: 'Comfortaa', cursive;
        font-weight: bold;
    }

    #bulletin-board {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .message {
        display: flex;
        flex-direction: column;
        padding: 10px;
        border-radius: 10px;
        font-size: 14px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border: 1px solid #333;
        margin-bottom: 15px;
    }

    .message-content {
        display: flex;
        align-items: flex-start;
    }

    .message-emoji {
        font-size: 36px;
        margin-right: 10px;
    }

    .message-text {
        flex: 1;
        margin-bottom: 5px;
        line-height: 1.3;
        word-wrap: break-word;
    }

    .message-timestamp {
        font-size: 10px;
        opacity: 0.7;
        text-align: right;
        margin-top: 5px;
    }

    .message-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 5px;
    }

    .like-btn, .dislike-btn, .reply-btn, .delete-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 18px;
    }

    .quoted-message {
        font-size: 12px;
        padding: 5px;
        border-left: 3px solid #ccc;
        margin-bottom: 10px;
        cursor: pointer;
    }

    .quoted-message:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }

    .reply-form {
        margin-top: 10px;
    }

    .reply-form textarea {
        width: 100%;
        padding: 5px;
        margin-bottom: 5px;
    }

    .reply-form button {
        padding: 5px 10px;
    }

    .statistics {
        background-color: var(--counter-bg);
        padding: 15px;
        border-radius: 10px;
        margin-top: 20px;
        font-size: 14px;
    }

    .statistics div {
        margin-bottom: 5px;
    }

    @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
        100% { transform: translateY(0px); }
    }

    .floating-emoji {
        position: fixed;
        font-size: 30px;
        animation: float 3s ease-in-out infinite;
        pointer-events: none;
        z-index: -1;
    }

    .delete-confirmation {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 5px;
    }

    .delete-confirmation button {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 18px;
    }

    .teletipo-wrapper {
        position: relative;
        width: 100%;
        margin-bottom: 20px;
    }

    .rumores-label {
        position: absolute;
        top: -15px;
        left: 0;
        font-size: 12px;
        font-weight: bold;
        color: #ff6347;
        text-transform: uppercase;
        background-color: var(--background-color);
        padding: 0 5px;
        z-index: 1;
    }

    #teletipo-container {
        width: 100%;
        border-top: 1px solid #ccc;
        padding-top: 10px;
        background-color: var(--background-color);
        z-index: 999;
    }

    #loading {
        text-align: center;
        padding: 20px;
        display: none;
    }

    /* Estilos para los pop-ups */
    #gallery-modal, #pet-popup, #candy-popup {
        display: none;
        position: fixed;
        background-color: white;
        border: 2px solid #333;
        border-radius: 10px;
        z-index: 5001;
        overflow: hidden;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    /* Estilos específicos para cada pop-up */
    #gallery-modal {
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 95%;
        height: 95%;
    }

    #pet-popup {
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 95%;
        height: 95%;
    }

    #candy-popup {
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 95%;
        height: 95%;
    }

    #gallery-modal .close-gallery, #pet-popup #close-popup, #candy-popup #close-candy-popup {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 24px;
        cursor: pointer;
        background: none;
        border: none;
        z-index: 1002;
    }

    #gallery-modal .gallery-container, #candy-popup .candy-iframe, #pet-popup .pet-iframe {
        width: 100%;
        height: 100%;
        border: none;
    }

    #gallery-modal .gallery-container img {
        max-width: 100%;
        max-height: 100%;
        display: none;
        object-fit: contain;
    }

    #gallery-modal .gallery-container img.active {
        display: block;
    }

    .gallery-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        font-size: 36px;
        color: rgba(0,0,0,0.7);
        background: rgba(255,255,255,0.7);
        border: none;
        cursor: pointer;
        padding: 10px;
        border-radius: 50%;
        user-select: none;
    }

    #prev-btn {
        left: 10px;
    }

    #next-btn {
        right: 10px;
    }

    .gallery-nav:hover {
        color: rgba(0,0,0,0.9);
        background: rgba(255,255,255,1);
    }

    #pet-iframe, #candy-iframe {
        width: 100%;
        height: 100%;
        border: none;
    }

    /* Media queries para dispositivos móviles */
    @media (max-width: 1024px) {
        .pet-status-container {
            gap: 30px;
        }

        .pet-status-container div {
            width: 96px;
            height: 96px;
        }
    }

    @media (max-width: 768px) {
        .pet-status-container {
            flex-wrap: wrap;
            gap: 20px;
        }

        .pet-status-container div {
            width: 84px;
            height: 84px;
        }

        #gallery-modal, #pet-popup, #candy-popup {
            width: 90%;
            height: 90%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
    }

    /* Ajustes para dispositivos móviles - Ventana emergente del juego Candy */
    @media (max-width: 768px) {
        #candy-popup {
            width: 100%;
            height: 80%; /* Ajusta este valor según prefieras */
            top: 10%;    /* Centra verticalmente */
            left: 0;
            transform: none;
            border-radius: 0;
            box-shadow: none;
        }

        #candy-popup #close-candy-popup {
            top: 10px;
            right: 10px;
            font-size: 30px;
        }
    }

    /* Clase para evitar el scroll en el fondo cuando el popup está abierto */
    body.no-scroll {
        overflow: hidden;
        position: fixed;
        width: 100%;
    }

    /* Estilos específicos para el nuevo ranking */
    @import url('https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@700&display=swap'); /* Fuente especial para los números */

    .ranking-container {
        display: flex;
        align-items: flex-end;
        width: auto;
        position: relative;
        justify-content: center;
        margin: 20px auto;
    }

    .dog-image {
        width: 40%;
        max-width: 200px;
        height: auto;
        margin-right: -90px;
        align-self: flex-end;
    }

    .ranking-content {
        width: 25%;
        max-width: 160px;
        text-align: center;
        color: #333;
        background: linear-gradient(145deg, #f8e7d1, #e6c8a8);
        padding: 10px 10px 15px;
        border-radius: 8px;
        border: 2px solid #8B4513;
        box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2), inset 0 4px 6px rgba(255, 255, 255, 0.3);
        position: relative;
        overflow: hidden;
    }

    .ranking-content::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: radial-gradient(circle, rgba(255, 255, 255, 0.2) 1px, transparent 1px);
        background-size: 5px 5px;
        opacity: 0.3;
        pointer-events: none;
    }

    .ranking-list {
        list-style-type: none;
        padding: 0;
        margin: 0;
        font-size: 0.9em;
        font-weight: bold;
    }

    .ranking-list li {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 6px 0;
        border-bottom: 1px dashed #8B4513;
    }

    .ranking-number {
        font-family: 'Roboto Slab', serif;
        font-size: 1.2em;
        color: #D2691E;
        margin-right: 8px;
    }

    .first-place .ranking-number {
        color: #FF4500;
    }

    .second-place .ranking-number {
        color: #1E90FF;
    }

    .third-place .ranking-number {
        color: #32CD32;
    }

    .points {
        font-weight: normal;
        color: #8B4513;
        font-size: 0.8em;
        opacity: 0.9;
    }

    .right-image {
        width: 40%;
        max-width: 200px;
        height: auto;
        margin-left: -30px;
        margin-top: -10px;
        align-self: flex-start;
    }

    @media (max-width: 600px) {
        .ranking-container {
            flex-direction: row;
            width: 90vw;
        }
        .dog-image, .right-image {
            width: 50%;
        }
        .ranking-list {
            font-size: 2.5vw;
        }
    }

</style>
</head>
<body>
    <header>
        <img src="cabecera.jpg" alt="Tablón de anuncios anónimos" id="header-image">
        <div id="slogan"></div>
        <div class="teletipo-wrapper">
            <span class="rumores-label">RUMORES</span>
            <div id="teletipo-container"></div>
        </div>
    </header>

    <div class="pet-status-container">
        <div id="pet-emoji" class="pet-emoji" title="Ver mascota virtual">
            <img src="pet-icon.png" alt="Mascota Virtual">
        </div>

        <div id="gallery-link" class="gallery-link" title="Ver Galería">
            <img src="gallery-icon.png" alt="Galería de Imágenes">
        </div>

        <div id="candy-game-link" class="candy-game-link" title="Jugar Candy">
            <img src="Candy.png" alt="Candy Game">
        </div>
    </div>

    <!-- Aquí reemplazamos el ranking existente con el nuevo diseño y funcionalidades -->
    <div class="ranking-container">
        <img src="rankingdog.png" alt="Moncho junto al ranking" class="dog-image">
        <div class="ranking-content">
            <ul class="ranking-list" id="ranking-list">
                <!-- Los puntajes se cargarán aquí dinámicamente -->
            </ul>
        </div>
        <img src="monchy.png" alt="Monchy a la derecha del ranking" class="right-image">
    </div>

    <div class="main-container">
        <div class="left-column">
            <form id="message-form">
                <textarea id="message-input" placeholder="Escribe tu mensaje aquí..."></textarea>
                <button type="submit">Publicar</button>
            </form>
            
            <div id="bulletin-board"></div>
            <div id="loading">Cargando más mensajes...</div>
            
            <div class="statistics">
                <div id="days-operating">Días en funcionamiento: 1</div>
                <div id="messages-published">Mensajes publicados: 0</div>
                <div id="messages-deleted">Mensajes borrados: 0</div>
            </div>
        </div>
    </div>

    <div id="gallery-modal">
        <button class="close-gallery" id="close-gallery">&times;</button>
        <div class="gallery-container" id="gallery-container"></div>
        <button class="gallery-nav" id="prev-btn">&#10094;</button>
        <button class="gallery-nav" id="next-btn">&#10095;</button>
    </div>

    <div id="pet-popup">
        <button id="close-popup">&times;</button>
        <iframe id="pet-iframe" src="about:blank" frameborder="0"></iframe>
    </div>

    <div id="candy-popup">
        <button id="close-candy-popup">&times;</button>
        <iframe id="candy-iframe" src="about:blank" frameborder="0"></iframe>
    </div>

    <script>
        // Configuración de Firebase
const firebaseConfig = {
    apiKey: "AIzaSyBlIRJVI1buU48SPp0ErpCXhnuBdBEp8rk",
    authDomain: "tablon-de-anuncios-d5dea.firebaseapp.com",
    projectId: "tablon-de-anuncios-d5dea",
    storageBucket: "tablon-de-anuncios-d5dea.appspot.com",
    messagingSenderId: "67910184237",
    appId: "1:67910184237:web:e43d424657a948ae5d77a4",
    measurementId: "G-YL5W1VNM9Z"
};
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Variables existentes
        const bulletinBoard = document.getElementById('bulletin-board');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const messagesPublished = document.getElementById('messages-published');
        const messagesDeleted = document.getElementById('messages-deleted');
        const daysOperating = document.getElementById('days-operating');
        const slogan = document.getElementById('slogan');
        const petEmoji = document.getElementById('pet-emoji');
        const petPopup = document.getElementById('pet-popup');
        const closePopup = document.getElementById('close-popup');
        const loadingElement = document.getElementById('loading');

        // Variables para el ranking
        const rankingList = document.getElementById('ranking-list');

        const animalEmojis = ['🐶', '🐱', '🐭', '🐹', '🐰', '🦊', '🐻', '🐼', '🐨', '🐯', '🦁', '🐮', '🐷', '🐸', '🐵', '🐔', '🐧', '🐦', '🦆', '🦅', '🦉', '🦇', '🐺', '🐗', '🐴', '🦄', '🐝', '🐛', '🦋', '🐌', '🐞', '🐜', '🦟', '🦗', '🕷', '🦂', '🦀', '🐍', '🦎', '🦖', '🦕', '🐙', '🦑', '🦐', '🦞', '🐳', '🐬', '🐟', '🐠', '🐡', '🦈', '🐊', '🐅', '🐆', '🦓', '🦍', '🦧', '🐘', '🦛', '🦏', '🐪', '🐫', '🦒', '🦘', '🐃', '🐂', '🐄', '🐎', '🐖', '🐏', '🐑', '🦙', '🐐', '🦌', '🐕', '🐩', '🦮', '🐕‍🦺', '🐈', '🐓', '🦃', '🦚', '🦜', '🦢', '🦩', '🕊', '🐇', '🦝', '🦨', '🦡', '🦦', '🦥', '🐁', '🐀', '🐿', '🦔'];
        const slogans = [
            "Ahora más anónimo",
            "Lo nunca visto",
            "Publica sin miedo",
            "Cuidado, no se pueden borrar",
            "Tu voz, tu espacio",
            "Comparte libremente",
            "Ideas sin límites",
            "El muro digital",
            "Exprésate sin barreras",
            "Tu mensaje importa",
            "Anunciado en TV",
            "Donde hasta Moncho opina",
            "¡Cuéntalo, que nadie se entera!",
            "El rincón de las ocurrencias familiares",
            "Secretos de familia: ahora públicos",
            "Anónimo... pero sabemos que es cosa de Samuel",
            "Donde mamá pide caviar",
            "¡Aquí se venden gatos pesados!",
            "El tablón de los valientes",
            "El diario secreto de la familia (versión pública)",
            "La página de la gente que no se peina",
            "Escribe lo que quieras, que no hay consecuencias"
        ];
        const imageFolder = './';
        const totalImages = 48;

        let lastVisibleMessage = null;
        const messagesPerPage = 10;
        let isLoading = false;
        let displayedMessageIds = new Set();
        let petPopupOpen = false;

        function loadMessages(startAfter = null) {
            if (isLoading) return;
            isLoading = true;
            loadingElement.style.display = 'block';

            let query = db.collection("messages").orderBy("timestamp", "desc").limit(messagesPerPage);

            if (startAfter) {
                query = query.startAfter(startAfter);
            }

            query.get().then((snapshot) => {
                if (snapshot.empty) {
                    loadingElement.style.display = 'none';
                    isLoading = false;
                    return;
                }

                snapshot.forEach((doc) => {
                    const message = { ...doc.data(), id: doc.id };
                    if (!displayedMessageIds.has(message.id)) {
                        const messageElement = createMessageElement(message);
                        bulletinBoard.appendChild(messageElement);
                        displayedMessageIds.add(message.id);
                    }
                });

                lastVisibleMessage = snapshot.docs[snapshot.docs.length - 1];
                updateMessagesPublished();
                loadingElement.style.display = 'none';
                isLoading = false;
            }).catch((error) => {
                console.error("Error loading messages: ", error);
                loadingElement.style.display = 'none';
                isLoading = false;
            });
        }

        function createMessageElement(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.id = `message-${message.id}`;
            messageDiv.dataset.id = message.id;

            const bgColor = message.bgColor || getRandomContrastColor();
            messageDiv.style.backgroundColor = bgColor;

            const textColor = getContrastingTextColor(bgColor);
            messageDiv.style.color = textColor;

            if (message.replyTo) {
                const quotedMessage = createQuotedMessage(message.replyTo);
                messageDiv.appendChild(quotedMessage);
            }

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            const emoji = document.createElement('div');
            emoji.className = 'message-emoji';
            emoji.textContent = message.emoji;

            const textDiv = document.createElement('div');
            textDiv.className = 'message-text';
            textDiv.textContent = message.text;

            contentDiv.appendChild(emoji);
            contentDiv.appendChild(textDiv);

            const timestamp = document.createElement('div');
            timestamp.className = 'message-timestamp';
            if (message.timestamp) {
                timestamp.textContent = new Date(message.timestamp.toDate()).toLocaleString();
            } else {
                timestamp.textContent = 'Fecha desconocida';
            }

            const actions = document.createElement('div');
            actions.className = 'message-actions';

            const likeBtn = document.createElement('button');
            likeBtn.className = 'like-btn';
            likeBtn.textContent = `👍 ${message.likes || 0}`;
            likeBtn.onclick = () => updateLikes(message.id, 'likes');

            const dislikeBtn = document.createElement('button');
            dislikeBtn.className = 'dislike-btn';
            dislikeBtn.textContent = `👎 ${message.dislikes || 0}`;
            dislikeBtn.onclick = () => updateLikes(message.id, 'dislikes');

            const replyBtn = document.createElement('button');
            replyBtn.className = 'reply-btn';
            replyBtn.textContent = '↩️';
            replyBtn.onclick = () => showReplyForm(message.id, message);

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.textContent = '🗑️';
            deleteBtn.onclick = () => showDeleteConfirmation(message.id);

            actions.appendChild(likeBtn);
            actions.appendChild(dislikeBtn);
            actions.appendChild(replyBtn);
            actions.appendChild(deleteBtn);

            messageDiv.appendChild(contentDiv);
            messageDiv.appendChild(timestamp);
            messageDiv.appendChild(actions);

            return messageDiv;
        }

        function createQuotedMessage(originalMessage) {
            const quotedDiv = document.createElement('div');
            quotedDiv.className = 'quoted-message';
            quotedDiv.style.backgroundColor = originalMessage.bgColor;
            quotedDiv.style.color = getContrastingTextColor(originalMessage.bgColor);
            quotedDiv.textContent = `${originalMessage.emoji} ${originalMessage.text}`;
            quotedDiv.onclick = () => scrollToMessage(originalMessage.id);
            return quotedDiv;
        }

        function scrollToMessage(messageId) {
            const targetMessage = document.getElementById(`message-${messageId}`);
            if (targetMessage) {
                targetMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
                targetMessage.style.animation = 'highlight 2s';
            }
        }

        function showReplyForm(parentId, parentMessage) {
            const parentMessageElement = document.querySelector(`[data-id="${parentId}"]`);
            let replyForm = parentMessageElement.querySelector('.reply-form');

            if (replyForm) {
                parentMessageElement.removeChild(replyForm);
                return;
            }

            replyForm = document.createElement('form');
            replyForm.className = 'reply-form';
            replyForm.innerHTML = `
                <textarea placeholder="Escribe tu respuesta..."></textarea>
                <button type="submit">Responder</button>
            `;
            replyForm.onsubmit = (e) => {
                e.preventDefault();
                const replyText = e.target.querySelector('textarea').value;
                if (replyText.trim()) {
                    addReply(parentId, replyText, parentMessage);
                }
                parentMessageElement.removeChild(replyForm);
            };
            parentMessageElement.appendChild(replyForm);
        }

        function addReply(parentId, replyText, parentMessage) {
            const reply = {
                text: replyText,
                emoji: getRandomAnimalEmoji(),
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                replyTo: {
                    id: parentId,
                    text: parentMessage.text,
                    emoji: parentMessage.emoji,
                    bgColor: parentMessage.bgColor
                },
                bgColor: getRandomContrastColor(),
                likes: 0,
                dislikes: 0
            };

            db.collection("messages").add(reply)
                .then(() => {
                    console.log("Respuesta añadida con éxito");
                })
                .catch((error) => {
                    console.error("Error al añadir la respuesta: ", error);
                    alert("Error al publicar la respuesta. Por favor, inténtalo de nuevo.");
                });
        }

        function updateLikes(id, field) {
            db.collection("messages").doc(id).update({
                [field]: firebase.firestore.FieldValue.increment(1)
            }).then(() => {
                db.collection("messages").doc(id).get().then((doc) => {
                    if (doc.exists) {
                        const message = doc.data();
                        const messageElement = document.querySelector(`[data-id="${id}"]`);
                        const likeBtn = messageElement.querySelector('.like-btn');
                        const dislikeBtn = messageElement.querySelector('.dislike-btn');
                        likeBtn.textContent = `👍 ${message.likes || 0}`;
                        dislikeBtn.textContent = `👎 ${message.dislikes || 0}`;
                    }
                });
            }).catch((error) => {
                console.error("Error updating likes: ", error);
            });
        }

        function showDeleteConfirmation(id) {
            const messageElement = document.querySelector(`[data-id="${id}"]`);
            const actions = messageElement.querySelector('.message-actions');
            const deleteConfirmation = document.createElement('div');
            deleteConfirmation.className = 'delete-confirmation';
            deleteConfirmation.innerHTML = `
                <button class="confirm-delete">✅</button>
                <button class="cancel-delete">❌</button>
            `;
            actions.appendChild(deleteConfirmation);

            const confirmDelete = deleteConfirmation.querySelector('.confirm-delete');
            const cancelDelete = deleteConfirmation.querySelector('.cancel-delete');

            confirmDelete.onclick = () => deleteMessage(id);
            cancelDelete.onclick = () => actions.removeChild(deleteConfirmation);
        }

        function deleteMessage(id) {
            db.collection("messages").doc(id).delete().then(() => {
                incrementMessagesDeleted();
                const messageElement = document.querySelector(`[data-id="${id}"]`);
                if (messageElement) {
                    bulletinBoard.removeChild(messageElement);
                    displayedMessageIds.delete(id);
                }
            }).catch((error) => {
                console.error("Error removing message: ", error);
            });
        }

        messageForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (text) {
                const message = {
                    text: text,
                    emoji: getRandomAnimalEmoji(),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    bgColor: getRandomContrastColor(),
                    likes: 0,
                    dislikes: 0
                };
                db.collection("messages").add(message).then(() => {
                    messageInput.value = '';
                });
            }
        });

        function getRandomAnimalEmoji() {
            return animalEmojis[Math.floor(Math.random() * animalEmojis.length)];
        }

        function getRandomContrastColor() {
            const hue = Math.floor(Math.random() * 360);
            const saturation = 70 + Math.random() * 30;
            const lightness = 65 + Math.random() * 25;
            return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
        }

        function getContrastingTextColor(bgColor) {
            const hsl = bgColor.match(/hsl(\d+),\s*(\d+)%?,\s*(\d+)%?/);
            if (hsl) {
                const l = parseInt(hsl[3]);
                return l > 50 ? '#000000' : '#FFFFFF';
            } else {
                return '#000000';
            }
        }

        function updateMessagesPublished() {
            db.collection("messages").get().then((snapshot) => {
                messagesPublished.textContent = `Mensajes publicados: ${snapshot.size}`;
            });
        }

        function updateMessagesDeleted() {
            db.collection("statistics").doc("counters").get().then((doc) => {
                if (doc.exists) {
                    const deletedCount = doc.data().messagesDeleted || 0;
                    messagesDeleted.textContent = `Mensajes borrados: ${deletedCount}`;
                }
            });
        }

        function incrementMessagesDeleted() {
            db.collection("statistics").doc("counters").update({
                messagesDeleted: firebase.firestore.FieldValue.increment(1)
            }).then(() => {
                updateMessagesDeleted();
            });
        }

        function changeSlogan() {
            slogan.textContent = slogans[Math.floor(Math.random() * slogans.length)];
        }

        function cargarTeletipo() {
            fetch('teletipo.html')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(data => {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = data;

                    const styleTag = tempDiv.querySelector('style');
                    if (styleTag) {
                        document.head.appendChild(styleTag);
                    }

                    const teletipoContainer = tempDiv.querySelector('.teletipo-container');
                    if (teletipoContainer) {
                        document.getElementById('teletipo-container').appendChild(teletipoContainer);
                    }

                    const scriptTag = tempDiv.querySelector('script');
                    if (scriptTag) {
                        const newScript = document.createElement('script');
                        newScript.textContent = scriptTag.textContent;
                        document.body.appendChild(newScript);
                    }

                    if (typeof window.inicializarTeletipo === 'function') {
                        window.inicializarTeletipo();
                    } else {
                        console.error('La función inicializarTeletipo no está disponible');
                    }
                })
                .catch(error => {
                    console.error('Error al cargar el teletipo:', error);
                    document.getElementById('teletipo-container').textContent = 'Error al cargar el teletipo';
                });
        }

        closePopup.addEventListener('click', () => {
            petPopup.style.display = 'none';
            document.getElementById('pet-iframe').src = 'about:blank';
            petPopupOpen = false;
        });

        function adjustPetPopupSize() {
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            const popupWidth = windowWidth * 0.95;
            const popupHeight = windowHeight * 0.95;
            petPopup.style.width = `${popupWidth}px`;
            petPopup.style.height = `${popupHeight}px`;
        }

        window.addEventListener('resize', adjustPetPopupSize);

        window.addEventListener('scroll', () => {
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500 && !isLoading) {
                loadMessages(lastVisibleMessage);
            }
        });

        function initApp() {
            loadMessages();
            changeSlogan();
            updateMessagesDeleted();
            cargarTeletipo();
            adjustPetPopupSize();
            const startDate = new Date('2023-06-08');
            const today = new Date();
            const daysOperatingCount = Math.floor((today - startDate) / (1000 * 60 * 60 * 24)) + 1;
            daysOperating.textContent = `Días en funcionamiento: ${daysOperatingCount}`;
            setInterval(changeSlogan, 10000);
            loadRanking(); // Cargar el ranking al iniciar la aplicación
        }

        function listenForNewMessages() {
            db.collection("messages")
                .orderBy("timestamp", "desc")
                .limit(1)
                .onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === "added") {
                            const newMessage = { ...change.doc.data(), id: change.doc.id };
                            if (!displayedMessageIds.has(newMessage.id)) {
                                const messageElement = createMessageElement(newMessage);
                                bulletinBoard.insertBefore(messageElement, bulletinBoard.firstChild);
                                displayedMessageIds.add(newMessage.id);
                                updateMessagesPublished();
                            }
                        }
                    });
                });
        }

        // Función para cargar el ranking desde Firebase
        async function loadRanking() {
            const highScoresCollection = db.collection('highscores');
            const snapshot = await highScoresCollection
                .orderBy('score', 'desc')
                .limit(3)
                .get();

            rankingList.innerHTML = '';

            snapshot.docs.forEach((doc, index) => {
                const data = doc.data();
                const positionClass = ['first-place', 'second-place', 'third-place'][index] || '';
                const listItem = document.createElement('li');
                listItem.className = positionClass;
                listItem.innerHTML = `
                    <span class="ranking-number">${index + 1}</span> ${data.initials} <span class="points">${data.score}</span>
                `;
                rankingList.appendChild(listItem);
            });
        }

        // Código relacionado con la galería, mascota virtual y juego Candy

        // Código para la galería
        const galleryLink = document.getElementById('gallery-link');
        const galleryModal = document.getElementById('gallery-modal');
        const closeGalleryBtn = document.getElementById('close-gallery');
        const galleryContainer = document.getElementById('gallery-container');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        let currentImageIndex = 0;

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function loadGalleryImages() {
            const indices = Array.from({ length: totalImages }, (_, i) => i + 1);
            const shuffledIndices = shuffleArray(indices);

            shuffledIndices.forEach((i, index) => {
                const imgNumber = String(i).padStart(4, '0');
                const imgPath = `${imageFolder}${imgNumber}.jpg`;
                const imgElement = document.createElement('img');
                imgElement.src = imgPath;
                imgElement.alt = `Imagen ${imgNumber}`;
                if (index === 0) {
                    imgElement.classList.add('active');
                }
                galleryContainer.appendChild(imgElement);
            });
        }

        function showImage(index) {
            const images = galleryContainer.querySelectorAll('img');
            images.forEach((img, i) => {
                img.classList.toggle('active', i === index);
            });
        }

        function nextImage() {
            const images = galleryContainer.querySelectorAll('img');
            currentImageIndex = (currentImageIndex + 1) % images.length;
            showImage(currentImageIndex);
        }

        function prevImage() {
            const images = galleryContainer.querySelectorAll('img');
            currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
            showImage(currentImageIndex);
        }

        galleryLink.addEventListener('click', (e) => {
            e.preventDefault();
            galleryModal.style.display = 'flex';
            if (galleryContainer.children.length === 0) {
                loadGalleryImages();
            }
        });

        closeGalleryBtn.addEventListener('click', () => {
            galleryModal.style.display = 'none';
        });

        nextBtn.addEventListener('click', nextImage);
        prevBtn.addEventListener('click', prevImage);

        window.addEventListener('click', (e) => {
            if (e.target === galleryModal) {
                galleryModal.style.display = 'none';
            }
        });

        let touchStartX = 0;
        let touchEndX = 0;

        galleryContainer.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
        }, false);

        galleryContainer.addEventListener('touchend', (e) => {
            touchEndX = e.changedTouches[0].screenX;
            handleGesture();
        }, false);

        function handleGesture() {
            if (touchEndX < touchStartX - 50) {
                nextImage();
            }
            if (touchEndX > touchStartX + 50) {
                prevImage();
            }
        }

        function getRandomGalleryImage() {
            const randomIndex = Math.floor(Math.random() * totalImages) + 1;
            const imgNumber = String(randomIndex).padStart(4, '0');
            return `${imageFolder}${imgNumber}.jpg`;
        }

        function setRandomGalleryImage() {
            const galleryLinkImg = document.querySelector('#gallery-link img');
            galleryLinkImg.src = getRandomGalleryImage();
        }

        // Código para la mascota virtual
        petEmoji.addEventListener('click', (e) => {
            if (!petPopupOpen) {
                e.preventDefault();
                petPopup.style.display = 'block';
                document.getElementById('pet-iframe').src = 'pet.html';
                petPopupOpen = true;
            }
        });

        // Código para el juego Candy
        const candyGameLink = document.getElementById('candy-game-link');
        const candyPopup = document.getElementById('candy-popup');
        const closeCandyPopup = document.getElementById('close-candy-popup');
        let candyPopupOpen = false;

        candyGameLink.addEventListener('click', (e) => {
            if (!candyPopupOpen) {
                e.preventDefault();
                candyPopup.style.display = 'block';
                document.getElementById('candy-iframe').src = 'candy.html';
                candyPopupOpen = true;
                document.body.style.overflow = 'hidden';
            }
        });

        closeCandyPopup.addEventListener('click', () => {
            candyPopup.style.display = 'none';
            document.getElementById('candy-iframe').src = 'about:blank';
            candyPopupOpen = false;
            document.body.style.overflow = '';
        });

        function adjustCandyPopupSize() {
            // No es necesario ajustar el tamaño aquí ya que usamos vmin para mantener el cuadrado
        }

        window.addEventListener('resize', adjustCandyPopupSize);

        // Inicialización de la aplicación
        window.addEventListener('load', () => {
            initApp();
            listenForNewMessages();
            setRandomGalleryImage();
            adjustPetPopupSize();
        });
    </script>
</body>
</html>